<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mentor Attendance Sheet</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Custom styles for animations and specific overrides */
        body {
            font-family: 'Inter', sans-serif;
            /* Gradient background for the entire page */
            background: linear-gradient(to bottom right, #e0f2fe, #d1c4e9); /* Light blue to light purple */
            min-height: 100vh; /* Ensure gradient covers full height */
        }
        .container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            /* Changed to solid white background for clarity in PDF and on screen */
            background-color: white; 
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            animation: fadeIn 0.8s ease-out; /* Fade-in animation for the container */
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .dashboard-btn, .action-btn {
            transition: all 0.3s ease; /* Smooth transition for all properties */
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1); /* Subtle shadow */
        }
        .dashboard-btn:hover, .action-btn:hover {
            transform: translateY(-2px); /* Slight lift on hover */
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.2); /* Enhanced shadow on hover */
        }
        /* Table specific styles for better readability and appearance */
        table {
            border-collapse: separate; /* Use separate for rounded corners on cells */
            border-spacing: 0; /* Remove space between cells */
            overflow: hidden; /* Ensures rounded corners are applied correctly */
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08); /* Table shadow */
            animation: slideInUp 0.7s ease-out forwards; /* Slide-in animation for table */
            opacity: 0; /* Start hidden for animation */
            transform: translateY(20px); /* Start slightly below for animation */
        }
        @keyframes slideInUp {
            to { opacity: 1; transform: translateY(0); }
        }
        th, td {
            border: 1px solid #e2e8f0; /* Light border color */
            padding: 12px 8px; /* More padding for better spacing */
            text-align: center;
            vertical-align: middle; /* Center content vertically */
        }
        th {
            background-color: #edf2f7; /* Lighter header background */
            font-weight: 600; /* Semi-bold header text */
            color: #2d3748; /* Darker text color */
            position: sticky; /* Sticky header */
            top: 0;
            z-index: 10;
        }
        tr:nth-child(even) {
            background-color: #f7fafc; /* Zebra striping for rows */
        }
        tr:hover {
            background-color: #e2e8f0; /* Highlight row on hover */
            transition: background-color 0.2s ease;
        }
        /* Specific status colors */
        .present { color: #10b981; font-weight: bold; } /* Green */
        .absent { color: #ef4444; font-weight: bold; } /* Red */
        .late { color: #f59e0b; font-weight: bold; } /* Orange */

        /* Responsive adjustments for table */
        @media (max-width: 768px) {
            table, thead, tbody, th, td, tr {
                display: block;
            }
            thead tr {
                position: absolute;
                top: -9999px;
                left: -9999px;
            }
            tr {
                border: 1px solid #ccc;
                margin-bottom: 10px;
                border-radius: 8px;
                overflow: hidden;
            }
            td {
                border: none;
                border-bottom: 1px solid #eee;
                position: relative;
                padding-left: 50%;
                text-align: right;
            }
            td:before {
                position: absolute;
                top: 6px;
                left: 6px;
                width: 45%;
                padding-right: 10px;
                white-space: nowrap;
                text-align: left;
                font-weight: bold;
            }
            /* Data labels for responsive table */
            td:nth-of-type(1):before { content: "Mentor Name"; }
            td:nth-of-type(2):before { content: "Mentor ID"; }
            /* Dynamic content for daily columns will be harder to label this way */
            /* For daily columns, the header is already in the cell */
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</head>
<body class="p-4">

    <div id="printArea" class="container">
        <div class="flex items-center justify-between mb-6">
            <button class="dashboard-btn bg-blue-600 text-white px-5 py-2 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd" />
                </svg>
                Dashboard
            </button>
            <h2 class="text-3xl font-bold text-gray-800 text-center flex-grow">Mentor Attendance Report</h2>
            <div></div> </div>

        <div class="flex flex-wrap items-center justify-center md:justify-end gap-4 mb-8">
            <label class="text-lg font-medium text-gray-700 flex items-center gap-2">
                Select Month:
                <input type="month" id="monthPicker" class="p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-400 focus:border-transparent transition duration-200" />
            </label>
            <button id="loadButton" class="action-btn bg-green-600 text-white px-5 py-2 rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-50 flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M5.293 9.707a1 1 0 010-1.414l3-3a1 1 0 111.414 1.414L7.414 8H15a1 1 0 110 2H7.414l2.293 2.293a1 1 0 01-1.414 1.414l-3-3z" clip-rule="evenodd" />
                </svg>
                Load
            </button>
            <button id="downloadPdfButton" class="action-btn bg-purple-600 text-white px-5 py-2 rounded-lg hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-opacity-50 flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                </svg>
                Download PDF
            </button>
        </div>

        <div id="attendanceContainer" class="overflow-x-auto relative shadow-md sm:rounded-lg">
            <p class="text-center text-gray-500 py-10">Select a month and click 'Load' to view attendance data.</p>
        </div>
    </div>

    <script>
        // Replace with your actual Apps Script URL
        const sheetAPI = 'https://script.google.com/macros/s/AKfycbwUmtCb0jaE4Jq5DZ01wj0_ag5EbG8S3xPhslvjjyGf02Nujd0yNNfb9oX5rR1Po-6sEA/exec'; 

        // Get references to buttons
        const dashboardBtn = document.querySelector('.dashboard-btn');
        const loadButton = document.getElementById('loadButton');
        const downloadPdfButton = document.getElementById('downloadPdfButton');

        // Event Listeners
        dashboardBtn.addEventListener('click', () => {
            // In a real application, this would navigate to a dashboard page.
            // For this single-page example, we'll just show a message.
            alert('Navigating to Dashboard (functionality not implemented in this snippet)');
            // window.location.href = 'dashboard.html'; // Uncomment for actual navigation
        });
        loadButton.addEventListener('click', loadMentorData);
        downloadPdfButton.addEventListener('click', downloadPDF);

        /**
         * Returns a display symbol and class for attendance status.
         * @param {string} status - The attendance status (Present, Absent, Late).
         * @returns {object} An object containing the symbol and CSS class.
         */
        function getStatusDisplay(status) {
            if (!status) return { symbol: '-', class: '' };
            switch (status.toLowerCase()) {
                case 'present': return { symbol: '✔️', class: 'present' };
                case 'absent': return { symbol: '❌', class: 'absent' };
                case 'late': return { symbol: '⏰', class: 'late' };
                default: return { symbol: status, class: '' };
            }
        }

        /**
         * Loads mentor attendance data from the Google Sheet API,
         * filters by month, and displays it in a table.
         * Uses durations as minutes for daily display and converts total to hours.
         */
        async function loadMentorData() {
            const monthInput = document.getElementById('monthPicker').value;
            if (!monthInput) {
                alert('Please select a month');
                return;
            }

            const [year, month] = monthInput.split('-').map(Number);
            const attendanceContainer = document.getElementById('attendanceContainer');
            attendanceContainer.innerHTML = '<p class="text-center text-gray-500 py-10">Loading data...</p>'; // Loading indicator

            try {
                const res = await fetch(sheetAPI);
                if (!res.ok) {
                    throw new Error(`HTTP error! status: ${res.status}`);
                }
                const data = await res.json();

                // Filter data for the selected month
                const filtered = data.filter(row => {
                    const d = new Date(row.Date);
                    return d.getFullYear() === year && d.getMonth() === month - 1;
                });

                const mentors = {};

                // Process filtered data to aggregate by mentor and day
                filtered.forEach(row => {
                    const id = row.MentorID;
                    if (!mentors[id]) {
                        mentors[id] = {
                            name: row.MentorName,
                            days: {},
                            totalMinutes: 0 // Initialize total minutes
                        };
                    }

                    const day = new Date(row.Date).getDate();
                    // Duration is already in minutes, no conversion needed here.
                    const durationInMinutes = parseFloat(row.Duration) || 0; 

                    mentors[id].days[day] = {
                        status: row.Status,
                        duration: durationInMinutes // Store duration in minutes
                    };
                    mentors[id].totalMinutes += durationInMinutes; // Accumulate total minutes
                });

                const daysInMonth = new Date(year, month, 0).getDate();
                let html = `
                    <table class="min-w-full divide-y divide-gray-200 rounded-lg">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider rounded-tl-lg">Mentor Name</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Mentor ID</th>
                `;

                // Generate daily headers
                for (let d = 1; d <= daysInMonth; d++) {
                    html += `<th scope="col" class="px-2 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider">${d}<br>Mins</th>`;
                }
                html += `<th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider rounded-tr-lg">Total Hrs</th></tr></thead><tbody class="bg-white divide-y divide-gray-200">`;

                // Populate table rows with mentor data
                if (Object.keys(mentors).length === 0) {
                    html += `<tr><td colspan="${daysInMonth + 3}" class="text-center py-4 text-gray-500">No attendance data found for the selected month.</td></tr>`;
                } else {
                    for (const [id, info] of Object.entries(mentors)) {
                        html += `<tr><td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${info.name}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${id}</td>`;
                        for (let d = 1; d <= daysInMonth; d++) {
                            const dayData = info.days[d];
                            if (dayData) {
                                const statusDisplay = getStatusDisplay(dayData.status);
                                html += `<td class="px-2 py-4 whitespace-nowrap text-sm ${statusDisplay.class}">${statusDisplay.symbol}<br>${dayData.duration}</td>`;
                            } else {
                                html += `<td class="px-2 py-4 whitespace-nowrap text-sm text-gray-400">-</td>`;
                            }
                        }
                        // Convert total minutes to hours for display
                        const totalHoursDisplay = (info.totalMinutes / 60).toFixed(2);
                        html += `<td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-800">${totalHoursDisplay}</td></tr>`;
                    }
                }

                html += '</tbody></table>';
                attendanceContainer.innerHTML = html;
            } catch (error) {
                console.error("Error fetching or processing data:", error);
                attendanceContainer.innerHTML = `<p class="text-center text-red-500 py-10">Failed to load data. Please try again later. Error: ${error.message}</p>`;
            }
        }

        /**
         * Downloads the attendance report as a PDF.
         */
        function downloadPDF() {
            const element = document.getElementById('printArea');
            const originalWidth = element.style.width;
            
            // Temporarily set a large width to ensure all table columns are captured
            element.style.width = '3500px'; 

            html2pdf().set({
                margin: 0.5, // Reduced margin for better fit
                filename: 'Mentor_Attendance_Report.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true },
                jsPDF: {
                    unit: 'px', // Use pixels for precise control over custom format
                    format: [3500, 2000], // Custom format: width 3500px, height 2000px
                    orientation: 'landscape'
                }
            }).from(element).save().then(() => {
                // Revert to original width after PDF generation
                element.style.width = originalWidth; 
            });
        }
    </script>
</body>
</html>
