<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Mentor Timetable Planner</title>
  <style>
    body {
      background-color: white;
      font-family: Arial, sans-serif;
    }

    header {
      background: linear-gradient(#f9d342, #e0b400);
      color: navy;
      padding: 20px;
      font-size: 24px;
      font-weight: bold;
      box-shadow: 0 5px 10px rgba(0,0,0,0.3);
      text-align: center;
      border-bottom: 4px solid navy;
    }

    .container {
      max-width: 1000px;
      margin: 30px auto;
      border: 2px solid navy;
      padding: 20px;
      border-radius: 12px;
    }

    label, select, input {
      display: block;
      margin: 10px 0;
    }

    table {
      width: 100%;
      margin-top: 20px;
      border-collapse: collapse;
    }

    th, td {
      padding: 10px;
      border: 1px solid navy;
      text-align: center;
    }

    button {
      background-color: navy;
      color: white;
      padding: 10px 20px;
      border: none;
      margin-top: 10px;
      border-radius: 5px;
      cursor: pointer;
    }

    .delete-btn {
      background-color: crimson;
    }

    .day-title {
      background-color: #f0f0f0;
      font-weight: bold;
      text-align: center;
    }
  </style>
</head>
<body>

  <header>Mentor Timetable Planner</header>

  <div class="container">
    <label>Week Start Date:
      <input type="date" id="weekStart">
    </label>

    <label>Select Student:
      <select id="studentSelect">
        <option value="">-- Select Student --</option>
      </select>
    </label>

    <div id="timetable"></div>

    <button onclick="submitTimetable()">Submit Timetable</button>
  </div>

  <script>
    const scriptURL = "https://script.google.com/macros/s/AKfycbxJ-IGsjzrqUlykZEgK_BtLtz4O7BCF8tv8_Hus1dOENrN_Wnr0NzTAT38KMGamy-XJlQ/exec";
    let studentData = {};

    document.addEventListener("DOMContentLoaded", () => {
      fetch(scriptURL)
        .then(res => res.json())
        .then(data => {
          studentData = data.students;
          const studentSelect = document.getElementById("studentSelect");

          Object.keys(studentData).forEach(id => {
            const option = document.createElement("option");
            option.value = id;
            option.textContent = `${studentData[id].name} (${id})`;
            studentSelect.appendChild(option);
          });
        });
    });

    document.getElementById("studentSelect").addEventListener("change", function() {
      const studentId = this.value;
      if (studentId) {
        createTimetableUI(studentId);
      }
    });

    function createTimetableUI(studentId) {
      const container = document.getElementById("timetable");
      container.innerHTML = "";

      const subjects = studentData[studentId].subjects;
      const days = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"];

      days.forEach(day => {
        const table = document.createElement("table");

        const titleRow = document.createElement("tr");
        const titleCell = document.createElement("td");
        titleCell.colSpan = 5;
        titleCell.className = "day-title";
        titleCell.textContent = day;
        titleRow.appendChild(titleCell);
        table.appendChild(titleRow);

        const header = document.createElement("tr");
        header.innerHTML = `
          <th>Time</th>
          <th>Subject</th>
          <th>Teacher</th>
          <th>Meeting Link</th>
          <th>Action</th>`;
        table.appendChild(header);

        const addRow = document.createElement("tr");
        addRow.innerHTML = `
          <td><input type="text" placeholder="10:00 AM - 10:45 AM" class="time-input"></td>
          <td>
            <select class="subject-select">
              ${subjects.map(sub => `<option value="${sub.subject}" data-teacher="${sub.teacher}">${sub.subject}</option>`).join("")}
            </select>
          </td>
          <td><input type="text" class="teacher-input" readonly></td>
          <td><input type="url" placeholder="https://..." class="link-input"></td>
          <td><button class="delete-btn" onclick="this.closest('tr').remove()">Delete</button></td>
        `;
        table.appendChild(addRow);

        addRow.querySelector(".subject-select").addEventListener("change", function() {
          const selectedOption = this.options[this.selectedIndex];
          addRow.querySelector(".teacher-input").value = selectedOption.dataset.teacher;
        });
        addRow.querySelector(".subject-select").dispatchEvent(new Event('change'));

        const addBtnRow = document.createElement("tr");
        const btnTd = document.createElement("td");
        btnTd.colSpan = 5;
        btnTd.innerHTML = `<button onclick="addRowToTable(this)">Add More</button>`;
        addBtnRow.appendChild(btnTd);
        table.appendChild(addBtnRow);

        container.appendChild(table);
      });
    }

    function addRowToTable(btn) {
      const table = btn.closest("table");
      const newRow = table.rows[2].cloneNode(true);
      newRow.querySelector(".time-input").value = "";
      newRow.querySelector(".link-input").value = "";

      newRow.querySelector(".subject-select").addEventListener("change", function() {
        const selectedOption = this.options[this.selectedIndex];
        newRow.querySelector(".teacher-input").value = selectedOption.dataset.teacher;
      });

      newRow.querySelector(".subject-select").dispatchEvent(new Event('change'));
      table.insertBefore(newRow, table.rows[table.rows.length - 1]);
    }

    function submitTimetable() {
      const weekStart = document.getElementById("weekStart").value;
      const studentId = document.getElementById("studentSelect").value;

      if (!weekStart || !studentId) {
        alert("Please select both week and student.");
        return;
      }

      const studentName = studentData[studentId].name;
      const entries = [];

      const tables = document.querySelectorAll("#timetable table");
      tables.forEach(table => {
        const day = table.querySelector(".day-title").textContent;
        const rows = table.querySelectorAll("tr");

        for (let i = 2; i < rows.length - 1; i++) {
          const time = rows[i].querySelector(".time-input").value;
          const subject = rows[i].querySelector(".subject-select").value;
          const teacher = rows[i].querySelector(".teacher-input").value;
          const link = rows[i].querySelector(".link-input").value;

          if (time && subject && teacher && link) {
            entries.push({ day, time, subject, teacher, link });
          }
        }
      });

      fetch(scriptURL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ weekStart, studentId, studentName, entries })
      })
      .then(res => res.json())
      .then(res => {
        if (res.success) {
          alert("Timetable submitted successfully!");
        } else {
          alert("Error submitting timetable.");
        }
      })
      .catch(() => alert("Submission failed. Please try again."));
    }
  </script>
</body>
</html>
