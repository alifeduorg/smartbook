<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Mentor Timetable Planner</title>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background-color: #fdfdfd;
      color: #333;
      margin: 0;
      padding: 0;
    }

    header {
      background-color: #1d3557;
      color: white;
      padding: 1rem;
      text-align: center;
    }

    h2 {
      color: #1d3557;
    }

    .container {
      max-width: 1200px;
      margin: auto;
      padding: 20px;
    }

    .card {
      background: white;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      padding: 20px;
      margin-bottom: 20px;
    }

    label {
      font-weight: bold;
    }

    select, input[type="text"], input[type="date"] {
      width: 100%;
      padding: 8px;
      margin: 8px 0 16px;
      border-radius: 5px;
      border: 1px solid #ccc;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 10px;
    }

    th, td {
      padding: 8px;
      border: 1px solid #ccc;
    }

    th {
      background-color: #f1c40f;
      color: #1d3557;
    }

    .btn {
      background-color: #f1c40f;
      color: #1d3557;
      padding: 10px 15px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
    }

    .btn:hover {
      background-color: #d4ac0d;
    }

    .day-table {
      margin-bottom: 30px;
    }
  </style>
</head>
<body>
  <header>
    <h1>Mentor Timetable Planner</h1>
  </header>
  <div class="container card">
    <label for="weekStart">Week Starting Date:</label>
    <input type="date" id="weekStart">

    <label for="studentSelect">Select Student:</label>
    <select id="studentSelect">
      <option value="">-- Select Student --</option>
    </select>
  </div>

  <div id="timetableContainer" class="container"></div>

  <div class="container">
    <button class="btn" onclick="submitTimetable()">Submit Timetable</button>
  </div>

  <script>
    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyBbpphH9wQ53Jo4evl8m4oNsaOXvombJVA",
      authDomain: "timetable-d0e77.firebaseapp.com",
      projectId: "timetable-d0e77",
      storageBucket: "timetable-d0e77.firebasestorage.app",
      messagingSenderId: "550695601869",
      appId: "1:550695601869:web:655c568a1290ae582bcb84",
      measurementId: "G-PCM44PV4CY"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let studentData = [];

    const weekdays = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"];

    // Fetch student-subject-teacher data
    fetch("https://script.google.com/macros/s/AKfycbxJ-IGsjzrqUlykZEgK_BtLtz4O7BCF8tv8_Hus1dOENrN_Wnr0NzTAT38KMGamy-XJlQ/exec")
      .then(res => res.json())
      .then(data => {
        studentData = data.data;
        populateStudents();
      });

    function populateStudents() {
      const studentSelect = document.getElementById("studentSelect");
      const studentIds = [...new Set(studentData.map(d => d["Student ID"]))];
      studentIds.forEach(id => {
        const name = studentData.find(d => d["Student ID"] === id)["Student Name"];
        const option = document.createElement("option");
        option.value = id;
        option.text = `${name} (${id})`;
        studentSelect.add(option);
      });
    }

    document.getElementById("studentSelect").addEventListener("change", renderTimetable);

    function renderTimetable() {
      const container = document.getElementById("timetableContainer");
      const studentId = document.getElementById("studentSelect").value;
      container.innerHTML = "";

      if (!studentId) return;

      const studentName = studentData.find(d => d["Student ID"] === studentId)["Student Name"];
      const subjects = [...new Set(studentData.filter(d => d["Student ID"] === studentId).map(d => d["Subject"]))];

      weekdays.forEach(day => {
        const dayDiv = document.createElement("div");
        dayDiv.className = "card day-table";
        const heading = document.createElement("h2");
        heading.textContent = day;
        dayDiv.appendChild(heading);

        const table = document.createElement("table");
        table.innerHTML = `
          <thead>
            <tr>
              <th>Time</th>
              <th>Subject</th>
              <th>Teacher</th>
              <th>Link</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="${day}-tbody"></tbody>
        `;
        dayDiv.appendChild(table);

        const addRowBtn = document.createElement("button");
        addRowBtn.textContent = "Add Row";
        addRowBtn.className = "btn";
        addRowBtn.onclick = () => addRow(day, subjects, studentId);
        dayDiv.appendChild(addRowBtn);

        container.appendChild(dayDiv);

        // Initial one row
        addRow(day, subjects, studentId);
      });
    }

    function addRow(day, subjects, studentId) {
      const tbody = document.getElementById(`${day}-tbody`);
      const tr = document.createElement("tr");

      tr.innerHTML = `
        <td><input type="text" placeholder="10:00 AM - 11:00 AM"></td>
        <td>
          <select onchange="updateTeacher(this, '${studentId}')">
            <option value="">Select</option>
            ${subjects.map(s => `<option value="${s}">${s}</option>`).join("")}
          </select>
        </td>
        <td><input type="text" readonly></td>
        <td><input type="text" placeholder="https://..."></td>
        <td><button class="btn" onclick="this.closest('tr').remove()">Remove</button></td>
      `;
      tbody.appendChild(tr);
    }

    function updateTeacher(selectEl, studentId) {
      const subject = selectEl.value;
      const teacherField = selectEl.parentElement.nextElementSibling.firstElementChild;
      const entry = studentData.find(d => d["Student ID"] === studentId && d["Subject"] === subject);
      teacherField.value = entry ? entry["Teacher Name"] : "";
    }

    function submitTimetable() {
      const weekStart = document.getElementById("weekStart").value;
      const studentId = document.getElementById("studentSelect").value;
      const studentName = studentData.find(d => d["Student ID"] === studentId)?.["Student Name"];

      if (!weekStart || !studentId) {
        alert("Please select week and student.");
        return;
      }

      const timetable = {
        weekStart,
        studentId,
        studentName,
        schedule: []
      };

      weekdays.forEach(day => {
        const rows = document.querySelectorAll(`#${day}-tbody tr`);
        rows.forEach(row => {
          const [timeEl, subjectEl, teacherEl, linkEl] = row.querySelectorAll("input, select");
          const time = timeEl.value.trim();
          const subject = subjectEl.value.trim();
          const teacher = teacherEl.value.trim();
          const link = linkEl.value.trim();

          if (time && subject && teacher && link) {
            timetable.schedule.push({ day, time, subject, teacher, link });
          }
        });
      });

      db.collection("Timetables").add(timetable)
        .then(() => {
          alert("Timetable submitted successfully!");
        })
        .catch(err => {
          alert("Error submitting timetable.");
          console.error(err);
        });
    }
  </script>
</body>
</html>
