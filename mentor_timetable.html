<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Timetable System</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: white;
      color: #333;
      margin: 0;
      padding: 0;
    }

    h1 {
      text-align: center;
      color: #FFD700; /* Golden Yellow */
      font-size: 36px;
      padding: 20px;
      background-color: #333;
      margin: 0;
      border-radius: 0 0 15px 15px;
    }

    .container {
      width: 80%;
      margin: 0 auto;
      padding: 20px;
    }

    select, input, button {
      padding: 10px;
      margin: 5px;
      border-radius: 5px;
      border: 1px solid #007BFF;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }

    th, td {
      padding: 12px;
      text-align: center;
      border: 1px solid #ccc;
    }

    .day-title {
      font-weight: bold;
      background-color: #007BFF;
      color: white;
      padding: 10px;
      text-align: center;
      font-size: 18px;
    }

    .time-input, .subject-select, .teacher-input, .link-input {
      width: 100%;
      padding: 8px;
    }

    .delete-btn {
      background-color: red;
      color: white;
      padding: 5px 10px;
      border: none;
      cursor: pointer;
    }

    .delete-btn:hover {
      background-color: darkred;
    }

    .add-more-btn {
      background-color: #007BFF;
      color: white;
      padding: 10px;
      border: none;
      cursor: pointer;
    }

    .add-more-btn:hover {
      background-color: darkblue;
    }

    .submit-btn {
      background-color: #FFD700; /* Golden Yellow */
      color: #333;
      padding: 10px 20px;
      font-size: 18px;
      border: none;
      cursor: pointer;
      width: 100%;
    }

    .submit-btn:hover {
      background-color: #FFCC00;
    }
  </style>
</head>
<body>

  <h1>Timetable System</h1>

  <div class="container">
    <label for="weekStart">Select Week Start Date:</label>
    <input type="date" id="weekStart">

    <label for="studentSelect">Select Student:</label>
    <select id="studentSelect">
      <option value="">Select a student</option>
    </select>

    <div id="timetable"></div>

    <button class="submit-btn" onclick="submitTimetable()">Submit Timetable</button>
  </div>

  <script>
    const scriptURL = "https://script.google.com/macros/s/AKfycbxJ-IGsjzrqUlykZEgK_BtLtz4O7BCF8tv8_Hus1dOENrN_Wnr0NzTAT38KMGamy-XJlQ/exec";
    let studentData = {};

    document.addEventListener("DOMContentLoaded", () => {
      fetch(scriptURL)
        .then(res => res.json())
        .then(data => {
          console.log(data); // Check if this logs the student data correctly
          studentData = data.students;
          const studentSelect = document.getElementById("studentSelect");

          if (studentData) {
            Object.keys(studentData).forEach(id => {
              const option = document.createElement("option");
              option.value = id;
              option.textContent = `${studentData[id].name} (${id})`;
              studentSelect.appendChild(option);
            });
          } else {
            console.log("No student data available or data structure is incorrect.");
          }
        })
        .catch(err => {
          console.log("Error fetching student data: ", err);
        });
    });

    document.getElementById("studentSelect").addEventListener("change", function() {
      const studentId = this.value;
      if (studentId) {
        createTimetableUI(studentId);
      }
    });

    function createTimetableUI(studentId) {
      const container = document.getElementById("timetable");
      container.innerHTML = "";

      const subjects = studentData[studentId].subjects;
      const days = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"];

      days.forEach(day => {
        const table = document.createElement("table");
        const titleRow = document.createElement("tr");
        titleRow.innerHTML = `<td colspan="5" class="day-title">${day}</td>`;
        table.appendChild(titleRow);

        const header = document.createElement("tr");
        header.innerHTML = `<th>Time</th><th>Subject</th><th>Teacher</th><th>Meeting Link</th><th>Action</th>`;
        table.appendChild(header);

        const addRow = document.createElement("tr");
        addRow.innerHTML = `
          <td><input type="text" placeholder="10:00 AM - 10:45 AM" class="time-input"></td>
          <td>
            <select class="subject-select">
              ${subjects.map(sub => `<option value="${sub.subject}" data-teacher="${sub.teacher}">${sub.subject}</option>`).join("")}
            </select>
          </td>
          <td><input type="text" class="teacher-input" readonly></td>
          <td><input type="url" placeholder="https://..." class="link-input"></td>
          <td><button class="delete-btn" onclick="this.closest('tr').remove()">Delete</button></td>
        `;
        table.appendChild(addRow);

        // Auto-fill teacher when subject selected
        addRow.querySelector(".subject-select").addEventListener("change", function() {
          const selectedOption = this.options[this.selectedIndex];
          const teacherInput = addRow.querySelector(".teacher-input");
          teacherInput.value = selectedOption.dataset.teacher;
        });

        // Trigger autofill on load
        addRow.querySelector(".subject-select").dispatchEvent(new Event('change'));

        const addBtnRow = document.createElement("tr");
        const btnTd = document.createElement("td");
        btnTd.colSpan = 5;
        btnTd.innerHTML = `<button class="add-more-btn" onclick="addRowToTable(this)">Add More</button>`;
        addBtnRow.appendChild(btnTd);
        table.appendChild(addBtnRow);

        container.appendChild(table);
      });
    }

    function addRowToTable(btn) {
      const row = btn.closest("table").rows[2].cloneNode(true);
      row.querySelector(".time-input").value = "";
      row.querySelector(".link-input").value = "";

      row.querySelector(".subject-select").addEventListener("change", function() {
        const teacherInput = row.querySelector(".teacher-input");
        teacherInput.value = this.options[this.selectedIndex].dataset.teacher;
      });
      row.querySelector(".subject-select").dispatchEvent(new Event('change'));

      btn.closest("table").insertBefore(row, btn.closest("tr"));
    }

   function submitTimetable() {
  const weekStart = document.getElementById("weekStart").value;
  const studentId = document.getElementById("studentSelect").value;
  const studentName = studentData[studentId]?.name;

  // Validate inputs
  if (!weekStart || !studentId || !studentName) {
    alert("Please select a valid week and student");
    return;
  }

  const entries = [];

  const tables = document.querySelectorAll("#timetable table");
  tables.forEach(table => {
    const day = table.querySelector(".day-title").textContent;
    const rows = table.querySelectorAll("tr");

    for (let i = 2; i < rows.length - 1; i++) {
      const time = rows[i].querySelector(".time-input").value;
      const subject = rows[i].querySelector(".subject-select").value;
      const teacher = rows[i].querySelector(".teacher-input").value;
      const link = rows[i].querySelector(".link-input").value;

      if (time && subject && teacher && link) {
        entries.push({
          day, time, subject, teacher, link
        });
      }
    });
  });

  if (entries.length === 0) {
    alert("Please fill in at least one timetable entry.");
    return;
  }

  // Prepare the data to send
  const dataToSubmit = {
    weekStart,
    studentId,
    studentName,
    entries
  };

  console.log("Submitting data:", dataToSubmit); // Log data before submitting

  // Send the data via POST request
  fetch(scriptURL, {
    method: "POST",
    headers: {
      "Content-Type": "application/json"
    },
    body: JSON.stringify(dataToSubmit)
  })
  .then(response => response.json())
  .then(res => {
    console.log("Response from server:", res); // Log the server response
    if (res.success) {
      alert("Timetable submitted successfully!");
    } else {
      alert("Error submitting timetable. Please try again.");
    }
  })
  .catch(error => {
    console.error("Error during submission:", error); // Log any errors
    alert("Error during submission. Check the console for more details.");
  });
}
  </script>

</body>
</html>
