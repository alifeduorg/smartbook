<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>School Financial Dashboard</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>
    <!-- jsPDF and html2canvas CDNs for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* Very light blue-gray background */
        }
        .container {
            max-width: 1200px;
        }
        .card {
            background-color: #ffffff;
            border-radius: 16px; /* Slightly more rounded corners */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* More pronounced shadow for depth */
            transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out; /* Smooth transitions */
        }
        .card:hover {
            transform: translateY(-5px) scale(1.01); /* Subtle lift and slight scale on hover */
            box-shadow: 0 15px 20px -5px rgba(0, 0, 0, 0.15), 0 6px 8px -3px rgba(0, 0, 0, 0.08); /* Deeper shadow on hover */
        }
        .chart-container {
            position: relative;
            height: 400px; /* Fixed height for charts */
            width: 100%;
        }
        /* Custom scrollbar for overflow content */
        .overflow-x-auto::-webkit-scrollbar {
            height: 8px;
        }
        .overflow-x-auto::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .overflow-x-auto::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        /* Tab styling */
        .tab-button {
            padding: 12px 24px;
            border-radius: 10px; /* Slightly more rounded */
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease-in-out; /* Smooth transitions */
            background-color: #e0e7ff; /* Light indigo */
            color: #4338ca; /* Darker indigo text */
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        .tab-button:hover {
            background-color: #c7d2fe; /* Lighter indigo on hover */
            transform: translateY(-2px); /* Subtle lift */
        }
        .tab-button.active {
            background-color: #4f46e5; /* Stronger indigo */
            color: #ffffff;
            box-shadow: 0 4px 10px rgba(79, 70, 229, 0.4); /* More prominent shadow */
            transform: translateY(-2px); /* Keep lifted when active */
        }

        /* Fade-in animation for tab content */
        .tab-content {
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.5s ease-out, transform 0.5s ease-out;
        }
        .tab-content.active-fade-in {
            opacity: 1;
            transform: translateY(0);
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }
        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background-color: #ffffff;
            padding: 2rem;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
            transform: scale(0.9);
            transition: transform 0.3s ease-in-out;
        }
        .modal-overlay.show .modal-content {
            transform: scale(1);
        }
        .modal-close-button {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6b7280;
        }
        .modal-close-button:hover {
            color: #1f2937;
        }
        .action-button {
            background-color: #10b981; /* Emerald green */
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease-in-out, transform 0.2s ease-in-out;
            margin-top: 1rem;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            margin-right: 1rem; /* Space between buttons */
        }
        .action-button:hover {
            background-color: #059669; /* Darker green */
            transform: translateY(-1px);
        }
        .copy-button {
            background-color: #3b82f6; /* Blue */
        }
        .copy-button:hover {
            background-color: #2563eb; /* Darker Blue */
        }
        .email-preview {
            background-color: #f3f4f6;
            border: 1px solid #e5e7eb;
            padding: 1rem;
            border-radius: 8px;
            font-family: monospace;
            white-space: pre-wrap; /* Preserve whitespace and wrap text */
            word-break: break-word; /* Break long words */
            max-height: 300px;
            overflow-y: auto;
            margin-top: 1rem;
        }
    </style>
</head>
<body class="p-4 sm:p-6 md:p-8">
    <div class="container mx-auto">
        <h1 class="text-3xl sm:text-4xl font-bold text-gray-800 mb-8 text-center">School Financial Dashboard</h1>

        <!-- Loading Spinner -->
        <div id="loadingSpinner" class="fixed inset-0 bg-gray-200 bg-opacity-75 flex items-center justify-center z-50 hidden">
            <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-500"></div>
            <p class="ml-4 text-lg text-gray-700">Loading data...</p>
        </div>

        <!-- Navigation Tabs -->
        <div class="flex flex-wrap justify-center gap-4 mb-8">
            <button class="tab-button active" data-tab="overview">Overview</button>
            <button class="tab-button" data-tab="teacher-salaries">Teacher Monthly Salaries</button>
            <button class="tab-button" data-tab="student-fees">Student Monthly Fees</button>
            <button class="tab-button" data-tab="office-staff-expenses">Office Staff Expenses</button> <!-- New Tab Button -->
        </div>

        <!-- Month Selection Dropdown -->
        <div class="flex justify-center mb-8">
            <label for="monthSelect" class="block text-lg font-medium text-gray-700 mr-4 self-center">Select Month:</label>
            <select id="monthSelect" class="mt-1 block w-auto pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md shadow-sm">
                <!-- Options will be populated by JavaScript -->
            </select>
        </div>

        <!-- Overview Section (Summary Cards & Monthly Charts) -->
        <div id="overview" class="tab-content">
            <!-- Summary Cards -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="card p-6 text-center">
                    <h2 class="text-xl font-semibold text-gray-600 mb-2">Total Earnings</h2>
                    <p id="totalEarnings" class="text-3xl font-bold text-green-600">₹0.00</p>
                </div>
                <div class="card p-6 text-center">
                    <h2 class="text-xl font-semibold text-gray-600 mb-2">Total Expenditure</h2>
                    <p id="totalExpenditure" class="text-3xl font-bold text-red-600">₹0.00</p>
                </div>
                <div class="card p-6 text-center">
                    <h2 class="text-xl font-semibold text-gray-600 mb-2">Net Profit</h2>
                    <p id="netProfit" class="text-3xl font-bold text-blue-600">₹0.00</p>
                </div>
            </div>

            <!-- Monthly Charts Section -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                <!-- Monthly Profit Chart -->
                <div class="card p-6">
                    <h2 class="text-2xl font-semibold text-gray-700 mb-4">Monthly Profit Chart</h2>
                    <div class="chart-container">
                        <canvas id="monthlyProfitChart"></canvas>
                    </div>
                </div>

                <!-- Monthly Teacher Salary Chart -->
                <div class="card p-6">
                    <h2 class="text-2xl font-semibold text-gray-700 mb-4">Monthly Teacher Salary Chart</h2>
                    <div class="chart-container">
                        <canvas id="monthlyTeacherSalaryChart"></canvas>
                    </div>
                </div>

                <!-- Monthly Student Fee Chart -->
                <div class="card p-6">
                    <h2 class="text-2xl font-semibold text-gray-700 mb-4">Monthly Student Fee Chart</h2>
                    <div class="chart-container">
                        <canvas id="monthlyStudentFeeChart"></canvas>
                    </div>
                </div>

                <!-- New: Overall Counts Chart -->
                <div class="card p-6 col-span-1 lg:col-span-2">
                    <h2 class="text-2xl font-semibold text-gray-700 mb-4">Overall Counts (Teachers, Students, Staff)</h2>
                    <div class="chart-container">
                        <canvas id="overallCountsChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- New: Overall Download Buttons -->
            <div class="flex flex-wrap justify-center gap-4 mt-8">
                <button id="downloadOverallReportButton" class="action-button">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                    Download Overall Report as PDF
                </button>
                <button id="downloadCombinedSalariesExpensesButton" class="action-button copy-button">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                    Download Combined Salaries & Expenses Report as PDF
                </button>
            </div>
        </div>

        <!-- Teacher Monthly Salaries Section -->
        <div id="teacher-salaries" class="tab-content hidden">
            <div class="card p-6">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">Teacher Monthly Salaries</h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white rounded-lg shadow-md" id="teacherSalariesTable"> <!-- Added ID for PDF download -->
                        <thead>
                            <tr class="bg-gray-100 text-left text-gray-600 uppercase text-sm leading-normal">
                                <th class="py-3 px-6">Month</th>
                                <th class="py-3 px-6">Teacher ID (Name)</th>
                                <th class="py-3 px-6">Salary</th>
                            </tr>
                        </thead>
                        <tbody id="teacherSalariesTableBody" class="text-gray-700 text-sm font-light">
                            <!-- Data will be inserted here by JavaScript -->
                        </tbody>
                    </table>
                </div>
                <div class="flex justify-center mt-8">
                    <button id="downloadTeacherSalariesPdfButton" class="action-button">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                        </svg>
                        Download Monthly Teacher Salaries Report
                    </button>
                </div>
            </div>
        </div>

        <!-- Student Monthly Fees Section -->
        <div id="student-fees" class="tab-content hidden">
            <div class="card p-6">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">Student Monthly Fees</h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white rounded-lg shadow-md" id="studentFeesTable"> <!-- Added ID for PDF download -->
                        <thead>
                            <tr class="bg-gray-100 text-left text-gray-600 uppercase text-sm leading-normal">
                                <th class="py-3 px-6">Month</th>
                                <th class="py-3 px-6">Student ID (Name)</th>
                                <th class="py-3 px-6">Fee</th>
                            </tr>
                        </thead>
                        <tbody id="studentFeesTableBody" class="text-gray-700 text-sm font-light">
                            <!-- Data will be inserted here by JavaScript -->
                        </tbody>
                    </table>
                </div>
                <div class="flex justify-center mt-8">
                    <button id="downloadStudentFeesPdfButton" class="action-button">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                        </svg>
                        Download Monthly Student Fees Report
                    </button>
                </div>
            </div>
        </div>

        <!-- New: Office Staff Expenses Section -->
        <div id="office-staff-expenses" class="tab-content hidden">
            <div class="card p-6">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">Office Staff Expenses</h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white rounded-lg shadow-md" id="officeStaffExpensesTable"> <!-- Added ID for PDF download -->
                        <thead>
                            <tr class="bg-gray-100 text-left text-gray-600 uppercase text-sm leading-normal">
                                <th class="py-3 px-6">Staff Role</th>
                                <th class="py-3 px-6">Hourly Rate (₹)</th>
                                <th class="py-3 px-6">Calculated Salary (₹)</th>
                            </tr>
                        </thead>
                        <tbody id="officeStaffTableBody" class="text-gray-700 text-sm font-light">
                            <!-- Data will be inserted here by JavaScript -->
                        </tbody>
                    </table>
                </div>
                <div class="flex justify-center mt-8">
                    <button id="downloadOfficeStaffExpensesPdfButton" class="action-button">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                        Download Monthly Office Staff Expenses Report
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Teacher/Student Details Modal (Existing Modal, now with Email Button) -->
    <div id="detailsModal" class="modal-overlay">
        <div class="modal-content relative">
            <button class="modal-close-button" onclick="closeModal('detailsModal')">&times;</button>
            <h3 id="modalTitle" class="text-2xl font-bold text-gray-800 mb-4">Details</h3>
            <div id="modalBody" class="text-gray-700">
                <!-- Details will be loaded here -->
            </div>
            <div class="flex flex-wrap gap-4 mt-4">
                <button id="downloadPdfButton" class="action-button" onclick="downloadModalContentAsPdf('detailsModal')">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                    Download as PDF
                </button>
                <button id="generateEmailButton" class="action-button copy-button" onclick="showEmailModal()">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z" />
                        <path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z" />
                    </svg>
                    Generate Official Email
                </button>
            </div>
        </div>
    </div>

    <!-- New: Office Staff Details Modal -->
    <div id="officeStaffDetailsModal" class="modal-overlay">
        <div class="modal-content relative">
            <button class="modal-close-button" onclick="closeModal('officeStaffDetailsModal')">&times;</button>
            <h3 id="officeStaffModalTitle" class="text-2xl font-bold text-gray-800 mb-4">Office Staff Details</h3>
            <div id="officeStaffModalBody" class="text-gray-700">
                <!-- Details will be loaded here -->
            </div>
            <div class="flex flex-wrap gap-4 mt-4">
                <button id="downloadOfficeStaffPdfButton" class="action-button" onclick="downloadModalContentAsPdf('officeStaffDetailsModal')">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                    Download as PDF
                </button>
                <button id="generateOfficeStaffEmailButton" class="action-button copy-button" onclick="showEmailModal('officeStaff')">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z" />
                        <path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z" />
                    </svg>
                    Generate Official Email
                </button>
            </div>
        </div>
    </div>

    <!-- New: Email Preview Modal -->
    <div id="emailModal" class="modal-overlay">
        <div class="modal-content relative">
            <button class="modal-close-button" onclick="closeModal('emailModal')">&times;</button>
            <h3 class="text-2xl font-bold text-gray-800 mb-4">Official Email Preview</h3>
            <div id="emailContentPreview" class="email-preview">
                <!-- Email content will be displayed here -->
            </div>
            <button class="action-button copy-button mt-4" onclick="copyEmailToClipboard()">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                    <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                </svg>
                Copy to Clipboard
            </button>
        </div>
    </div>

    <!-- Hidden div for combined PDF content -->
    <div id="combinedPdfContent" style="position: absolute; left: -9999px; top: -9999px; width: 100%; padding: 20px; box-sizing: border-box;"></div>

    <script>
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwV4LmZMayHNWpmaRtxx5lF3-J0kXAVylCieGIMF4j0ZBlpbEVDJ0-_fef28NYF4M7r/exec';

        let monthlyProfitChart;
        let monthlyTeacherSalaryChart;
        let monthlyStudentFeeChart;
        let overallCountsChart; // New chart variable

        let dashboardData = null; // Store fetched data globally
        let sortedMonths = []; // To store sorted month names (e.g., "January", "February")

        let currentEmailData = {}; // To store data for the email preview

        /**
         * Fetches data from the Google Apps Script web app.
         * Shows a loading spinner during the fetch operation.
         * @returns {Promise<Object>} A promise that resolves with the fetched data.
         */
        async function fetchData() {
            const loadingSpinner = document.getElementById('loadingSpinner');
            loadingSpinner.classList.remove('hidden'); // Show spinner

            try {
                const response = await fetch(WEB_APP_URL);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                console.log("Fetched data:", data); // Log entire data object for debugging

                // --- NEW: Detailed logging for classDurationHours ---
                if (data.detailedLogData && Array.isArray(data.detailedLogData)) {
                    console.log("--- Checking classDurationHours in detailedLogData ---");
                    data.detailedLogData.forEach((entry, index) => {
                        console.log(`Entry ${index}: classDurationHours: ${entry.classDurationHours} (Type: ${typeof entry.classDurationHours})`);
                    });
                    console.log("--- End of classDurationHours check ---");
                }
                // --- END NEW LOGGING ---

                return data;
            } catch (error) {
                console.error("Error fetching data:", error);
                // Use a custom message box instead of alert()
                showMessageBox("Error", "Failed to load data. Please check the web app URL and script deployment. Error: " + error.message);
                return null;
            } finally {
                loadingSpinner.classList.add('hidden'); // Hide spinner
            }
        }

        /**
         * Sorts months chronologically.
         * @param {Array<string>} monthsArray The array of month names (e.g., ["May", "April"]).
         * @returns {Array<string>} The sorted array of month names (e.g., ["April", "May"]).
         */
        function sortMonthsChronologically(monthsArray) {
            const monthOrder = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            return monthsArray.sort((a, b) => monthOrder.indexOf(a) - monthOrder.indexOf(b));
        }

        /**
         * Populates the month selection dropdown.
         * @param {Object} monthlyData The monthly aggregated data (keyed by month name, e.g., "January").
         */
        function populateMonthSelect(monthlyData) {
            const monthSelect = document.getElementById('monthSelect');
            monthSelect.innerHTML = ''; // Clear existing options

            // Get unique month names from the data keys
            const uniqueMonthNames = Object.keys(monthlyData);
            sortedMonths = sortMonthsChronologically(uniqueMonthNames);

            // Add "All Months" option
            const allMonthsOption = document.createElement('option');
            allMonthsOption.value = 'all';
            allMonthsOption.textContent = 'All Months (Overall)';
            monthSelect.appendChild(allMonthsOption);

            // Add options for each sorted month
            sortedMonths.forEach(month => {
                const option = document.createElement('option');
                option.value = month; // Value is the month name (e.g., "May")
                option.textContent = month; // Display is the month name
                monthSelect.appendChild(option);
            });

            // Set default to "All Months"
            monthSelect.value = 'all';
        }

        /**
         * Renders the charts using Chart.js based on the selected month.
         * @param {Object} data The processed financial data.
         * @param {string} selectedMonth The month to display, or 'all' for all months.
         */
        function renderCharts(data, selectedMonth) {
            const monthlyData = data.monthlyData;
            let labels, totalMonthlySalaries, totalMonthlyFees, monthlyProfits;

            if (selectedMonth === 'all') {
                labels = sortedMonths; // Use the sorted list of unique month names
                totalMonthlySalaries = labels.map(month => monthlyData[month] ? monthlyData[month].totalTeacherSalary : 0);
                totalMonthlyFees = labels.map(month => monthlyData[month] ? monthlyData[month].totalStudentFee : 0);
                monthlyProfits = labels.map(month => monthlyData[month] ? monthlyData[month].monthlyProfit : 0);
            } else {
                labels = [selectedMonth]; // Only the selected month
                totalMonthlySalaries = [monthlyData[selectedMonth] ? monthlyData[selectedMonth].totalTeacherSalary : 0];
                totalMonthlyFees = [monthlyData[selectedMonth] ? monthlyData[selectedMonth].totalStudentFee : 0];
                monthlyProfits = [monthlyData[selectedMonth] ? monthlyData[selectedMonth].monthlyProfit : 0];
            }

            // Define a consistent color palette for charts
            const chartColors = {
                profitPositive: 'rgba(75, 192, 192, 0.7)', // Teal
                profitNegative: 'rgba(255, 99, 132, 0.7)', // Red
                teacherSalary: 'rgba(79, 70, 229, 0.7)', // Indigo
                studentFee: 'rgba(234, 179, 8, 0.7)',    // Amber
                overallCounts: ['rgba(54, 162, 235, 0.7)', 'rgba(255, 206, 86, 0.7)', 'rgba(153, 102, 255, 0.7)'], // Blue, Yellow, Purple
                borderColor: (color) => color.replace('0.7', '1') // Solid border
            };

            // Destroy existing charts if they exist to prevent re-rendering issues
            if (monthlyProfitChart) monthlyProfitChart.destroy();
            if (monthlyTeacherSalaryChart) monthlyTeacherSalaryChart.destroy();
            if (monthlyStudentFeeChart) monthlyStudentFeeChart.destroy();
            // No need to destroy overallCountsChart here, it's handled by its own render function

            // Monthly Profit Chart
            const profitCtx = document.getElementById('monthlyProfitChart').getContext('2d');
            monthlyProfitChart = new Chart(profitCtx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Monthly Profit',
                        data: monthlyProfits,
                        backgroundColor: monthlyProfits.map(profit => profit >= 0 ? chartColors.profitPositive : chartColors.profitNegative),
                        borderColor: monthlyProfits.map(profit => profit >= 0 ? chartColors.borderColor(chartColors.profitPositive) : chartColors.borderColor(chartColors.profitNegative)),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: selectedMonth === 'all' ? 'Monthly Profit/Loss (All Months)' : `Profit/Loss for ${selectedMonth}`,
                            font: { size: 16 }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Amount (₹)'
                            }
                        }
                    }
                }
            });

            // Monthly Teacher Salary Chart
            const teacherSalaryCtx = document.getElementById('monthlyTeacherSalaryChart').getContext('2d');
            monthlyTeacherSalaryChart = new Chart(teacherSalaryCtx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Total Teacher Salary',
                        data: totalMonthlySalaries,
                        backgroundColor: chartColors.teacherSalary,
                        borderColor: chartColors.borderColor(chartColors.teacherSalary),
                        borderWidth: 2,
                        fill: false,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: selectedMonth === 'all' ? 'Total Monthly Teacher Salaries (All Months)' : `Total Teacher Salary for ${selectedMonth}`,
                            font: { size: 16 }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Amount (₹)'
                            }
                        }
                    }
                }
            });

            // Monthly Student Fee Chart
            const studentFeeCtx = document.getElementById('monthlyStudentFeeChart').getContext('2d');
            monthlyStudentFeeChart = new Chart(studentFeeCtx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Total Student Fees',
                        data: totalMonthlyFees,
                        backgroundColor: chartColors.studentFee,
                        borderColor: chartColors.borderColor(chartColors.studentFee),
                        borderWidth: 2,
                        fill: false,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: selectedMonth === 'all' ? 'Total Monthly Student Fees (All Months)' : `Total Student Fee for ${selectedMonth}`,
                            font: { size: 16 }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Amount (₹)'
                            }
                        }
                    }
                }
            });
        }

        /**
         * Renders the overall counts chart for teachers, students, and staff.
         * @param {Object} data The processed financial data.
         */
        function renderOverallCountsChart(data) {
            const teacherIds = new Set();
            const studentIds = new Set();
            const officeStaffPositions = new Set();

            // Collect unique teacher and student IDs from detailed log data
            data.detailedLogData.forEach(entry => {
                if (entry.staffId) teacherIds.add(entry.staffId);
                if (entry.studentId) studentIds.add(entry.studentId);
            });

            // Collect unique office staff positions from config
            for (const position in data.officeStaffConfig) {
                officeStaffPositions.add(position);
            }

            const teacherCount = teacherIds.size;
            const studentCount = studentIds.size;
            const officeStaffCount = officeStaffPositions.size;

            const chartColors = {
                overallCounts: ['rgba(54, 162, 235, 0.7)', 'rgba(255, 206, 86, 0.7)', 'rgba(153, 102, 255, 0.7)'], // Blue, Yellow, Purple
                borderColor: (color) => color.replace('0.7', '1') // Solid border
            };

            if (overallCountsChart) overallCountsChart.destroy(); // Destroy existing chart

            const countsCtx = document.getElementById('overallCountsChart').getContext('2d');
            overallCountsChart = new Chart(countsCtx, {
                type: 'bar',
                data: {
                    labels: ['Teachers', 'Students', 'Office Staff'],
                    datasets: [{
                        label: 'Total Count',
                        data: [teacherCount, studentCount, officeStaffCount],
                        backgroundColor: chartColors.overallCounts,
                        borderColor: chartColors.overallCounts.map(color => chartColors.borderColor(color)),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Overall Counts of Personnel & Students',
                            font: { size: 16 }
                        },
                        legend: {
                            display: false // No need for legend as labels are clear
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Number of Individuals'
                            },
                            ticks: {
                                precision: 0 // Ensure whole numbers for counts
                            }
                        }
                    }
                }
            });
        }


        /**
         * Updates the summary cards with yearly totals or selected month's totals.
         * @param {Object} data The processed financial data.
         * @param {string} selectedMonth The month to display, or 'all' for all months.
         */
        function updateSummary(data, selectedMonth) {
            let earnings, expenditure, profit;

            if (selectedMonth === 'all') {
                earnings = data.yearlyTotals.totalEarnings;
                expenditure = data.yearlyTotals.totalExpenditure;
                profit = data.yearlyTotals.netProfit;
            } else {
                const monthData = data.monthlyData[selectedMonth];
                earnings = monthData ? monthData.totalStudentFee : 0;
                expenditure = monthData ? monthData.totalTeacherSalary : 0;
                profit = monthData ? monthData.monthlyProfit : 0;
            }

            document.getElementById('totalEarnings').textContent = `₹${earnings.toFixed(2)}`;
            document.getElementById('totalExpenditure').textContent = `₹${expenditure.toFixed(2)}`;
            document.getElementById('netProfit').textContent = `₹${profit.toFixed(2)}`;

            // Apply color based on profit/loss
            const netProfitElement = document.getElementById('netProfit');
            if (profit >= 0) {
                netProfitElement.classList.remove('text-red-600');
                netProfitElement.classList.add('text-green-600');
            } else {
                netProfitElement.classList.remove('text-green-600');
                netProfitElement.classList.add('text-red-600');
            }
        }

        /**
         * Generates the HTML table for teacher monthly salaries.
         * This function is now reusable for display and PDF generation.
         * @param {Object} data The processed financial data.
         * @param {string} selectedMonth The month to display, or 'all' for all months.
         * @returns {string} The HTML string for the teacher salaries table.
         */
        function getTeacherSalariesTableHtml(data, selectedMonth) {
            let tableRowsHtml = '';
            let hasData = false;
            let overallTotalSalary = 0;
            let overallTotalHours = 0; // Keep for console logging/internal use

            console.log(`--- Generating Teacher Salaries Table for Month: ${selectedMonth} ---`);

            if (selectedMonth === 'all') {
                const yearlyTeacherTotals = {};
                data.detailedLogData.forEach(entry => {
                    if (entry.staffId) {
                        const teacherId = entry.staffId;
                        if (!yearlyTeacherTotals[teacherId]) {
                            yearlyTeacherTotals[teacherId] = {
                                name: entry.teacherName,
                                totalSalary: 0,
                                totalHours: 0,
                                classDates: new Set()
                            };
                        }
                        yearlyTeacherTotals[teacherId].totalSalary += parseFloat(entry.teacherSalary || 0);
                        yearlyTeacherTotals[teacherId].totalHours += parseFloat(entry.classDurationHours || 0);
                        yearlyTeacherTotals[teacherId].classDates.add(new Date(entry.date).toLocaleDateString());
                        hasData = true;
                    }
                });

                const sortedTeacherIds = Object.keys(yearlyTeacherTotals).sort();
                sortedTeacherIds.forEach(teacherId => {
                    const teacherInfo = yearlyTeacherTotals[teacherId];
                    tableRowsHtml += `
                        <tr class="border-b border-gray-200 hover:bg-gray-100 cursor-pointer" data-teacher-id="${teacherId}" data-month="${selectedMonth}">
                            <td class="py-3 px-6 whitespace-nowrap">All Months</td>
                            <td class="py-3 px-6 whitespace-nowrap">${teacherId} (${teacherInfo.name})</td>
                            <td class="py-3 px-6 whitespace-nowrap">₹${teacherInfo.totalSalary.toFixed(2)}</td>
                        </tr>
                    `;
                    overallTotalSalary += teacherInfo.totalSalary;
                    overallTotalHours += teacherInfo.totalHours;
                    console.log(`Teacher (All Months): ${teacherInfo.name}, Hours: ${teacherInfo.totalHours.toFixed(2)}, Salary: ${teacherInfo.totalSalary.toFixed(2)}`);
                });

            } else { // Specific month selected
                const month = selectedMonth;
                const teachers = data.monthlyData[month] ? data.monthlyData[month].teachers : {};
                const sortedTeacherIds = Object.keys(teachers).sort();

                if (sortedTeacherIds.length > 0) {
                    hasData = true;
                    sortedTeacherIds.forEach(teacherId => {
                        const teacherInfo = teachers[teacherId];
                        tableRowsHtml += `
                            <tr class="border-b border-gray-200 hover:bg-gray-100 cursor-pointer" data-teacher-id="${teacherId}" data-month="${selectedMonth}">
                                <td class="py-3 px-6 whitespace-nowrap">${month}</td>
                                <td class="py-3 px-6 whitespace-nowrap">${teacherId} (${teacherInfo.name})</td>
                                <td class="py-3 px-6 whitespace-nowrap">₹${parseFloat(teacherInfo.totalSalary || 0).toFixed(2)}</td>
                            </tr>
                        `;
                        overallTotalSalary += parseFloat(teacherInfo.totalSalary || 0);
                        overallTotalHours += parseFloat(teacherInfo.totalHours || 0);
                        console.log(`Teacher (${month}): ${teacherInfo.name}, Hours: ${parseFloat(teacherInfo.totalHours || 0).toFixed(2)}, Salary: ${parseFloat(teacherInfo.totalSalary || 0).toFixed(2)}`);
                    });
                }
            }

            if (!hasData) {
                tableRowsHtml = `<tr><td colspan="3" class="py-3 px-6 text-center text-gray-500">No teacher salary data for the selected month(s).</td></tr>`;
            }

            const title = selectedMonth === 'all' ? 'Overall Teacher Salaries Report' : `Teacher Salaries Report for ${selectedMonth}`;
            console.log(`Overall Teacher Hours for ${selectedMonth}: ${overallTotalHours.toFixed(2)}`);
            console.log(`Overall Teacher Salary for ${selectedMonth}: ₹${overallTotalSalary.toFixed(2)}`);


            return `
                <div class="overflow-x-auto">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">${title}</h3>
                    <table class="min-w-full bg-white rounded-lg shadow-md">
                        <thead>
                            <tr class="bg-gray-100 text-left text-gray-600 uppercase text-sm leading-normal">
                                <th class="py-3 px-6">Month</th>
                                <th class="py-3 px-6">Teacher ID (Name)</th>
                                <th class="py-3 px-6">Salary</th>
                            </tr>
                        </thead>
                        <tbody class="text-gray-700 text-sm font-light">
                            ${tableRowsHtml}
                        </tbody>
                        <tfoot>
                            <tr class="bg-gray-100 text-left text-gray-700 uppercase text-sm leading-normal font-bold">
                                <td class="py-3 px-6" colspan="2">Overall Sum:</td>
                                <td class="py-3 px-6">₹${overallTotalSalary.toFixed(2)}</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            `;
        }


        /**
         * Populates the teacher monthly salaries table based on the selected month.
         * Adds click handlers to rows for detailed view.
         * @param {Object} data The processed financial data.
         * @param {string} selectedMonth The month to display, or 'all' for all months.
         */
        function populateTeacherSalariesTable(data, selectedMonth) {
            const tableContainer = document.getElementById('teacherSalariesTable');
            tableContainer.innerHTML = getTeacherSalariesTableHtml(data, selectedMonth);

            // Add click event listeners to the newly created rows
            tableContainer.querySelectorAll('tr[data-teacher-id]').forEach(row => {
                row.addEventListener('click', (event) => {
                    const teacherId = event.currentTarget.dataset.teacherId;
                    const month = event.currentTarget.dataset.month;
                    showTeacherDetailsModal(teacherId, month);
                });
            });
        }

        /**
         * Generates the HTML table for student monthly fees.
         * This function is now reusable for display and PDF generation.
         * @param {Object} data The processed financial data.
         * @param {string} selectedMonth The month to display, or 'all' for all months.
         * @returns {string} The HTML string for the student fees table.
         */
        function getStudentFeesTableHtml(data, selectedMonth) {
            let tableRowsHtml = '';
            let hasData = false;
            let overallTotalFee = 0;
            let overallTotalHours = 0; // Keep for console logging/internal use

            console.log(`--- Generating Student Fees Table for Month: ${selectedMonth} ---`);

            if (selectedMonth === 'all') {
                const yearlyStudentTotals = {};
                data.detailedLogData.forEach(entry => {
                    if (entry.studentId) {
                        const studentId = entry.studentId;
                        if (!yearlyStudentTotals[studentId]) {
                            yearlyStudentTotals[studentId] = {
                                name: entry.studentName,
                                totalFee: 0,
                                totalHours: 0,
                                classDates: new Set()
                            };
                        }
                        yearlyStudentTotals[studentId].totalFee += parseFloat(entry.studentFee || 0);
                        yearlyStudentTotals[studentId].totalHours += parseFloat(entry.classDurationHours || 0);
                        yearlyStudentTotals[studentId].classDates.add(new Date(entry.date).toLocaleDateString());
                        hasData = true;
                    }
                });

                const sortedStudentIds = Object.keys(yearlyStudentTotals).sort();
                sortedStudentIds.forEach(studentId => {
                    const studentInfo = yearlyStudentTotals[studentId];
                    tableRowsHtml += `
                        <tr class="border-b border-gray-200 hover:bg-gray-100 cursor-pointer" data-student-id="${studentId}" data-month="${selectedMonth}">
                            <td class="py-3 px-6 whitespace-nowrap">All Months</td>
                            <td class="py-3 px-6 whitespace-nowrap">${studentId} (${studentInfo.name})</td>
                            <td class="py-3 px-6 whitespace-nowrap">₹${studentInfo.totalFee.toFixed(2)}</td>
                        </tr>
                    `;
                    overallTotalFee += studentInfo.totalFee;
                    overallTotalHours += studentInfo.totalHours;
                    console.log(`Student (All Months): ${studentInfo.name}, Hours: ${studentInfo.totalHours.toFixed(2)}, Fee: ${studentInfo.totalFee.toFixed(2)}`);
                });

            } else { // Specific month selected
                const month = selectedMonth;
                const students = data.monthlyData[month] ? data.monthlyData[month].students : {};
                const sortedStudentIds = Object.keys(students).sort();

                if (sortedStudentIds.length > 0) {
                    hasData = true;
                    sortedStudentIds.forEach(studentId => {
                        const studentInfo = students[studentId];
                        tableRowsHtml += `
                            <tr class="border-b border-gray-200 hover:bg-gray-100 cursor-pointer" data-student-id="${studentId}" data-month="${selectedMonth}">
                                <td class="py-3 px-6 whitespace-nowrap">${month}</td>
                                <td class="py-3 px-6 whitespace-nowrap">${studentId} (${studentInfo.name})</td>
                                <td class="py-3 px-6 whitespace-nowrap">₹${parseFloat(studentInfo.totalFee || 0).toFixed(2)}</td>
                            </tr>
                        `;
                        overallTotalFee += parseFloat(studentInfo.totalFee || 0);
                        overallTotalHours += parseFloat(studentInfo.totalHours || 0);
                        console.log(`Student (${month}): ${studentInfo.name}, Hours: ${parseFloat(studentInfo.totalHours || 0).toFixed(2)}, Fee: ${parseFloat(studentInfo.totalFee || 0).toFixed(2)}`);
                    });
                }
            }

            if (!hasData) {
                tableRowsHtml = `<tr><td colspan="3" class="py-3 px-6 text-center text-gray-500">No student fee data for the selected month(s).</td></tr>`;
            }

            const title = selectedMonth === 'all' ? 'Overall Student Fees Report' : `Student Fees Report for ${selectedMonth}`;
            console.log(`Overall Student Hours for ${selectedMonth}: ${overallTotalHours.toFixed(2)}`);
            console.log(`Overall Student Fee for ${selectedMonth}: ₹${overallTotalFee.toFixed(2)}`);

            return `
                <div class="overflow-x-auto">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">${title}</h3>
                    <table class="min-w-full bg-white rounded-lg shadow-md">
                        <thead>
                            <tr class="bg-gray-100 text-left text-gray-600 uppercase text-sm leading-normal">
                                <th class="py-3 px-6">Month</th>
                                <th class="py-3 px-6">Student ID (Name)</th>
                                <th class="py-3 px-6">Fee</th>
                            </tr>
                        </thead>
                        <tbody class="text-gray-700 text-sm font-light">
                            ${tableRowsHtml}
                        </tbody>
                        <tfoot>
                            <tr class="bg-gray-100 text-left text-gray-700 uppercase text-sm leading-normal font-bold">
                                <td class="py-3 px-6" colspan="2">Overall Sum:</td>
                                <td class="py-3 px-6">₹${overallTotalFee.toFixed(2)}</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            `;
        }

        /**
         * Populates the student monthly fees table based on the selected month.
         * Adds click handlers to rows for detailed view.
         * @param {Object} data The processed financial data.
         * @param {string} selectedMonth The month to display, or 'all' for all months.
         */
        function populateStudentFeesTable(data, selectedMonth) {
            const tableContainer = document.getElementById('studentFeesTable');
            tableContainer.innerHTML = getStudentFeesTableHtml(data, selectedMonth);

            // Add click event listeners to the newly created rows
            tableContainer.querySelectorAll('tr[data-student-id]').forEach(row => {
                row.addEventListener('click', (event) => {
                    const studentId = event.currentTarget.dataset.studentId;
                    const month = event.currentTarget.dataset.month;
                    showStudentDetailsModal(studentId, month);
                });
            });
        }

        /**
         * Generates the HTML table for office staff expenses.
         * This function is now reusable for display and PDF generation.
         * @param {Object} data The processed financial data.
         * @param {string} selectedMonth The month to display, or 'all' for all months.
         * @returns {string} The HTML string for the office staff expenses table.
         */
        function getOfficeStaffTableHtml(data, selectedMonth) {
            const detailedLogData = data.detailedLogData;
            const officeStaffConfig = data.officeStaffConfig;
            const staffExpenses = {};
            let overallTotalStaffSalary = 0;
            let overallTotalStaffHours = 0; // Keep for console logging/internal use

            console.log(`--- Generating Office Staff Expenses Table for Month: ${selectedMonth} ---`);
            console.log("Office Staff Config:", officeStaffConfig);

            // Ensure officeStaffConfig is an object before iterating
            if (typeof officeStaffConfig !== 'object' || officeStaffConfig === null) {
                console.error("officeStaffConfig is not a valid object:", officeStaffConfig);
                return `<div class="overflow-x-auto"><h3 class="text-xl font-bold text-gray-800 mb-4">Office Staff Expenses</h3><table class="min-w-full bg-white rounded-lg shadow-md"><thead><tr class="bg-gray-100 text-left text-gray-600 uppercase text-sm leading-normal"><th class="py-3 px-6">Staff Role</th><th class="py-3 px-6">Hourly Rate (₹)</th><th class="py-3 px-6">Calculated Salary (₹)</th></tr></thead><tbody><tr><td colspan="3" class="py-3 px-6 text-center text-gray-500">Error: Office staff configuration data is missing or invalid.</td></tr></tbody></table></div>`;
            }


            for (const position in officeStaffConfig) {
                staffExpenses[position] = {
                    hourlyRate: parseFloat(officeStaffConfig[position].rate || 0),
                    totalHours: 0,
                    calculatedSalary: 0,
                    programs: officeStaffConfig[position].programs || [], // Ensure programs is an array
                    name: officeStaffConfig[position].name || position,
                    id: officeStaffConfig[position].id
                };
            }

            let filteredLogEntries = [];
            if (selectedMonth === 'all') {
                filteredLogEntries = detailedLogData;
            } else {
                filteredLogEntries = detailedLogData.filter(entry => entry.month === selectedMonth);
            }
            console.log("Filtered Log Entries for Office Staff:", filteredLogEntries);


            filteredLogEntries.forEach(entry => {
                const program = entry.program;
                for (const position in staffExpenses) {
                    const staffConfig = staffExpenses[position];
                    if (staffConfig.programs.length === 0 || staffConfig.programs.includes(program)) {
                        staffExpenses[position].totalHours += parseFloat(entry.classDurationHours || 0);
                    }
                }
            });

            let tableRowsHtml = '';
            let hasData = false;
            for (const position in staffExpenses) {
                const info = staffExpenses[position];
                info.calculatedSalary = info.totalHours * info.hourlyRate;
                
                tableRowsHtml += `
                    <tr class="border-b border-gray-200 hover:bg-gray-100 cursor-pointer" data-staff-position="${position}" data-month="${selectedMonth}">
                        <td class="py-3 px-6 whitespace-nowrap">${position} (${info.name})</td>
                        <td class="py-3 px-6 whitespace-nowrap">₹${info.hourlyRate.toFixed(2)}</td>
                        <td class="py-3 px-6 whitespace-nowrap">₹${info.calculatedSalary.toFixed(2)}</td>
                    </tr>
                `;
                if (info.totalHours > 0 || info.calculatedSalary > 0) { // Check if there's any activity
                    hasData = true;
                }
                overallTotalStaffSalary += info.calculatedSalary;
                overallTotalStaffHours += info.totalHours; // Accumulate overall hours
                console.log(`Office Staff (${position}): Hours: ${info.totalHours.toFixed(2)}, Salary: ${info.calculatedSalary.toFixed(2)}`);
            }

            if (!hasData) {
                tableRowsHtml = `<tr><td colspan="3" class="py-3 px-6 text-center text-gray-500">No office staff expense data for the selected month(s).</td></tr>`;
            }

            const title = selectedMonth === 'all' ? 'Overall Office Staff Expenses Report' : `Office Staff Expenses Report for ${selectedMonth}`;
            console.log(`Overall Office Staff Hours for ${selectedMonth}: ${overallTotalStaffHours.toFixed(2)}`);
            console.log(`Overall Office Staff Salary for ${selectedMonth}: ₹${overallTotalStaffSalary.toFixed(2)}`);


            return `
                <div class="overflow-x-auto">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">${title}</h3>
                    <table class="min-w-full bg-white rounded-lg shadow-md">
                        <thead>
                            <tr class="bg-gray-100 text-left text-gray-600 uppercase text-sm leading-normal">
                                <th class="py-3 px-6">Staff Role</th>
                                <th class="py-3 px-6">Hourly Rate (₹)</th>
                                <th class="py-3 px-6">Calculated Salary (₹)</th>
                            </tr>
                        </thead>
                        <tbody class="text-gray-700 text-sm font-light">
                            ${tableRowsHtml}
                        </tbody>
                        <tfoot>
                            <tr class="bg-gray-100 text-left text-gray-700 uppercase text-sm leading-normal font-bold">
                                <td class="py-3 px-6" colspan="2">Overall Sum:</td>
                                <td class="py-3 px-6">₹${overallTotalStaffSalary.toFixed(2)}</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            `;
        }

        /**
         * Populates the office staff expenses table.
         * @param {Object} data The processed financial data.
         * @param {string} selectedMonth The month to display, or 'all' for all months.
         */
        function populateOfficeStaffTable(data, selectedMonth) {
            const tableContainer = document.getElementById('officeStaffExpensesTable');
            tableContainer.innerHTML = getOfficeStaffTableHtml(data, selectedMonth);

            // Add click event listeners to the new rows
            tableContainer.querySelectorAll('tr[data-staff-position]').forEach(row => {
                row.addEventListener('click', (event) => {
                    const staffPosition = event.currentTarget.dataset.staffPosition;
                    const month = event.currentTarget.dataset.month;
                    showOfficeStaffDetailsModal(staffPosition, month);
                });
            });
        }


        /**
         * Shows the selected tab content and hides others.
         * @param {string} tabId The ID of the tab content to show.
         */
        function showTab(tabId) {
            // Hide all tab contents and remove active-fade-in class
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
                content.classList.remove('active-fade-in');
            });
            // Deactivate all tab buttons
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });

            // Show the selected tab content and add active-fade-in class
            const selectedContent = document.getElementById(tabId);
            if (selectedContent) {
                selectedContent.classList.remove('hidden');
                // Trigger reflow to ensure transition plays
                void selectedContent.offsetWidth;
                selectedContent.classList.add('active-fade-in');
            }

            // Activate the corresponding tab button
            const selectedButton = document.querySelector(`.tab-button[data-tab="${tabId}"]`);
            if (selectedButton) {
                selectedButton.classList.add('active');
            }

            // Update content based on current tab and selected month
            const selectedMonth = document.getElementById('monthSelect').value;
            if (dashboardData) {
                if (tabId === 'overview') {
                    updateSummary(dashboardData, selectedMonth); // Update summary for selected month
                    renderCharts(dashboardData, selectedMonth);
                    renderOverallCountsChart(dashboardData); // Render the new chart
                } else if (tabId === 'teacher-salaries') {
                    populateTeacherSalariesTable(dashboardData, selectedMonth);
                } else if (tabId === 'student-fees') {
                    populateStudentFeesTable(dashboardData, selectedMonth);
                } else if (tabId === 'office-staff-expenses') { // Handle new tab
                    populateOfficeStaffTable(dashboardData, selectedMonth);
                }
            }
        }

        /**
         * Shows a custom message box.
         * @param {string} title The title of the message box.
         * @param {string} message The message content.
         */
        function showMessageBox(title, message) {
            // Using the existing detailsModal for generic messages
            const modal = document.getElementById('detailsModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');
            const downloadButton = document.getElementById('downloadPdfButton');
            const generateEmailButton = document.getElementById('generateEmailButton'); // Get the email button

            modalTitle.textContent = title;
            modalBody.innerHTML = `<p>${message}</p>`;
            downloadButton.classList.add('hidden'); // Hide download button for generic messages
            generateEmailButton.classList.add('hidden'); // Hide email button for generic messages
            modal.classList.add('show');
        }

        /**
         * Closes a specified modal.
         * @param {string} modalId The ID of the modal to close.
         */
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }

        /**
         * Displays a modal with detailed class information for a specific teacher.
         * @param {string} teacherId The ID of the teacher.
         * @param {string} month The month (or 'all').
         */
        function showTeacherDetailsModal(teacherId, month) {
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');
            const downloadButton = document.getElementById('downloadPdfButton');
            const generateEmailButton = document.getElementById('generateEmailButton');
            
            let filteredClasses = [];
            if (month === 'all') {
                filteredClasses = dashboardData.detailedLogData.filter(entry => entry.staffId === teacherId);
            } else {
                filteredClasses = dashboardData.detailedLogData.filter(entry => entry.staffId === teacherId && entry.month === month);
            }

            if (filteredClasses.length === 0) {
                modalTitle.textContent = `Classes Taught by ${teacherId}`;
                modalBody.innerHTML = `<p>No detailed class data found for Teacher ID: ${teacherId} for ${month === 'all' ? 'all months' : month}.</p>`;
                downloadButton.classList.add('hidden');
                generateEmailButton.classList.add('hidden');
            } else {
                const teacherName = filteredClasses[0].teacherName;
                modalTitle.textContent = `Classes Taught by ${teacherId} (${teacherName})`;

                let totalSalaryForTeacher = 0;
                let totalHoursForTeacher = 0;
                const classDates = new Set(); // To store unique dates
                const studentBreakdownForEmail = {}; // To group classes by student for email

                // Sort filtered classes by date
                filteredClasses.sort((a, b) => new Date(a.date) - new Date(b.date));

                // Calculate totals for the modal header
                filteredClasses.forEach(entry => {
                    totalSalaryForTeacher += parseFloat(entry.teacherSalary || 0);
                    totalHoursForTeacher += parseFloat(entry.classDurationHours || 0);
                });

                let tableHtml = `
                    <div id="pdfContent" class="overflow-x-auto"> <!-- Added ID for PDF export -->
                        <h4 class="text-lg font-semibold mb-2">Details for ${teacherId} (${teacherName}) - ${month === 'all' ? 'All Months' : month}</h4>
                        <p class="text-md font-semibold mb-2">Overall Duration (Hours): ${totalHoursForTeacher.toFixed(2)}</p>
                        <table class="min-w-full bg-white rounded-lg shadow-md">
                            <thead>
                                <tr class="bg-gray-100 text-left text-gray-600 uppercase text-sm leading-normal">
                                    <th class="py-3 px-6">Date</th>
                                    <th class="py-3 px-6">Student ID (Name)</th>
                                    <th class="py-3 px-6">Classroom Name</th>
                                    <th class="py-3 px-6">Duration (Hours)</th>
                                    <th class="py-3 px-6">Salary/Hr (₹)</th>
                                    <th class="py-3 px-6">Total Salary (₹)</th>
                                </tr>
                            </thead>
                            <tbody class="text-gray-700 text-sm font-light">
                `;
                filteredClasses.forEach(entry => {
                    tableHtml += `
                        <tr class="border-b border-gray-200">
                            <td class="py-3 px-6 whitespace-nowrap">${new Date(entry.date).toLocaleDateString()}</td>
                            <td class="py-3 px-6 whitespace-nowrap">${entry.studentId} (${entry.studentName})</td>
                            <td class="py-3 px-6 whitespace-nowrap">${entry.classroomName}</td>
                            <td class="py-3 px-6 whitespace-nowrap">${parseFloat(entry.classDurationHours || 0).toFixed(2)}</td>
                            <td class="py-3 px-6 whitespace-nowrap">₹${parseFloat(entry.teacherSalaryPerHour || 0).toFixed(2)}</td>
                            <td class="py-3 px-6 whitespace-nowrap">₹${parseFloat(entry.teacherSalary || 0).toFixed(2)}</td>
                        </tr>
                    `;
                    classDates.add(new Date(entry.date).toLocaleDateString());

                    // Prepare data for email template: group by student
                    if (!studentBreakdownForEmail[entry.studentId]) {
                        studentBreakdownForEmail[entry.studentId] = {
                            name: entry.studentName,
                            totalHours: 0,
                            totalAmount: 0,
                            hourlyRate: parseFloat(entry.teacherSalaryPerHour || 0), // Assuming hourly rate is consistent per teacher
                            classes: []
                        };
                    }
                    studentBreakdownForEmail[entry.studentId].totalHours += parseFloat(entry.classDurationHours || 0);
                    studentBreakdownForEmail[entry.studentId].totalAmount += parseFloat(entry.teacherSalary || 0);
                    studentBreakdownForEmail[entry.studentId].classes.push({
                        date: new Date(entry.date).toLocaleDateString(),
                        program: entry.program,
                        classroom: entry.classroomName,
                        subject: entry.classroomName, // Using classroomName as subject for consistency
                        durationMinutes: entry.classDurationMinutes
                    });
                });
                tableHtml += `
                            </tbody>
                            <tfoot>
                                <tr class="bg-gray-100 text-left text-gray-700 uppercase text-sm leading-normal font-bold">
                                    <td class="py-3 px-6" colspan="3">Totals for ${teacherName} (${month === 'all' ? 'Overall' : month}):</td>
                                    <td class="py-3 px-6">Hours: ${totalHoursForTeacher.toFixed(2)}</td>
                                    <td class="py-3 px-6" colspan="1"></td>
                                    <td class="py-3 px-6">Salary: ₹${totalSalaryForTeacher.toFixed(2)}</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                `;
                modalBody.innerHTML = tableHtml;
                downloadButton.classList.remove('hidden');
                generateEmailButton.classList.remove('hidden');

                currentEmailData = {
                    type: 'teacher',
                    name: teacherName,
                    id: teacherId, // Add teacher ID
                    month: month,
                    totalSalary: totalSalaryForTeacher,
                    totalHours: totalHoursForTeacher,
                    classDates: Array.from(classDates).join(', '),
                    studentBreakdown: studentBreakdownForEmail // Pass the grouped data
                };
            }
            document.getElementById('detailsModal').classList.add('show');
        }

        /**
         * Displays a modal with detailed class information for a specific student.
         * @param {string} studentId The ID of the student.
         * @param {string} month The month (or 'all').
         */
        function showStudentDetailsModal(studentId, month) {
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');
            const downloadButton = document.getElementById('downloadPdfButton');
            const generateEmailButton = document.getElementById('generateEmailButton');
            
            let filteredClasses = [];
            if (month === 'all') {
                filteredClasses = dashboardData.detailedLogData.filter(entry => entry.studentId === studentId);
            } else {
                filteredClasses = dashboardData.detailedLogData.filter(entry => entry.studentId === studentId && entry.month === month);
            }

            if (filteredClasses.length === 0) {
                modalTitle.textContent = `Classes Attended by ${studentId}`;
                modalBody.innerHTML = `<p>No detailed class data found for Student ID: ${studentId} for ${month === 'all' ? 'all months' : month}.</p>`;
                downloadButton.classList.add('hidden');
                generateEmailButton.classList.add('hidden');
            } else {
                const studentName = filteredClasses[0].studentName;
                modalTitle.textContent = `Classes Attended by ${studentId} (${studentName})`;

                let totalFeeForStudent = 0;
                let totalHoursForStudent = 0;
                const classDates = new Set(); // To store unique dates
                const teacherBreakdownForEmail = {}; // To group classes by teacher for email

                filteredClasses.sort((a, b) => new Date(a.date) - new Date(b.date));

                // Calculate totals for the modal header
                filteredClasses.forEach(entry => {
                    totalFeeForStudent += parseFloat(entry.studentFee || 0);
                    totalHoursForStudent += parseFloat(entry.classDurationHours || 0);
                });

                let tableHtml = `
                    <div id="pdfContent" class="overflow-x-auto"> <!-- Added ID for PDF export -->
                        <h4 class="text-lg font-semibold mb-2">Details for ${studentId} (${studentName}) - ${month === 'all' ? 'All Months' : month}</h4>
                        <p class="text-md font-semibold mb-2">Overall Duration (Hours): ${totalHoursForStudent.toFixed(2)}</p>
                        <table class="min-w-full bg-white rounded-lg shadow-md">
                            <thead>
                                <tr class="bg-gray-100 text-left text-gray-600 uppercase text-sm leading-normal">
                                    <th class="py-3 px-6">Date</th>
                                    <th class="py-3 px-6">Teacher ID (Name)</th>
                                    <th class="py-3 px-6">Classroom Name</th>
                                    <th class="py-3 px-6">Duration (Hours)</th>
                                    <th class="py-3 px-6">Fee/Hr (₹)</th>
                                    <th class="py-3 px-6">Total Fee (₹)</th>
                                </tr>
                            </thead>
                            <tbody class="text-gray-700 text-sm font-light">
                `;
                filteredClasses.forEach(entry => {
                    tableHtml += `
                        <tr class="border-b border-gray-200">
                            <td class="py-3 px-6 whitespace-nowrap">${new Date(entry.date).toLocaleDateString()}</td>
                            <td class="py-3 px-6 whitespace-nowrap">${entry.staffId} (${entry.teacherName})</td>
                            <td class="py-3 px-6 whitespace-nowrap">${entry.classroomName}</td>
                            <td class="py-3 px-6 whitespace-nowrap">${parseFloat(entry.classDurationHours || 0).toFixed(2)}</td>
                            <td class="py-3 px-6 whitespace-nowrap">₹${parseFloat(entry.studentFeePerHour || 0).toFixed(2)}</td>
                            <td class="py-3 px-6 whitespace-nowrap">₹${parseFloat(entry.studentFee || 0).toFixed(2)}</td>
                        </tr>
                    `;
                    classDates.add(new Date(entry.date).toLocaleDateString());

                    // Prepare data for email template: group by teacher
                    if (!teacherBreakdownForEmail[entry.staffId]) {
                        teacherBreakdownForEmail[entry.staffId] = {
                            name: entry.teacherName,
                            totalHours: 0,
                            totalAmount: 0,
                            hourlyRate: parseFloat(entry.studentFeePerHour || 0), // Student's fee rate for this teacher
                            classes: []
                        };
                    }
                    teacherBreakdownForEmail[entry.staffId].totalHours += parseFloat(entry.classDurationHours || 0);
                    teacherBreakdownForEmail[entry.staffId].totalAmount += parseFloat(entry.studentFee || 0);
                    teacherBreakdownForEmail[entry.staffId].classes.push({
                        date: new Date(entry.date).toLocaleDateString(),
                        program: entry.program,
                        classroom: entry.classroomName,
                        subject: entry.classroomName, // Using classroomName as subject for consistency
                        durationMinutes: entry.classDurationMinutes
                    });
                });
                tableHtml += `
                            </tbody>
                            <tfoot>
                                <tr class="bg-gray-100 text-left text-gray-700 uppercase text-sm leading-normal font-bold">
                                    <td class="py-3 px-6" colspan="3">Totals for ${studentName} (${month === 'all' ? 'Overall' : month}):</td>
                                    <td class="py-3 px-6">Hours: ${totalHoursForStudent.toFixed(2)}</td>
                                    <td class="py-3 px-6" colspan="1"></td>
                                    <td class="py-3 px-6">Fee: ₹${totalFeeForStudent.toFixed(2)}</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                `;
                modalBody.innerHTML = tableHtml;
                downloadButton.classList.remove('hidden');
                generateEmailButton.classList.remove('hidden');

                currentEmailData = {
                    type: 'student',
                    name: studentName,
                    id: studentId, // Add student ID
                    month: month,
                    totalFee: totalFeeForStudent,
                    totalHours: totalHoursForStudent,
                    classDates: Array.from(classDates).join(', '),
                    teacherBreakdown: teacherBreakdownForEmail // Pass the grouped data
                };
            }
            document.getElementById('detailsModal').classList.add('show');
        }

        /**
         * Displays a modal with detailed breakdown for a specific office staff role.
         * @param {string} staffPosition The position of the office staff (e.g., 'MD').
         * @param {string} month The month (or 'all').
         */
        function showOfficeStaffDetailsModal(staffPosition, month) {
            const modal = document.getElementById('officeStaffDetailsModal');
            const modalTitle = document.getElementById('officeStaffModalTitle');
            const modalBody = document.getElementById('officeStaffModalBody');
            const downloadButton = document.getElementById('downloadOfficeStaffPdfButton');
            const generateEmailButton = document.getElementById('generateOfficeStaffEmailButton');

            const officeStaffConfig = dashboardData.officeStaffConfig[staffPosition];
            if (!officeStaffConfig) {
                modalTitle.textContent = `Details for ${staffPosition}`;
                modalBody.innerHTML = `<p>Configuration for ${staffPosition} not found.</p>`;
                downloadButton.classList.add('hidden');
                generateEmailButton.classList.add('hidden');
                modal.classList.add('show');
                return;
            }

            const staffName = officeStaffConfig.name || staffPosition;
            const staffId = officeStaffConfig.id || 'N/A'; // Get ID for office staff
            modalTitle.textContent = `Detailed Expenses for ${staffPosition} (${staffName})`;

            let filteredLogEntries = [];
            if (month === 'all') {
                filteredLogEntries = dashboardData.detailedLogData;
            } else {
                filteredLogEntries = dashboardData.detailedLogData.filter(entry => entry.month === month); // Corrected to use 'month' parameter
            }

            const teacherContributions = {};
            let totalHoursForRole = 0;
            let totalSalaryForRole = 0;
            const classDatesForRole = new Set();

            filteredLogEntries.forEach(entry => {
                const program = entry.program;
                // Check if the class's program is relevant to this staff position
                if (officeStaffConfig.programs.length === 0 || officeStaffConfig.programs.includes(program)) {
                    const teacherId = entry.staffId;
                    const teacherName = entry.teacherName;
                    const classDurationHours = parseFloat(entry.classDurationHours || 0);

                    if (!teacherContributions[teacherId]) {
                        teacherContributions[teacherId] = {
                            name: teacherName,
                            id: teacherId, // Include teacher ID
                            hours: 0,
                            salaryContribution: 0,
                            classDates: new Set()
                        };
                    }
                    teacherContributions[teacherId].hours += classDurationHours;
                    teacherContributions[teacherId].salaryContribution += (classDurationHours * parseFloat(officeStaffConfig.rate || 0));
                    teacherContributions[teacherId].classDates.add(new Date(entry.date).toLocaleDateString());

                    totalHoursForRole += classDurationHours;
                    classDatesForRole.add(new Date(entry.date).toLocaleDateString());
                }
            });
            totalSalaryForRole = totalHoursForRole * parseFloat(officeStaffConfig.rate || 0);


            let tableHtml = `
                <div id="pdfOfficeStaffContent" class="overflow-x-auto">
                    <h4 class="text-lg font-semibold mb-2">Contribution Breakdown by Teacher for ${staffName} - ${month === 'all' ? 'All Months' : month}</h4>
                    <p class="text-md font-semibold mb-2">Overall Duration (Hours): ${totalHoursForRole.toFixed(2)}</p>
                    <table class="min-w-full bg-white rounded-lg shadow-md">
                        <thead>
                            <tr class="bg-gray-100 text-left text-gray-600 uppercase text-sm leading-normal">
                                <th class="py-3 px-6">Teacher ID (Name)</th>
                                <th class="py-3 px-6">Hours Contributed</th>
                                <th class="py-3 px-6">Calculated Salary (₹)</th>
                            </tr>
                        </thead>
                        <tbody class="text-gray-700 text-sm font-light">
            `;
            const sortedTeacherIds = Object.keys(teacherContributions).sort();
            const teacherContributionsForEmail = []; // For detailed email content

            if (sortedTeacherIds.length > 0) {
                sortedTeacherIds.forEach(teacherId => {
                    const teacherInfo = teacherContributions[teacherId];
                    tableHtml += `
                        <tr class="border-b border-gray-200">
                            <td class="py-3 px-6 whitespace-nowrap">${teacherId} (${teacherInfo.name})</td>
                            <td class="py-3 px-6 whitespace-nowrap">${teacherInfo.hours.toFixed(2)}</td>
                            <td class="py-3 px-6 whitespace-nowrap">₹${teacherInfo.salaryContribution.toFixed(2)}</td>
                        </tr>
                    `;
                    teacherContributionsForEmail.push({
                        teacherName: teacherInfo.name,
                        teacherId: teacherInfo.id, // Add teacher ID
                        hoursContributed: teacherInfo.hours.toFixed(2),
                        salaryContribution: teacherInfo.salaryContribution.toFixed(2)
                    });
                });
            } else {
                tableRowsHtml += `
                    <tr>
                        <td colspan="3" class="py-3 px-6 text-center text-gray-500">No teacher contributions found for this staff role and month.</td>
                    </tr>
                `;
            }
            tableHtml += `
                        </tbody>
                        <tfoot>
                            <tr class="bg-gray-100 text-left text-gray-700 uppercase text-sm leading-normal font-bold">
                                <td class="py-3 px-6">Total for ${staffName} (${month === 'all' ? 'Overall' : month}):</td>
                                <td class="py-3 px-6">Hours: ${totalHoursForRole.toFixed(2)}</td>
                                <td class="py-3 px-6">Salary: ₹${totalSalaryForRole.toFixed(2)}</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            `;
            modalBody.innerHTML = tableHtml;
            downloadButton.classList.remove('hidden');
            generateEmailButton.classList.remove('hidden');

            currentEmailData = {
                type: 'officeStaff',
                name: staffName,
                id: staffId, // Add office staff ID
                position: staffPosition,
                month: month,
                totalSalary: totalSalaryForRole,
                totalHours: totalHoursForRole,
                classDates: Array.from(classDatesForRole).join(', '),
                teacherContributions: teacherContributionsForEmail,
                officeStaffHourlyRate: parseFloat(officeStaffConfig.rate || 0).toFixed(2) // Include office staff's own hourly rate
            };
            modal.classList.add('show');
        }


        /**
         * Generates and displays the email content in the email preview modal.
         */
        function showEmailModal() {
            const emailModal = document.getElementById('emailModal');
            const emailContentPreview = document.getElementById('emailContentPreview');
            let emailMessage = "";
            const currentMonthYear = document.getElementById('monthSelect').value === 'all' ? 'Overall' : document.getElementById('monthSelect').value;

            if (currentEmailData.type === 'teacher') {
                emailMessage = `Teacher Salary Details - ${currentEmailData.name} (ID: ${currentEmailData.id})\n`;
                emailMessage += `Overall Total Hours for Teacher: ${currentEmailData.totalHours.toFixed(2)}\n\n`;
                
                if (Object.keys(currentEmailData.studentBreakdown).length > 0) {
                    emailMessage += `Detailed Breakdown by Student:\n`;
                    for (const studentId in currentEmailData.studentBreakdown) {
                        const studentInfo = currentEmailData.studentBreakdown[studentId];
                        emailMessage += `--- Student: ${studentInfo.name} (ID: ${studentId}) ---\n`;
                        emailMessage += `  Total Hours for this Student: ${studentInfo.totalHours.toFixed(2)}\n`;
                        emailMessage += `  Hourly Rate for this Student: ₹${studentInfo.hourlyRate.toFixed(2)}\n`;
                        emailMessage += `  Total Amount for this Student: ₹${studentInfo.totalAmount.toFixed(2)}\n`;
                        if (studentInfo.classes.length > 0) {
                            emailMessage += `    Classes Taught to this Student:\n`;
                            studentInfo.classes.forEach(c => {
                                emailMessage += `      - Date: ${c.date}, Program: ${c.program}, Classroom: ${c.classroom}, Subject: ${c.subject}, Duration: ${c.durationMinutes} minutes\n`;
                            });
                        }
                        emailMessage += `\n`;
                    }
                }

                emailMessage += `--------------------------------------\n`;
                emailMessage += `Teacher's Grand Total Amount: ₹${currentEmailData.totalSalary.toFixed(2)}\n`;
                emailMessage += `--------------------------------------\n\n`;
                emailMessage += `Kindly confirm whether the salary details mentioned above are accurate.\n\n`;
                emailMessage += `Best regards,\nAlif Edu Accounts Team`;

            } else if (currentEmailData.type === 'student') {
                emailMessage = `Student Fee Details - ${currentEmailData.name} (ID: ${currentEmailData.id})\n`;
                emailMessage += `Overall Total Hours for Student: ${currentEmailData.totalHours.toFixed(2)}\n\n`;

                if (Object.keys(currentEmailData.teacherBreakdown).length > 0) {
                    emailMessage += `Detailed Breakdown by Teacher:\n`;
                    for (const teacherId in currentEmailData.teacherBreakdown) {
                        const teacherInfo = currentEmailData.teacherBreakdown[teacherId];
                        emailMessage += `--- Teacher: ${teacherInfo.name} (ID: ${teacherId}) ---\n`;
                        emailMessage += `  Total Hours with this Teacher: ${teacherInfo.totalHours.toFixed(2)}\n`;
                        emailMessage += `  Hourly Rate for this Teacher: ₹${teacherInfo.hourlyRate.toFixed(2)}\n`;
                        emailMessage += `  Total Amount for this Teacher: ₹${teacherInfo.totalAmount.toFixed(2)}\n`;
                        if (teacherInfo.classes.length > 0) {
                            emailMessage += `    Classes Attended with this Teacher:\n`;
                            teacherInfo.classes.forEach(c => {
                                emailMessage += `      - Date: ${c.date}, Program: ${c.program}, Classroom: ${c.classroom}, Subject: ${c.subject}, Duration: ${c.durationMinutes} minutes\n`;
                            });
                        }
                        emailMessage += `\n`;
                    }
                }

                emailMessage += `--------------------------------------\n`;
                emailMessage += `Student's Grand Total Amount: ₹${currentEmailData.totalFee.toFixed(2)}\n`;
                emailMessage += `--------------------------------------\n\n`;
                emailMessage += `Kindly confirm whether the fee details mentioned above are accurate.\n\n`;
                emailMessage += `Best regards,\nAlif Edu Accounts Team`;

            } else if (currentEmailData.type === 'officeStaff') {
                emailMessage = `Teacher Salary Details - ${currentEmailData.name} (ID: ${currentEmailData.id})\n`; // Using "Teacher Salary Details" as per template
                emailMessage += `Overall Total Hours for ${currentEmailData.position}: ${currentEmailData.totalHours.toFixed(2)}\n\n`;

                if (currentEmailData.teacherContributions && currentEmailData.teacherContributions.length > 0) {
                    emailMessage += `Detailed Breakdown of Other Teachers:\n`;
                    currentEmailData.teacherContributions.forEach(tc => {
                        emailMessage += `--- Role: Teacher, Name: ${tc.teacherName} (ID: ${tc.teacherId}) ---\n`;
                        emailMessage += `  Total Hours: ${tc.hoursContributed}\n`;
                        emailMessage += `  Hourly Rate: ₹${currentEmailData.officeStaffHourlyRate}\n`; // Office staff's rate
                        emailMessage += `  Total Amount: ₹${tc.salaryContribution}\n\n`;
                    });
                }

                emailMessage += `--------------------------------------\n`;
                emailMessage += `Teacher's Grand Total Amount: ₹${currentEmailData.totalSalary.toFixed(2)}\n`; // Office staff's total salary
                emailMessage += `--------------------------------------\n\n`;
                emailMessage += `Kindly confirm whether the salary details mentioned above are accurate.\n\n`;
                emailMessage += `Best regards,\nAlif Edu Accounts Team`;
            }

            emailContentPreview.textContent = emailMessage;
            emailModal.classList.add('show');
        }

        /**
         * Copies the email content from the preview modal to the clipboard.
         */
        function copyEmailToClipboard() {
            const emailContentPreview = document.getElementById('emailContentPreview');
            const textToCopy = emailContentPreview.textContent;

            // Use document.execCommand('copy') for better compatibility in iframes
            const textArea = document.createElement('textarea');
            textArea.value = textToCopy;
            textArea.style.position = 'fixed'; // Avoid scrolling to bottom
            textArea.style.left = '-9999px'; // Hide element
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();

            try {
                const successful = document.execCommand('copy');
                const msg = successful ? 'Copied to clipboard!' : 'Failed to copy.';
                showMessageBox('Copy Status', msg); // Use the existing message box for feedback
            } catch (err) {
                console.error('Failed to copy text: ', err);
                showMessageBox('Copy Error', 'Failed to copy email to clipboard. Please try manually.');
            } finally {
                document.body.removeChild(textArea);
            }
            closeModal('emailModal'); // Close email preview after copy attempt
        }


        /**
         * Downloads the content of a specified HTML element as a PDF.
         * @param {string} elementId The ID of the HTML element to convert to PDF.
         * @param {string} filenamePrefix A prefix for the downloaded PDF filename.
         */
        async function downloadElementAsPdf(elementId, filenamePrefix) {
            const element = document.getElementById(elementId);
            if (!element) {
                console.error("Element not found for PDF download:", elementId);
                showMessageBox("PDF Error", "Could not find content to download for PDF.");
                return;
            }

            const filename = `${filenamePrefix.replace(/[^a-zA-Z0-9]/g, '_')}_Report.pdf`;

            // Declare originalStyles outside the try block
            let originalStyles = {
                overflowX: element.style.overflowX,
                width: element.style.width,
                padding: element.style.padding
            };
            
            // Temporarily adjust styles for better PDF capture
            element.style.overflowX = 'visible';
            element.style.width = 'fit-content'; 
            element.style.padding = '20px'; // Add some padding for PDF margins

            try {
                const canvas = await html2canvas(element, { 
                    scale: 2, // Increase scale for better resolution
                    logging: true, // Enable logging for debugging
                    useCORS: true, // Important for images, though not directly used here
                    allowTaint: true // Allow capturing content from different origins (e.g., charts)
                });

                const imgData = canvas.toDataURL('image/png');
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4'); // 'p' for portrait, 'mm' for millimeters, 'a4' size

                const imgWidth = 210; // A4 width in mm (210mm)
                const pageHeight = 297; // A4 height in mm (297mm)
                const imgHeight = canvas.height * imgWidth / canvas.width;
                let heightLeft = imgHeight;

                let position = 0;

                pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;

                while (heightLeft >= 0) {
                    position = heightLeft - imgHeight;
                    pdf.addPage();
                    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }

                pdf.save(filename);
            } catch (error) {
                console.error("Error generating PDF:", error);
                showMessageBox("PDF Generation Error", "Failed to generate PDF. Please try again. Error: " + error.message);
            } finally {
                // Ensure styles are reverted even if an error occurs
                element.style.overflowX = originalStyles.overflowX;
                element.style.width = originalStyles.width;
                element.style.padding = originalStyles.padding;
            }
        }

        /**
         * Downloads the content of a modal body as a PDF.
         * This function is specifically for modal content that has a designated 'pdfContent' ID.
         * @param {string} modalId The ID of the modal whose content needs to be downloaded.
         */
        async function downloadModalContentAsPdf(modalId) {
            let elementToCaptureId;
            let filenamePrefix;

            if (modalId === 'detailsModal') {
                elementToCaptureId = 'pdfContent';
                filenamePrefix = document.getElementById('modalTitle').textContent;
            } else if (modalId === 'officeStaffDetailsModal') {
                elementToCaptureId = 'pdfOfficeStaffContent';
                filenamePrefix = document.getElementById('officeStaffModalTitle').textContent;
            } else {
                console.error("Invalid modal ID for PDF download:", modalId);
                showMessageBox("PDF Error", "Could not find content to download for PDF.");
                return;
            }
            await downloadElementAsPdf(elementToCaptureId, filenamePrefix);
        }

        /**
         * Downloads the entire overview section as a PDF.
         */
        async function downloadOverallReportAsPdf() {
            if (!dashboardData) {
                showMessageBox("Data Error", "Dashboard data is not loaded yet. Please wait or refresh.");
                return;
            }
            const selectedMonth = document.getElementById('monthSelect').value;
            const monthText = selectedMonth === 'all' ? 'Overall' : selectedMonth;
            await downloadElementAsPdf('overview', `School_Financial_Report_${monthText}`);
        }

        /**
         * Generates the HTML table for combined staff (teachers and office staff).
         * @param {Object} data The processed financial data.
         * @param {string} selectedMonth The month to display, or 'all' for all months.
         * @returns {string} The HTML string for the combined staff table.
         */
        function getCombinedStaffTableHtml(data, selectedMonth) {
            let combinedStaffData = [];
            let overallGrandTotalHours = 0;
            let overallGrandTotalAmount = 0;
            let officeStaffExpenses = {}; // Initialize staffExpenses here

            console.log(`--- Generating Combined Staff Table for Month: ${selectedMonth} ---`);

            // --- Process Teachers ---
            if (selectedMonth === 'all') {
                const yearlyTeacherTotals = {};
                data.detailedLogData.forEach(entry => {
                    if (entry.staffId) {
                        const teacherId = entry.staffId;
                        if (!yearlyTeacherTotals[teacherId]) {
                            yearlyTeacherTotals[teacherId] = {
                                name: entry.teacherName,
                                totalSalary: 0,
                                totalHours: 0
                            };
                        }
                        yearlyTeacherTotals[teacherId].totalSalary += parseFloat(entry.teacherSalary || 0);
                        yearlyTeacherTotals[teacherId].totalHours += parseFloat(entry.classDurationHours || 0);
                    }
                });
                for (const teacherId in yearlyTeacherTotals) {
                    const info = yearlyTeacherTotals[teacherId];
                    combinedStaffData.push({
                        type: 'Teacher',
                        id: teacherId,
                        name: info.name,
                        duration: info.totalHours,
                        amount: info.totalSalary
                    });
                    console.log(`Combined - Teacher (All Months): ${info.name}, Hours: ${info.totalHours.toFixed(2)}, Salary: ${info.totalSalary.toFixed(2)}`);
                }
            } else { // Specific month selected
                const teachers = data.monthlyData[selectedMonth] ? data.monthlyData[selectedMonth].teachers : {};
                for (const teacherId in teachers) {
                    const info = teachers[teacherId];
                    combinedStaffData.push({
                        type: 'Teacher',
                        id: teacherId,
                        name: info.name,
                        duration: parseFloat(info.totalHours || 0),
                        amount: parseFloat(info.totalSalary || 0)
                    });
                    console.log(`Combined - Teacher (${selectedMonth}): ${info.name}, Hours: ${parseFloat(info.totalHours || 0).toFixed(2)}, Salary: ${parseFloat(info.totalSalary || 0).toFixed(2)}`);
                }
            }

            // --- Process Office Staff ---
            const officeStaffConfig = data.officeStaffConfig;
            
            // Populate officeStaffExpenses if config is valid
            if (typeof officeStaffConfig === 'object' && officeStaffConfig !== null) {
                for (const position in officeStaffConfig) {
                    officeStaffExpenses[position] = {
                        hourlyRate: parseFloat(officeStaffConfig[position].rate || 0),
                        totalHours: 0,
                        calculatedSalary: 0,
                        programs: officeStaffConfig[position].programs || [],
                        name: officeStaffConfig[position].name || position,
                        id: officeStaffConfig[position].id || position
                    };
                }

                let filteredLogEntries = [];
                if (selectedMonth === 'all') {
                    filteredLogEntries = data.detailedLogData;
                } else {
                    filteredLogEntries = data.detailedLogData.filter(entry => entry.month === selectedMonth);
                }

                filteredLogEntries.forEach(entry => {
                    const program = entry.program;
                    for (const position in officeStaffExpenses) {
                        const staffConfig = officeStaffExpenses[position];
                        if (staffConfig.programs.length === 0 || staffConfig.programs.includes(program)) {
                            staffConfig.totalHours += parseFloat(entry.classDurationHours || 0);
                        }
                    }
                });

                // Now iterate over the populated officeStaffExpenses to add to combinedStaffData
                for (const position in officeStaffExpenses) {
                    const info = officeStaffExpenses[position];
                    info.calculatedSalary = info.totalHours * info.hourlyRate;
                    if (info.totalHours > 0 || info.calculatedSalary > 0) {
                        combinedStaffData.push({
                            type: 'Office Staff',
                            id: info.id,
                            name: info.name,
                            duration: info.totalHours,
                            amount: info.calculatedSalary
                        });
                        console.log(`Combined - Office Staff (${info.name}): Hours: ${info.totalHours.toFixed(2)}, Salary: ${info.calculatedSalary.toFixed(2)}`);
                    }
                }
            } else {
                console.warn("officeStaffConfig is missing or invalid, skipping office staff expenses in combined report.");
            }

            // Sort combined data by type, then by name
            combinedStaffData.sort((a, b) => {
                if (a.type === b.type) {
                    return a.name.localeCompare(b.name);
                }
                return a.type.localeCompare(b.type);
            });

            let tableRowsHtml = '';
            let hasData = combinedStaffData.length > 0;

            combinedStaffData.forEach(item => {
                tableRowsHtml += `
                    <tr class="border-b border-gray-200">
                        <td class="py-3 px-6 whitespace-nowrap">${item.type}</td>
                        <td class="py-3 px-6 whitespace-nowrap">${item.id} (${item.name})</td>
                        <td class="py-3 px-6 whitespace-nowrap">${item.duration.toFixed(2)}</td>
                        <td class="py-3 px-6 whitespace-nowrap">₹${item.amount.toFixed(2)}</td>
                    </tr>
                `;
                overallGrandTotalHours += item.duration;
                overallGrandTotalAmount += item.amount;
            });

            if (!hasData) {
                tableRowsHtml = `<tr><td colspan="4" class="py-3 px-6 text-center text-gray-500">No combined staff data for the selected month(s).</td></tr>`;
            }

            const title = selectedMonth === 'all' ? 'Overall Combined Salaries & Expenses Report' : `Combined Salaries & Expenses Report for ${selectedMonth}`;
            console.log(`Overall Combined Hours for ${selectedMonth}: ${overallGrandTotalHours.toFixed(2)}`);
            console.log(`Overall Combined Amount for ${selectedMonth}: ₹${overallGrandTotalAmount.toFixed(2)}`);


            return `
                <div class="overflow-x-auto">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">${title}</h3>
                    <table class="min-w-full bg-white rounded-lg shadow-md">
                        <thead>
                            <tr class="bg-gray-100 text-left text-gray-600 uppercase text-sm leading-normal">
                                <th class="py-3 px-6">Type</th>
                                <th class="py-3 px-6">ID (Name/Role)</th>
                                <th class="py-3 px-6">Overall Duration (Hours)</th>
                                <th class="py-3 px-6">Total Amount (₹)</th>
                            </tr>
                        </thead>
                        <tbody class="text-gray-700 text-sm font-light">
                            ${tableRowsHtml}
                        </tbody>
                        <tfoot>
                            <tr class="bg-gray-100 text-left text-gray-700 uppercase text-sm leading-normal font-bold">
                                <td class="py-3 px-6" colspan="2">Overall Grand Total:</td>
                                <td class="py-3 px-6">${overallGrandTotalHours.toFixed(2)}</td>
                                <td class="py-3 px-6">₹${overallGrandTotalAmount.toFixed(2)}</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            `;
        }


        /**
         * Generates and downloads a combined PDF for Teacher Salaries and Office Staff Expenses.
         */
        async function downloadCombinedSalariesExpensesReport() {
            if (!dashboardData) {
                showMessageBox("Data Error", "Dashboard data is not loaded yet. Please wait or refresh.");
                return;
            }

            const selectedMonth = document.getElementById('monthSelect').value;
            const monthText = selectedMonth === 'all' ? 'Overall' : selectedMonth;

            const combinedPdfContentDiv = document.getElementById('combinedPdfContent');
            combinedPdfContentDiv.innerHTML = getCombinedStaffTableHtml(dashboardData, selectedMonth);

            await downloadElementAsPdf('combinedPdfContent', `Combined_Salaries_Expenses_Report_${monthText}`);
        }


        /**
         * Initializes the dashboard by fetching data and rendering all components.
         */
        async function initializeDashboard() {
            dashboardData = await fetchData(); // Store fetched data
            if (dashboardData) {
                populateMonthSelect(dashboardData.monthlyData); // Populate month dropdown first
                
                // Add event listener for month selection change
                document.getElementById('monthSelect').addEventListener('change', (event) => {
                    const selectedMonth = event.target.value;
                    const currentTab = document.querySelector('.tab-button.active').dataset.tab;
                    showTab(currentTab); // Re-render current tab with new month
                });

                // Add event listener for the new overall download button
                document.getElementById('downloadOverallReportButton').addEventListener('click', downloadOverallReportAsPdf);

                // Add event listener for the new combined salaries & expenses report button
                document.getElementById('downloadCombinedSalariesExpensesButton').addEventListener('click', downloadCombinedSalariesExpensesReport);


                // Add event listeners for the new monthly report download buttons
                document.getElementById('downloadTeacherSalariesPdfButton').addEventListener('click', () => {
                    const selectedMonth = document.getElementById('monthSelect').value;
                    const monthText = selectedMonth === 'all' ? 'Overall' : selectedMonth;
                    downloadElementAsPdf('teacherSalariesTable', `Teacher_Salaries_Report_${monthText}`);
                });

                document.getElementById('downloadStudentFeesPdfButton').addEventListener('click', () => {
                    const selectedMonth = document.getElementById('monthSelect').value;
                    const monthText = selectedMonth === 'all' ? 'Overall' : selectedMonth;
                    downloadElementAsPdf('studentFeesTable', `Student_Fees_Report_${monthText}`);
                });

                document.getElementById('downloadOfficeStaffExpensesPdfButton').addEventListener('click', () => {
                    const selectedMonth = document.getElementById('monthSelect').value;
                    const monthText = selectedMonth === 'all' ? 'Overall' : selectedMonth;
                    downloadElementAsPdf('officeStaffExpensesTable', `Office_Staff_Expenses_Report_${monthText}`);
                });


                // Show the default tab (Overview)
                showTab('overview'); // This will call updateSummary and renderCharts with 'all' initially
            }
        }

        // Add event listeners for tab buttons
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', (event) => {
                    const tabId = event.target.dataset.tab;
                    showTab(tabId);
                });
            });
            initializeDashboard();
        });
    </script>
</body>
</html>
