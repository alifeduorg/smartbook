<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>School Financial Dashboard</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>
    <!-- jsPDF and html2canvas CDNs for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* Very light blue-gray background */
        }
        .container {
            max-width: 1200px;
        }
        .card {
            background-color: #ffffff;
            border-radius: 16px; /* Slightly more rounded corners */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* More pronounced shadow for depth */
            transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out; /* Smooth transitions */
        }
        .card:hover {
            transform: translateY(-5px) scale(1.01); /* Subtle lift and slight scale on hover */
            box-shadow: 0 15px 20px -5px rgba(0, 0, 0, 0.15), 0 6px 8px -3px rgba(0, 0, 0, 0.08); /* Deeper shadow on hover */
        }
        .chart-container {
            position: relative;
            height: 400px; /* Fixed height for charts */
            width: 100%;
        }
        /* Custom scrollbar for overflow content */
        .overflow-x-auto::-webkit-scrollbar {
            height: 8px;
        }
        .overflow-x-auto::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .overflow-x-auto::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        .overflow-x-auto::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        /* Tab styling */
        .tab-button {
            padding: 12px 24px;
            border-radius: 10px; /* Slightly more rounded */
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease-in-out; /* Smooth transitions */
            background-color: #e0e7ff; /* Light indigo */
            color: #4338ca; /* Darker indigo text */
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        .tab-button:hover {
            background-color: #c7d2fe; /* Lighter indigo on hover */
            transform: translateY(-2px); /* Subtle lift */
        }
        .tab-button.active {
            background-color: #4f46e5; /* Stronger indigo */
            color: #ffffff;
            box-shadow: 0 4px 10px rgba(79, 70, 229, 0.4); /* More prominent shadow */
            transform: translateY(-2px); /* Keep lifted when active */
        }

        /* Fade-in animation for tab content */
        .tab-content {
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.5s ease-out, transform 0.5s ease-out;
        }
        .tab-content.active-fade-in {
            opacity: 1;
            transform: translateY(0);
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }
        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background-color: #ffffff;
            padding: 2rem;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
            transform: scale(0.9);
            transition: transform 0.3s ease-in-out;
        }
        .modal-overlay.show .modal-content {
            transform: scale(1);
        }
        .modal-close-button {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6b7280;
        }
        .modal-close-button:hover {
            color: #1f2937;
        }
        .download-button {
            background-color: #10b981; /* Emerald green */
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease-in-out, transform 0.2s ease-in-out;
            margin-top: 1rem;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        .download-button:hover {
            background-color: #059669; /* Darker green */
            transform: translateY(-1px);
        }
    </style>
</head>
<body class="p-4 sm:p-6 md:p-8">
    <div class="container mx-auto">
        <h1 class="text-3xl sm:text-4xl font-bold text-gray-800 mb-8 text-center">School Financial Dashboard</h1>

        <!-- Loading Spinner -->
        <div id="loadingSpinner" class="fixed inset-0 bg-gray-200 bg-opacity-75 flex items-center justify-center z-50 hidden">
            <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-500"></div>
            <p class="ml-4 text-lg text-gray-700">Loading data...</p>
        </div>

        <!-- Navigation Tabs -->
        <div class="flex flex-wrap justify-center gap-4 mb-8">
            <button class="tab-button active" data-tab="overview">Overview</button>
            <button class="tab-button" data-tab="teacher-salaries">Teacher Monthly Salaries</button>
            <button class="tab-button" data-tab="student-fees">Student Monthly Fees</button>
        </div>

        <!-- Month Selection Dropdown -->
        <div class="flex justify-center mb-8">
            <label for="monthSelect" class="block text-lg font-medium text-gray-700 mr-4 self-center">Select Month:</label>
            <select id="monthSelect" class="mt-1 block w-auto pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md shadow-sm">
                <!-- Options will be populated by JavaScript -->
            </select>
        </div>

        <!-- Overview Section (Summary Cards & Monthly Charts) -->
        <div id="overview" class="tab-content">
            <!-- Summary Cards -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="card p-6 text-center">
                    <h2 class="text-xl font-semibold text-gray-600 mb-2">Total Earnings</h2>
                    <p id="totalEarnings" class="text-3xl font-bold text-green-600">₹0.00</p>
                </div>
                <div class="card p-6 text-center">
                    <h2 class="text-xl font-semibold text-gray-600 mb-2">Total Expenditure</h2>
                    <p id="totalExpenditure" class="text-3xl font-bold text-red-600">₹0.00</p>
                </div>
                <div class="card p-6 text-center">
                    <h2 class="text-xl font-semibold text-gray-600 mb-2">Net Profit</h2>
                    <p id="netProfit" class="text-3xl font-bold text-blue-600">₹0.00</p>
                </div>
            </div>

            <!-- Monthly Charts Section -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                <!-- Monthly Profit Chart -->
                <div class="card p-6">
                    <h2 class="text-2xl font-semibold text-gray-700 mb-4">Monthly Profit Chart</h2>
                    <div class="chart-container">
                        <canvas id="monthlyProfitChart"></canvas>
                    </div>
                </div>

                <!-- Monthly Teacher Salary Chart -->
                <div class="card p-6">
                    <h2 class="text-2xl font-semibold text-gray-700 mb-4">Monthly Teacher Salary Chart</h2>
                    <div class="chart-container">
                        <canvas id="monthlyTeacherSalaryChart"></canvas>
                    </div>
                </div>

                <!-- Monthly Student Fee Chart -->
                <div class="card p-6">
                    <h2 class="text-2xl font-semibold text-gray-700 mb-4">Monthly Student Fee Chart</h2>
                    <div class="chart-container">
                        <canvas id="monthlyStudentFeeChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Teacher Monthly Salaries Section -->
        <div id="teacher-salaries" class="tab-content hidden">
            <div class="card p-6">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">Teacher Monthly Salaries</h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white rounded-lg shadow-md">
                        <thead>
                            <tr class="bg-gray-100 text-left text-gray-600 uppercase text-sm leading-normal">
                                <th class="py-3 px-6">Month</th>
                                <th class="py-3 px-6">Teacher ID (Name)</th>
                                <th class="py-3 px-6">Salary</th>
                            </tr>
                        </thead>
                        <tbody id="teacherSalariesTableBody" class="text-gray-700 text-sm font-light">
                            <!-- Data will be inserted here by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Student Monthly Fees Section -->
        <div id="student-fees" class="tab-content hidden">
            <div class="card p-6">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">Student Monthly Fees</h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white rounded-lg shadow-md">
                        <thead>
                            <tr class="bg-gray-100 text-left text-gray-600 uppercase text-sm leading-normal">
                                <th class="py-3 px-6">Month</th>
                                <th class="py-3 px-6">Student ID (Name)</th>
                                <th class="py-3 px-6">Fee</th>
                            </tr>
                        </thead>
                        <tbody id="studentFeesTableBody" class="text-gray-700 text-sm font-light">
                            <!-- Data will be inserted here by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Teacher/Student Details Modal -->
    <div id="detailsModal" class="modal-overlay">
        <div class="modal-content relative">
            <button class="modal-close-button" onclick="closeModal()">&times;</button>
            <h3 id="modalTitle" class="text-2xl font-bold text-gray-800 mb-4">Details</h3>
            <div id="modalBody" class="text-gray-700">
                <!-- Details will be loaded here -->
            </div>
            <button id="downloadPdfButton" class="download-button hidden" onclick="downloadModalContentAsPdf()">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                </svg>
                Download as PDF
            </button>
        </div>
    </div>

    <script>
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycby2i1vfoOPV8ey2p8hS1nXhPra0J27djweqbt-8G-uA1SfC9dkm9FZ4h_Q6k7u3wChf/exec';

        let monthlyProfitChart;
        let monthlyTeacherSalaryChart;
        let monthlyStudentFeeChart;

        let dashboardData = null; // Store fetched data globally
        let sortedMonths = []; // To store sorted month names

        /**
         * Fetches data from the Google Apps Script web app.
         * Shows a loading spinner during the fetch operation.
         * @returns {Promise<Object>} A promise that resolves with the fetched data.
         */
        async function fetchData() {
            const loadingSpinner = document.getElementById('loadingSpinner');
            loadingSpinner.classList.remove('hidden'); // Show spinner

            try {
                const response = await fetch(WEB_APP_URL);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                console.log("Fetched data:", data); // Log data for debugging
                return data;
            } catch (error) {
                console.error("Error fetching data:", error);
                // Use a custom message box instead of alert()
                showMessageBox("Error", "Failed to load data. Please check the web app URL and script deployment. Error: " + error.message);
                return null;
            } finally {
                loadingSpinner.classList.add('hidden'); // Hide spinner
            }
        }

        /**
         * Sorts months chronologically.
         * @param {Array<string>} monthsArray The array of month names.
         * @returns {Array<string>} The sorted array of month names.
         */
        function sortMonthsChronologically(monthsArray) {
            const monthOrder = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            return monthsArray.sort((a, b) => monthOrder.indexOf(a) - monthOrder.indexOf(b));
        }

        /**
         * Populates the month selection dropdown.
         * @param {Object} monthlyData The monthly aggregated data.
         */
        function populateMonthSelect(monthlyData) {
            const monthSelect = document.getElementById('monthSelect');
            monthSelect.innerHTML = ''; // Clear existing options

            sortedMonths = sortMonthsChronologically(Object.keys(monthlyData));

            // Add "All Months" option
            const allMonthsOption = document.createElement('option');
            allMonthsOption.value = 'all';
            allMonthsOption.textContent = 'All Months';
            monthSelect.appendChild(allMonthsOption);

            sortedMonths.forEach(month => {
                const option = document.createElement('option');
                option.value = month;
                option.textContent = month;
                monthSelect.appendChild(option);
            });

            // Set default to "All Months" or the first month if no data
            if (sortedMonths.length > 0) {
                monthSelect.value = 'all'; // Default to 'All Months'
            }
        }

        /**
         * Renders the charts using Chart.js based on the selected month.
         * @param {Object} data The processed financial data.
         * @param {string} selectedMonth The month to display, or 'all' for all months.
         */
        function renderCharts(data, selectedMonth) {
            const monthlyData = data.monthlyData;
            let labels, totalMonthlySalaries, totalMonthlyFees, monthlyProfits;

            if (selectedMonth === 'all') {
                labels = sortedMonths;
                totalMonthlySalaries = sortedMonths.map(month => monthlyData[month].totalTeacherSalary);
                totalMonthlyFees = sortedMonths.map(month => monthlyData[month].totalStudentFee);
                monthlyProfits = sortedMonths.map(month => monthlyData[month].monthlyProfit);
            } else {
                labels = [selectedMonth];
                totalMonthlySalaries = [monthlyData[selectedMonth] ? monthlyData[selectedMonth].totalTeacherSalary : 0];
                totalMonthlyFees = [monthlyData[selectedMonth] ? monthlyData[selectedMonth].totalStudentFee : 0];
                monthlyProfits = [monthlyData[selectedMonth] ? monthlyData[selectedMonth].monthlyProfit : 0];
            }

            // Define a consistent color palette for charts
            const chartColors = {
                profitPositive: 'rgba(75, 192, 192, 0.7)', // Teal
                profitNegative: 'rgba(255, 99, 132, 0.7)', // Red
                teacherSalary: 'rgba(79, 70, 229, 0.7)', // Indigo
                studentFee: 'rgba(234, 179, 8, 0.7)',    // Amber
                borderColor: (color) => color.replace('0.7', '1') // Solid border
            };


            // Destroy existing charts if they exist to prevent re-rendering issues
            if (monthlyProfitChart) monthlyProfitChart.destroy();
            if (monthlyTeacherSalaryChart) monthlyTeacherSalaryChart.destroy();
            if (monthlyStudentFeeChart) monthlyStudentFeeChart.destroy();

            // Monthly Profit Chart
            const profitCtx = document.getElementById('monthlyProfitChart').getContext('2d');
            monthlyProfitChart = new Chart(profitCtx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Monthly Profit',
                        data: monthlyProfits,
                        backgroundColor: monthlyProfits.map(profit => profit >= 0 ? chartColors.profitPositive : chartColors.profitNegative),
                        borderColor: monthlyProfits.map(profit => profit >= 0 ? chartColors.borderColor(chartColors.profitPositive) : chartColors.borderColor(chartColors.profitNegative)),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: selectedMonth === 'all' ? 'Monthly Profit/Loss (All Months)' : `Profit/Loss for ${selectedMonth}`,
                            font: { size: 16 }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Amount (₹)'
                            }
                        }
                    }
                }
            });

            // Monthly Teacher Salary Chart
            const teacherSalaryCtx = document.getElementById('monthlyTeacherSalaryChart').getContext('2d');
            monthlyTeacherSalaryChart = new Chart(teacherSalaryCtx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Total Teacher Salary',
                        data: totalMonthlySalaries,
                        backgroundColor: chartColors.teacherSalary,
                        borderColor: chartColors.borderColor(chartColors.teacherSalary),
                        borderWidth: 2,
                        fill: false,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: selectedMonth === 'all' ? 'Total Monthly Teacher Salaries (All Months)' : `Total Teacher Salary for ${selectedMonth}`,
                            font: { size: 16 }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Amount (₹)'
                            }
                        }
                    }
                }
            });

            // Monthly Student Fee Chart
            const studentFeeCtx = document.getElementById('monthlyStudentFeeChart').getContext('2d');
            monthlyStudentFeeChart = new Chart(studentFeeCtx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Total Student Fees',
                        data: totalMonthlyFees,
                        backgroundColor: chartColors.studentFee,
                        borderColor: chartColors.borderColor(chartColors.studentFee),
                        borderWidth: 2,
                        fill: false,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: selectedMonth === 'all' ? 'Total Monthly Student Fees (All Months)' : `Total Student Fee for ${selectedMonth}`,
                            font: { size: 16 }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Amount (₹)'
                            }
                        }
                    }
                }
            });
        }

        /**
         * Updates the summary cards with yearly totals or selected month's totals.
         * @param {Object} data The processed financial data.
         * @param {string} selectedMonth The month to display, or 'all' for all months.
         */
        function updateSummary(data, selectedMonth) {
            let earnings, expenditure, profit;

            if (selectedMonth === 'all') {
                earnings = data.yearlyTotals.totalEarnings;
                expenditure = data.yearlyTotals.totalExpenditure;
                profit = data.yearlyTotals.netProfit;
            } else {
                const monthData = data.monthlyData[selectedMonth];
                earnings = monthData ? monthData.totalStudentFee : 0;
                expenditure = monthData ? monthData.totalTeacherSalary : 0;
                profit = monthData ? monthData.monthlyProfit : 0;
            }

            document.getElementById('totalEarnings').textContent = `₹${earnings.toFixed(2)}`;
            document.getElementById('totalExpenditure').textContent = `₹${expenditure.toFixed(2)}`;
            document.getElementById('netProfit').textContent = `₹${profit.toFixed(2)}`;

            // Apply color based on profit/loss
            const netProfitElement = document.getElementById('netProfit');
            if (profit >= 0) {
                netProfitElement.classList.remove('text-red-600');
                netProfitElement.classList.add('text-green-600');
            } else {
                netProfitElement.classList.remove('text-green-600');
                netProfitElement.classList.add('text-red-600');
            }
        }

        /**
         * Populates the teacher monthly salaries table based on the selected month.
         * Adds click handlers to rows for detailed view.
         * @param {Object} data The processed financial data.
         * @param {string} selectedMonth The month to display, or 'all' for all months.
         */
        function populateTeacherSalariesTable(data, selectedMonth) {
            const tableBody = document.getElementById('teacherSalariesTableBody');
            tableBody.innerHTML = ''; // Clear existing rows

            const monthlyData = data.monthlyData;
            let hasData = false;

            if (selectedMonth === 'all') {
                const yearlyTeacherTotals = {};
                sortedMonths.forEach(month => {
                    const teachersInMonth = monthlyData[month] ? monthlyData[month].teachers : {};
                    for (const teacherId in teachersInMonth) {
                        if (!yearlyTeacherTotals[teacherId]) {
                            yearlyTeacherTotals[teacherId] = {
                                name: teachersInMonth[teacherId].name,
                                totalSalary: 0
                            };
                        }
                        yearlyTeacherTotals[teacherId].totalSalary += teachersInMonth[teacherId].totalSalary;
                        hasData = true;
                    }
                });

                const sortedTeacherIds = Object.keys(yearlyTeacherTotals).sort();
                sortedTeacherIds.forEach(teacherId => {
                    const teacherInfo = yearlyTeacherTotals[teacherId];
                    const row = tableBody.insertRow();
                    row.classList.add('border-b', 'border-gray-200', 'hover:bg-gray-100', 'cursor-pointer'); // Add cursor-pointer
                    row.dataset.teacherId = teacherId; // Store teacher ID
                    row.dataset.month = selectedMonth; // Store 'all' for all months
                    row.innerHTML = `
                        <td class="py-3 px-6 whitespace-nowrap">All Months</td>
                        <td class="py-3 px-6 whitespace-nowrap">${teacherId} (${teacherInfo.name})</td>
                        <td class="py-3 px-6 whitespace-nowrap">₹${teacherInfo.totalSalary.toFixed(2)}</td>
                    `;
                });

            } else { // Specific month selected
                const month = selectedMonth;
                const teachers = monthlyData[month] ? monthlyData[month].teachers : {};
                const sortedTeacherIds = Object.keys(teachers).sort();

                if (sortedTeacherIds.length > 0) {
                    hasData = true;
                    sortedTeacherIds.forEach(teacherId => {
                        const teacherInfo = teachers[teacherId];
                        const row = tableBody.insertRow();
                        row.classList.add('border-b', 'border-gray-200', 'hover:bg-gray-100', 'cursor-pointer'); // Add cursor-pointer
                        row.dataset.teacherId = teacherId; // Store teacher ID
                        row.dataset.month = selectedMonth; // Store specific month
                        row.innerHTML = `
                            <td class="py-3 px-6 whitespace-nowrap">${month}</td>
                            <td class="py-3 px-6 whitespace-nowrap">${teacherId} (${teacherInfo.name})</td>
                            <td class="py-3 px-6 whitespace-nowrap">₹${teacherInfo.totalSalary.toFixed(2)}</td>
                        `;
                    });
                }
            }

            if (!hasData) {
                const row = tableBody.insertRow();
                row.classList.add('border-b', 'border-gray-200');
                row.innerHTML = `<td colspan="3" class="py-3 px-6 text-center text-gray-500">No teacher salary data for the selected month(s).</td>`;
            }

            // Add click event listeners to the newly created rows
            tableBody.querySelectorAll('tr[data-teacher-id]').forEach(row => {
                row.addEventListener('click', (event) => {
                    const teacherId = event.currentTarget.dataset.teacherId;
                    const month = event.currentTarget.dataset.month;
                    showTeacherDetailsModal(teacherId, month);
                });
            });
        }

        /**
         * Populates the student monthly fees table based on the selected month.
         * Adds click handlers to rows for detailed view.
         * @param {Object} data The processed financial data.
         * @param {string} selectedMonth The month to display, or 'all' for all months.
         */
        function populateStudentFeesTable(data, selectedMonth) {
            const tableBody = document.getElementById('studentFeesTableBody');
            tableBody.innerHTML = ''; // Clear existing rows

            const monthlyData = data.monthlyData;
            let hasData = false;

            if (selectedMonth === 'all') {
                const yearlyStudentTotals = {};
                sortedMonths.forEach(month => {
                    const studentsInMonth = monthlyData[month] ? monthlyData[month].students : {};
                    for (const studentId in studentsInMonth) {
                        if (!yearlyStudentTotals[studentId]) {
                            yearlyStudentTotals[studentId] = {
                                name: studentsInMonth[studentId].name,
                                totalFee: 0
                            };
                        }
                        yearlyStudentTotals[studentId].totalFee += studentsInMonth[studentId].totalFee;
                        hasData = true;
                    }
                });

                const sortedStudentIds = Object.keys(yearlyStudentTotals).sort();
                sortedStudentIds.forEach(studentId => {
                    const studentInfo = yearlyStudentTotals[studentId];
                    const row = tableBody.insertRow();
                    row.classList.add('border-b', 'border-gray-200', 'hover:bg-gray-100', 'cursor-pointer'); // Add cursor-pointer
                    row.dataset.studentId = studentId; // Store student ID
                    row.dataset.month = selectedMonth; // Store 'all' for all months
                    row.innerHTML = `
                        <td class="py-3 px-6 whitespace-nowrap">All Months</td>
                        <td class="py-3 px-6 whitespace-nowrap">${studentId} (${studentInfo.name})</td>
                        <td class="py-3 px-6 whitespace-nowrap">₹${studentInfo.totalFee.toFixed(2)}</td>
                    `;
                });

            } else { // Specific month selected
                const month = selectedMonth;
                const students = monthlyData[month] ? monthlyData[month].students : {};
                const sortedStudentIds = Object.keys(students).sort();

                if (sortedStudentIds.length > 0) {
                    hasData = true;
                    sortedStudentIds.forEach(studentId => {
                        const studentInfo = students[studentId];
                        const row = tableBody.insertRow();
                        row.classList.add('border-b', 'border-gray-200', 'hover:bg-gray-100', 'cursor-pointer'); // Add cursor-pointer
                        row.dataset.studentId = studentId; // Store student ID
                        row.dataset.month = selectedMonth; // Store specific month
                        row.innerHTML = `
                            <td class="py-3 px-6 whitespace-nowrap">${month}</td>
                            <td class="py-3 px-6 whitespace-nowrap">${studentId} (${studentInfo.name})</td>
                            <td class="py-3 px-6 whitespace-nowrap">₹${studentInfo.totalFee.toFixed(2)}</td>
                        `;
                    });
                }
            }

            if (!hasData) {
                const row = tableBody.insertRow();
                row.classList.add('border-b', 'border-gray-200');
                row.innerHTML = `<td colspan="3" class="py-3 px-6 text-center text-gray-500">No student fee data for the selected month(s).</td>`;
            }

            // Add click event listeners to the newly created rows
            tableBody.querySelectorAll('tr[data-student-id]').forEach(row => {
                row.addEventListener('click', (event) => {
                    const studentId = event.currentTarget.dataset.studentId;
                    const month = event.currentTarget.dataset.month;
                    showStudentDetailsModal(studentId, month);
                });
            });
        }

        /**
         * Shows the selected tab content and hides others.
         * @param {string} tabId The ID of the tab content to show.
         */
        function showTab(tabId) {
            // Hide all tab contents and remove active-fade-in class
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
                content.classList.remove('active-fade-in');
            });
            // Deactivate all tab buttons
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });

            // Show the selected tab content and add active-fade-in class
            const selectedContent = document.getElementById(tabId);
            if (selectedContent) {
                selectedContent.classList.remove('hidden');
                // Trigger reflow to ensure transition plays
                void selectedContent.offsetWidth;
                selectedContent.classList.add('active-fade-in');
            }

            // Activate the corresponding tab button
            const selectedButton = document.querySelector(`.tab-button[data-tab="${tabId}"]`);
            if (selectedButton) {
                selectedButton.classList.add('active');
            }

            // Update content based on current tab and selected month
            const selectedMonth = document.getElementById('monthSelect').value;
            if (dashboardData) {
                if (tabId === 'overview') {
                    updateSummary(dashboardData, selectedMonth); // Update summary for selected month
                    renderCharts(dashboardData, selectedMonth);
                } else if (tabId === 'teacher-salaries') {
                    populateTeacherSalariesTable(dashboardData, selectedMonth);
                } else if (tabId === 'student-fees') {
                    populateStudentFeesTable(dashboardData, selectedMonth);
                }
            }
        }

        /**
         * Shows a custom message box.
         * @param {string} title The title of the message box.
         * @param {string} message The message content.
         */
        function showMessageBox(title, message) {
            const modal = document.getElementById('detailsModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');
            const downloadButton = document.getElementById('downloadPdfButton');

            modalTitle.textContent = title;
            modalBody.innerHTML = `<p>${message}</p>`;
            downloadButton.classList.add('hidden'); // Hide download button for generic messages
            modal.classList.add('show');
        }

        /**
         * Closes the modal.
         */
        function closeModal() {
            document.getElementById('detailsModal').classList.remove('show');
        }

        /**
         * Displays a modal with detailed class information for a specific teacher.
         * @param {string} teacherId The ID of the teacher.
         * @param {string} month The month (or 'all').
         */
        function showTeacherDetailsModal(teacherId, month) {
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');
            const downloadButton = document.getElementById('downloadPdfButton');
            
            let filteredClasses = [];
            if (month === 'all') {
                filteredClasses = dashboardData.detailedLogData.filter(entry => entry.staffId === teacherId);
            } else {
                filteredClasses = dashboardData.detailedLogData.filter(entry => entry.staffId === teacherId && entry.month === month);
            }

            if (filteredClasses.length === 0) {
                modalTitle.textContent = `Classes Taught by ${teacherId}`;
                modalBody.innerHTML = `<p>No detailed class data found for Teacher ID: ${teacherId} for ${month === 'all' ? 'all months' : month}.</p>`;
                downloadButton.classList.add('hidden');
            } else {
                const teacherName = filteredClasses[0].teacherName; // Get name from first entry
                modalTitle.textContent = `Classes Taught by ${teacherId} (${teacherName})`;

                let tableHtml = `
                    <div id="pdfContent" class="overflow-x-auto"> <!-- Added ID for PDF export -->
                        <h4 class="text-lg font-semibold mb-2">Details for ${teacherId} (${teacherName}) - ${month === 'all' ? 'All Months' : month}</h4>
                        <table class="min-w-full bg-white rounded-lg shadow-md">
                            <thead>
                                <tr class="bg-gray-100 text-left text-gray-600 uppercase text-sm leading-normal">
                                    <th class="py-3 px-6">Date</th>
                                    <th class="py-3 px-6">Student ID (Name)</th>
                                    <th class="py-3 px-6">Subject</th>
                                    <th class="py-3 px-6">Duration (Hours)</th>
                                    <th class="py-3 px-6">Salary/Hr (₹)</th>
                                    <th class="py-3 px-6">Total Salary (₹)</th>
                                </tr>
                            </thead>
                            <tbody class="text-gray-700 text-sm font-light">
                `;
                let totalSalaryForTeacher = 0;

                filteredClasses.forEach(entry => {
                    tableHtml += `
                        <tr class="border-b border-gray-200">
                            <td class="py-3 px-6 whitespace-nowrap">${new Date(entry.date).toLocaleDateString()}</td>
                            <td class="py-3 px-6 whitespace-nowrap">${entry.studentId} (${entry.studentName})</td>
                            <td class="py-3 px-6 whitespace-nowrap">${entry.subject}</td>
                            <td class="py-3 px-6 whitespace-nowrap">${entry.classDurationHours.toFixed(2)}</td>
                            <td class="py-3 px-6 whitespace-nowrap">₹${entry.teacherSalaryPerHour.toFixed(2)}</td>
                            <td class="py-3 px-6 whitespace-nowrap">₹${entry.teacherSalary.toFixed(2)}</td>
                        </tr>
                    `;
                    totalSalaryForTeacher += entry.teacherSalary;
                });
                tableHtml += `
                            </tbody>
                            <tfoot>
                                <tr class="bg-gray-100 text-left text-gray-700 uppercase text-sm leading-normal font-bold">
                                    <td class="py-3 px-6" colspan="5">Total Salary for ${teacherName} (${month === 'all' ? 'All Months' : month}):</td>
                                    <td class="py-3 px-6">₹${totalSalaryForTeacher.toFixed(2)}</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                `;
                modalBody.innerHTML = tableHtml;
                downloadButton.classList.remove('hidden'); // Show download button
            }
            document.getElementById('detailsModal').classList.add('show');
        }

        /**
         * Displays a modal with detailed class information for a specific student.
         * @param {string} studentId The ID of the student.
         * @param {string} month The month (or 'all').
         */
        function showStudentDetailsModal(studentId, month) {
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');
            const downloadButton = document.getElementById('downloadPdfButton');
            
            let filteredClasses = [];
            if (month === 'all') {
                filteredClasses = dashboardData.detailedLogData.filter(entry => entry.studentId === studentId);
            } else {
                filteredClasses = dashboardData.detailedLogData.filter(entry => entry.studentId === studentId && entry.month === month);
            }

            if (filteredClasses.length === 0) {
                modalTitle.textContent = `Classes Attended by ${studentId}`;
                modalBody.innerHTML = `<p>No detailed class data found for Student ID: ${studentId} for ${month === 'all' ? 'all months' : month}.</p>`;
                downloadButton.classList.add('hidden');
            } else {
                const studentName = filteredClasses[0].studentName; // Get name from first entry
                modalTitle.textContent = `Classes Attended by ${studentId} (${studentName})`;

                let tableHtml = `
                    <div id="pdfContent" class="overflow-x-auto"> <!-- Added ID for PDF export -->
                        <h4 class="text-lg font-semibold mb-2">Details for ${studentId} (${studentName}) - ${month === 'all' ? 'All Months' : month}</h4>
                        <table class="min-w-full bg-white rounded-lg shadow-md">
                            <thead>
                                <tr class="bg-gray-100 text-left text-gray-600 uppercase text-sm leading-normal">
                                    <th class="py-3 px-6">Date</th>
                                    <th class="py-3 px-6">Teacher ID (Name)</th>
                                    <th class="py-3 px-6">Subject</th>
                                    <th class="py-3 px-6">Duration (Hours)</th>
                                    <th class="py-3 px-6">Fee/Hr (₹)</th>
                                    <th class="py-3 px-6">Total Fee (₹)</th>
                                </tr>
                            </thead>
                            <tbody class="text-gray-700 text-sm font-light">
                `;
                let totalFeeForStudent = 0;

                filteredClasses.forEach(entry => {
                    tableHtml += `
                        <tr class="border-b border-gray-200">
                            <td class="py-3 px-6 whitespace-nowrap">${new Date(entry.date).toLocaleDateString()}</td>
                            <td class="py-3 px-6 whitespace-nowrap">${entry.staffId} (${entry.teacherName})</td>
                            <td class="py-3 px-6 whitespace-nowrap">${entry.subject}</td>
                            <td class="py-3 px-6 whitespace-nowrap">${entry.classDurationHours.toFixed(2)}</td>
                            <td class="py-3 px-6 whitespace-nowrap">₹${entry.studentFeePerHour.toFixed(2)}</td>
                            <td class="py-3 px-6 whitespace-nowrap">₹${entry.studentFee.toFixed(2)}</td>
                        </tr>
                    `;
                    totalFeeForStudent += entry.studentFee;
                });
                tableHtml += `
                            </tbody>
                            <tfoot>
                                <tr class="bg-gray-100 text-left text-gray-700 uppercase text-sm leading-normal font-bold">
                                    <td class="py-3 px-6" colspan="5">Total Fee for ${studentName} (${month === 'all' ? 'All Months' : month}):</td>
                                    <td class="py-3 px-6">₹${totalFeeForStudent.toFixed(2)}</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                `;
                modalBody.innerHTML = tableHtml;
                downloadButton.classList.remove('hidden'); // Show download button
            }
            document.getElementById('detailsModal').classList.add('show');
        }

        /**
         * Downloads the content of the modal body as a PDF.
         */
        async function downloadModalContentAsPdf() {
            const element = document.getElementById('pdfContent'); // Element to convert to PDF
            const modalTitleText = document.getElementById('modalTitle').textContent;
            const filename = `${modalTitleText.replace(/[^a-zA-Z0-9]/g, '_')}_Details.pdf`;

            // Temporarily remove overflow-x-auto to ensure full table width is captured
            const originalOverflow = element.style.overflowX;
            element.style.overflowX = 'visible';
            element.style.width = 'fit-content'; // Ensure content is not truncated

            try {
                const canvas = await html2canvas(element, { 
                    scale: 2, // Increase scale for better resolution
                    logging: true, // Enable logging for debugging
                    useCORS: true // Important for images, though not directly used here
                });

                // Revert styles after canvas creation
                element.style.overflowX = originalOverflow;
                element.style.width = '';

                const imgData = canvas.toDataURL('image/png');
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4'); // 'p' for portrait, 'mm' for millimeters, 'a4' size

                const imgWidth = 210; // A4 width in mm (210mm)
                const pageHeight = 297; // A4 height in mm (297mm)
                const imgHeight = canvas.height * imgWidth / canvas.width;
                let heightLeft = imgHeight;

                let position = 0;

                pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;

                while (heightLeft >= 0) {
                    position = heightLeft - imgHeight;
                    pdf.addPage();
                    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }

                pdf.save(filename);
            } catch (error) {
                console.error("Error generating PDF:", error);
                showMessageBox("PDF Generation Error", "Failed to generate PDF. Please try again. Error: " + error.message);
            } finally {
                // Ensure styles are reverted even if an error occurs
                element.style.overflowX = originalOverflow;
                element.style.width = '';
            }
        }


        /**
         * Initializes the dashboard by fetching data and rendering all components.
         */
        async function initializeDashboard() {
            dashboardData = await fetchData(); // Store fetched data
            if (dashboardData) {
                populateMonthSelect(dashboardData.monthlyData); // Populate month dropdown first
                
                // Add event listener for month selection change
                document.getElementById('monthSelect').addEventListener('change', (event) => {
                    const selectedMonth = event.target.value;
                    const currentTab = document.querySelector('.tab-button.active').dataset.tab;
                    showTab(currentTab); // Re-render current tab with new month
                });

                // Show the default tab (Overview)
                showTab('overview'); // This will call updateSummary and renderCharts with 'all' initially
            }
        }

        // Add event listeners for tab buttons
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', (event) => {
                    const tabId = event.target.dataset.tab;
                    showTab(tabId);
                });
            });
            initializeDashboard();
        });
    </script>
</body>
</html>
