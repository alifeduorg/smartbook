<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Performance Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Define CSS Variables for consistent theming */
        :root {
            --primary-blue: #4A90E2; /* A friendly, accessible blue */
            --secondary-darkblue: #2F6F9D; /* A darker shade for accents */
            --accent-orange: #FF7043; /* A vibrant orange for highlights/buttons */
            --light-gray: #F0F2F5; /* A very light background gray */
            --mid-gray: #E0E5EC; /* Slightly darker background shade */
            --dark-text: #333; /* Standard dark text color */
            --light-text: #fff; /* White text for dark backgrounds */
            --border-radius: 12px; /* Consistent rounded corners */
            --box-shadow-light: 0 4px 15px rgba(0, 0, 0, 0.08); /* Subtle shadow */
            --box-shadow-medium: 0 8px 25px rgba(0, 0, 0, 0.12); /* More pronounced shadow */
            --box-shadow-hover: 0 12px 30px rgba(0, 0, 0, 0.15); /* Hover shadow */
        }

        body {
            margin: 0;
            padding: 20px; /* Reduced padding for better mobile fit */
            font-family: 'Poppins', sans-serif; /* Modern, friendly font */
            background: linear-gradient(135deg, var(--light-gray), var(--mid-gray)); /* Soft gradient background */
            color: var(--dark-text);
            min-height: 100vh; /* Full viewport height */
            display: flex;
            justify-content: center; /* Center content horizontally */
            align-items: flex-start; /* Align content to the top */
            overflow-x: hidden; /* Prevent horizontal scroll */
            position: relative; /* For background animations */
        }

        /* Background Animation - Subtle, floating shapes */
        body::before,
        body::after {
            content: '';
            position: absolute;
            background: rgba(255, 255, 255, 0.3); /* Translucent white for a dreamy effect */
            border-radius: 50%; /* Circular shapes */
            opacity: 0.6;
            filter: blur(80px); /* Soft blur */
            z-index: -1; /* Behind content */
        }

        body::before {
            width: 300px;
            height: 300px;
            top: -50px;
            left: -50px;
            animation: moveShape 15s infinite alternate ease-in-out; /* Slower animation */
        }

        body::after {
            width: 400px;
            height: 400px;
            bottom: -80px;
            right: -80px;
            animation: moveShape 20s infinite alternate-reverse ease-in-out; /* Different timing for variety */
        }

        @keyframes moveShape {
            0% {
                transform: translate(0, 0) scale(1);
            }
            25% {
                transform: translate(50px, -30px) scale(1.05);
            }
            50% {
                transform: translate(0, 50px) scale(0.95);
            }
            75% {
                transform: translate(-40px, -20px) scale(1.1);
            }
            100% {
                transform: translate(0, 0) scale(1);
            }
        }

        .main-container {
            background: rgba(255, 255, 255, 0.95); /* Slightly transparent white for glassmorphism */
            padding: 30px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow-medium);
            max-width: 1000px; /* Increased max-width for the main container */
            width: 100%; /* Full width on smaller screens */
            margin-top: 40px; /* Space from top */
            backdrop-filter: blur(10px); /* Glassmorphism effect */
            -webkit-backdrop-filter: blur(10px); /* For Safari */
            border: 1px solid rgba(255, 255, 255, 0.2); /* Subtle border */
        }

        h1 {
            color: var(--primary-blue);
            font-size: 2.2em;
            text-align: center;
            margin-bottom: 30px;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px; /* Space between icon and text */
        }

        h1 .icon {
            font-size: 1.2em; /* Larger icon */
            color: var(--accent-orange); /* Accent color for icon */
        }

        label {
            display: block;
            margin: 15px 0 8px;
            font-weight: 600;
            color: var(--dark-text);
            font-size: 0.95em;
        }

        input[type="text"],
        input[type="date"],
        select,
        textarea {
            padding: 12px 15px;
            border-radius: var(--border-radius);
            border: 1px solid #ddd; /* Light border */
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.05); /* Inner shadow for depth */
            font-size: 1em;
            margin-bottom: 15px;
            width: calc(100% - 30px); /* Adjust for padding */
            max-width: 100%; /* Ensure it doesn't exceed parent width */
            transition: all 0.3s ease; /* Smooth transitions */
            background-color: #fcfcfc; /* Slightly off-white background */
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: var(--primary-blue); /* Highlight on focus */
            box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.2); /* Glow effect */
        }

        /* Specific styles for the dropdowns to ensure text visibility */
        .modal-filter-select {
            min-height: 48px; /* Ensure sufficient height for text */
            font-size: 1rem; /* Base font size */
            line-height: 1.5; /* Ensure text sits well */
            padding: 0.75rem 1rem; /* Adjust padding as needed */
            width: 100%; /* Ensure they take full width in their column */
        }


        .custom-button {
            padding: 12px 25px;
            border-radius: var(--border-radius);
            border: none;
            color: var(--light-text);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease; /* Smooth transitions for all properties */
            font-size: 1em;
            box-shadow: var(--box-shadow-light);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px; /* Space between icon and text */
            flex-grow: 1; /* Allow buttons to grow */
            min-width: 120px; /* Minimum width for buttons */
        }

        .custom-button:hover {
            transform: translateY(-3px); /* Lift effect on hover */
            box-shadow: var(--box-shadow-medium);
        }

        .custom-button:active {
            transform: translateY(0); /* Press effect */
            box-shadow: var(--box-shadow-light);
        }

        /* Specific button styles */
        .search-button {
            background: linear-gradient(145deg, var(--primary-blue), var(--secondary-darkblue));
        }

        .reset-button {
            background: linear-gradient(145deg, #6c757d, #5a6268); /* Gray for reset */
        }

        .download-pdf-button {
            background: linear-gradient(145deg, #28a745, #218838); /* Green for PDF */
        }

        .download-jpeg-button {
            background: linear-gradient(145deg, #007bff, #0056b3); /* Blue for JPEG */
        }

        .copy-email-button {
            background: linear-gradient(145deg, var(--accent-orange), #E65100); /* Orange for copy */
        }

        .view-performance-button {
            background: linear-gradient(145deg, #6366f1, #4f46e5); /* Indigo for view */
        }

        /* Table styles */
        .table-container {
            overflow-x: auto;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow-light);
            margin-bottom: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background-color: var(--light-text);
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        thead th {
            background-color: var(--primary-blue);
            color: var(--light-text);
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.85em;
        }

        tbody tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        tbody tr:hover {
            background-color: #f0f8ff; /* Light blue on hover */
            transition: background-color 0.2s ease;
        }

        /* Modal styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7); /* Darker overlay */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .modal-overlay.visible {
            opacity: 1;
            visibility: visible;
        }

        .modal-content-inner {
            background: rgba(255, 255, 255, 0.98); /* Near opaque white for modal */
            padding: 30px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow-medium);
            max-width: 90%; /* Adjust modal width */
            width: 100%;
            transform: scale(0.9);
            transition: transform 0.3s ease;
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            position: relative;
            max-height: 90vh; /* Limit modal height to 90% of viewport height */
            overflow-y: auto; /* Enable vertical scrolling if content overflows */
        }

        .modal-overlay.visible .modal-content-inner {
            transform: scale(1);
        }

        .modal-close-button {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 2em;
            color: #666;
            cursor: pointer;
            transition: color 0.2s ease;
        }

        .modal-close-button:hover {
            color: #333;
        }

        /* Toast message for copy to clipboard */
        #copyToast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--secondary-darkblue); /* Use theme color */
            color: var(--light-text);
            padding: 10px 20px;
            border-radius: 8px;
            box-shadow: var(--box-shadow-medium);
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            z-index: 1001; /* Above modal */
        }
        #copyToast.show {
            opacity: 1;
        }

        /* Loading Spinner */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid var(--light-text);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block; /* Changed to inline-block */
            vertical-align: middle; /* Align with text */
            margin-right: 8px; /* Space between spinner and text */
        }

        .loading-indicator {
            display: flex; /* Use flexbox for centering */
            align-items: center; /* Vertically center */
            justify-content: center; /* Horizontally center */
            padding: 10px 0;
            color: #666;
            font-weight: 500;
        }
        .loading-indicator.hidden {
            display: none;
        }

        /* Download Message Box */
        #downloadMessage {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #fff;
            padding: 25px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow-medium);
            z-index: 1002;
            text-align: center;
            max-width: 350px;
            width: 90%;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
            border: 1px solid var(--primary-blue);
        }
        #downloadMessage.show {
            opacity: 1;
            visibility: visible;
        }
        #downloadMessage button {
            background-color: var(--primary-blue);
            color: var(--light-text);
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 15px;
            font-weight: 600;
            transition: background-color 0.2s ease;
        }
        #downloadMessage button:hover {
            background-color: var(--secondary-darkblue);
        }


        /* Responsive adjustments */
        @media (max-width: 768px) {
            body {
                padding: 15px;
                align-items: center; /* Center content vertically on smaller screens */
            }

            .main-container {
                margin-top: 20px;
                padding: 20px;
            }

            h1 {
                font-size: 1.8em;
                margin-bottom: 20px;
            }

            input[type="text"],
            input[type="date"],
            select,
            textarea {
                font-size: 0.95em;
                padding: 10px 12px;
            }

            .button-group {
                flex-direction: column; /* Stack buttons vertically */
                gap: 10px;
            }

            .custom-button {
                width: 100%; /* Full width buttons */
            }

            .modal-content-inner {
                padding: 20px;
                max-width: 95%;
            }

            .modal-filter-select {
                font-size: 0.9rem; /* Slightly smaller font on mobile */
                padding: 0.6rem 0.8rem;
            }
        }

        @media (max-width: 480px) {
            body {
                padding: 10px;
            }

            .main-container {
                margin-top: 10px;
                padding: 15px;
            }

            h1 {
                font-size: 1.6em;
            }
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body>

    <div class="main-container">
        <!-- Logo at the top center -->
        <!--
            ***************************************************************************************************
            IMPORTANT: To display your logo, you MUST replace "YOUR_ALIF_EDU_LOGO_PUBLIC_URL_HERE"
            with the actual public URL of your "alif edu (600 x 300 px) (820 x 312 px).png" image.
            This image needs to be hosted online (e.g., Google Drive, Imgur, your own web server)
            and accessible publicly via a direct URL.
            Example: If your image is hosted on Imgur, it might look like "https://i.imgur.com/yourlogo.png"
            The current error "Error loading image YOUR_ALIF_EDU_LOGO_PUBLIC_URL_HERE" means this placeholder
            URL has not been replaced with a valid, accessible image URL.
            ***************************************************************************************************
        -->
        <img src="YOUR_ALIF_EDU_LOGO_PUBLIC_URL_HERE"
             alt="alif edu (600 x 300 px) (820 x 312 px).png"
             class="block mx-auto mb-6 w-full max-w-xs sm:max-w-sm md:max-w-md lg:max-w-lg xl:max-w-xl h-auto"
             onerror="this.onerror=null;this.src='https://placehold.co/300x150/cccccc/000000?text=Alif+Edu+Logo+Not+Found';"
             >

        <h1><span class="icon">📊</span> Student Performance Dashboard</h1>

        <div class="mb-6 flex flex-col sm:flex-row items-center space-y-3 sm:space-y-0 sm:space-x-2">
            <input type="text" id="studentSearch" placeholder="Search by Student Name or ID..."
                   class="flex-grow w-full sm:w-auto px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-base">
            <button onclick="filterStudentTable()" class="custom-button search-button w-full sm:w-auto">
                <i class="fas fa-search"></i> Search
            </button>
            <button onclick="resetSearch()" class="custom-button reset-button w-full sm:w-auto">
                <i class="fas fa-redo"></i> Reset
            </button>
        </div>

        <div id="loadingIndicator" class="loading-indicator flex items-center justify-center py-10 text-gray-600 hidden">
            <div class="spinner mr-3"></div>
            <span>Loading student data...</span>
        </div>

        <div id="studentTableContainer" class="table-container hidden">
            <table class="min-w-full bg-white">
                <thead>
                    <tr>
                        <th class="py-3 px-4 rounded-tl-xl">Student Name</th>
                        <th class="py-3 px-4">Student ID</th>
                        <th class="py-3 px-4">Class</th>
                        <th class="py-3 px-4 text-center rounded-tr-xl">Action</th>
                    </tr>
                </thead>
                <tbody id="studentTableBody">
                </tbody>
            </table>
        </div>
        <div id="errorMessage" class="text-red-600 text-center py-4 hidden">
            Failed to load student data. Please ensure the Google Sheet URL is correct and the Apps Script is deployed.
        </div>
        <div id="noSearchResults" class="text-gray-500 text-center py-4 hidden">
            No students found matching your search.
        </div>
    </div>

    <div id="performanceModal" class="modal-overlay">
        <div class="modal-content-inner" id="modalContent">
            <button onclick="closeModal()" class="modal-close-button">
                &times;
            </button>

            <h2 id="modalStudentName" class="text-2xl font-bold text-indigo-700 mb-2"></h2>
            <p id="modalStudentId" class="text-gray-600 mb-6 text-lg"></p>

            <!-- Overall Performance Summary Card -->
            <div class="bg-blue-50 border border-blue-200 p-4 rounded-lg shadow-sm mb-6">
                <h3 class="text-xl font-bold text-blue-800 mb-2">Overall Performance Summary</h3>
                <p id="overallAveragePercentage" class="text-blue-700 text-lg font-semibold">Average %: --</p>
            </div>

            <div class="mb-6 grid grid-cols-1 sm:grid-cols-2 gap-4 download-hide-box">
                <div>
                    <label for="examTypeFilter" class="block text-gray-700 font-medium mb-1">Filter by Exam Type:</label>
                    <select id="examTypeFilter" class="block modal-filter-select border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 bg-white" style="width: 100%;" onchange="updatePerformanceView()">
                        <option value="all">All Exam Types</option>
                    </select>
                </div>
                <div>
                    <label for="subjectFilter" class="block text-gray-700 font-medium mb-1">Filter by Subject:</label>
                    <select id="subjectFilter" class="block modal-filter-select border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 bg-white" style="width: 100%;" onchange="updatePerformanceView()">
                        <option value="all">All Subjects</option>
                    </select>
                </div>
            </div>

            <div class="mb-6 grid grid-cols-1 sm:grid-cols-2 gap-4 download-hide-box">
                <div>
                    <label for="chartDataType" class="block text-gray-700 font-medium mb-1">Chart Data Type:</label>
                    <select id="chartDataType" class="block modal-filter-select border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 bg-white" onchange="updatePerformanceView()" style="width: 100%;">
                        <option value="percentage">%</option>
                        <option value="marks">Marks (Score)</option>
                    </select>
                </div>
                <div>
                    <label for="graphGrouping" class="block text-gray-700 font-medium mb-1">Group Graph By:</label>
                    <select id="graphGrouping" class="block modal-filter-select border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 bg-white" style="width: 100%;">
                        <option value="individual">Individual Exam Results</option>
                        <option value="subject_average">Average by Subject</option>
                        <option value="exam_type_average">Average by Exam Type</option>
                    </select>
                </div>
            </div>


            <h3 class="text-xl font-bold text-indigo-700 mb-3 mt-6">Detailed Exam Results</h3>
            <div class="overflow-x-auto rounded-xl shadow-md mb-6">
                <table class="min-w-full bg-white">
                    <thead>
                        <tr>
                            <th class="py-2 px-3 rounded-tl-xl">Timestamp</th>
                            <th class="py-2 px-3">Exam Type</th>
                            <th class="py-2 px-3">Subject</th>
                            <th class="py-2 px-3">Mark</th>
                            <th class="py-2 px-3">Out Of</th>
                            <th class="py-2 px-3">%</th>
                            <th class="py-2 px-3 rounded-tr-xl">Grade</th>
                        </tr>
                    </thead>
                    <tbody id="examDetailsTableBody">
                    </tbody>
                </table>
            </div>

            <h3 class="text-xl font-bold text-indigo-700 mb-3 mt-6">Performance Graph</h3>
            <!-- Removed max-h-96 from here to allow it to expand for download capture -->
            <div class="relative h-auto w-full mb-6">
                <canvas id="performanceChart"></canvas>
            </div>

            <!-- Class Teacher's Remarks/Suggestions -->
            <div class="mb-8 p-4 border border-gray-300 rounded-lg bg-gray-50">
                <h3 class="text-lg font-bold text-gray-800 mb-2">Class Teacher's Remarks/Suggestions:</h3>
                <textarea id="teacherRemarks"
                          class="w-full h-24 border border-gray-200 bg-white rounded-md p-3 text-sm text-gray-700 resize-y focus:ring-indigo-500 focus:border-indigo-500"
                          placeholder="Enter remarks or suggestions here..."></textarea>
                <p class="text-xs text-gray-500 mt-2">
                    (This section can be manually filled by the class teacher)
                </p>
            </div>

            <div class="flex justify-between items-end mt-8 pt-4 border-t border-gray-200">
                <div class="text-center w-1/2 pr-2">
                    <div class="h-16 border-b border-gray-400 mb-2"></div>
                    <p class="text-sm text-gray-700 font-semibold">Principal's Signature</p>
                </div>
                <div class="text-center w-1/2 pl-2">
                    <div class="h-16 border-b border-gray-400 mb-2"></div>
                    <p class="text-sm text-gray-700 font-semibold">Official Seal</p>
                </div>
            </div>

            <div class="button-group flex flex-col sm:flex-row justify-center gap-4 mt-6">
                <button onclick="downloadPdf()" class="custom-button download-pdf-button w-full sm:w-auto">
                    <i class="fas fa-file-pdf"></i> Download as PDF
                </button>
                <button onclick="downloadJpeg()" class="custom-button download-jpeg-button w-full sm:w-auto">
                    <i class="fas fa-image"></i> Download as JPEG
                </button>
                <button onclick="copyPerformanceSummary()" class="custom-button copy-email-button w-full sm:w-auto">
                    <i class="fas fa-copy"></i> Copy Summary for Email
                </button>
            </div>
        </div>
    </div>

    <!-- Toast message for copy to clipboard -->
    <div id="copyToast">
        Summary Copied to Clipboard!
    </div>

    <!-- Download Message Box -->
    <div id="downloadMessage" class="hidden">
        <p class="text-lg font-semibold mb-4">Download Issue</p>
        <p class="text-sm text-gray-700 mb-4">
            If the download did not start automatically, your browser might have blocked it.
            Please ensure pop-ups are allowed for this site, or try saving the image manually if it opened in a new tab.
        </p>
        <button onclick="hideDownloadMessage()">OK</button>
    </div>

    <script>
        // Your Google Apps Script Web App URL
        // IMPORTANT: Replace this with your actual deployed Google Apps Script Web App URL
        const googleSheetUrl = 'https://script.google.com/macros/s/AKfycbywWPjSBqVDI4z20NFjEtBeao4uvx9WOWf-MYNOqcfvV5W8utsUqv2-Df8oSVb7-eQ3lg/exec';

        let allStudentData = []; // This will be populated from the Google Sheet
        let currentChart = null; // To store the Chart.js instance
        let currentStudentRecords = []; // To store records of the currently viewed student

        /**
         * Cleans a string by replacing '+' with spaces and trimming.
         * @param {string} text - The input string.
         * @returns {string} The cleaned string.
         */
        function cleanText(text) {
            return text ? String(text).replace(/\+/g, ' ').trim() : '';
        }

        /**
         * Returns a shortened version of the exam name.
         * @param {string} examName - The full exam name.
         * @returns {string} The shortened exam name.
         */
        function getShortExamName(examName) {
            const mapping = {
                "Academic Test 1": "AT1",
                "Academic Test 2": "AT2",
                "Academic Test 3": "AT3",
                "Academic Test 4": "AT4",
                "Periodic Test 1": "PT1",
                "Periodic Test 2": "PT2",
                "Periodic Test 3": "PT3",
                "Periodic Test 4": "PT4",
                "Term 1": "T1",
                "Term 2": "T2",
                "Model Exam": "ME",
                "Admission Test": "Ad. Test",
                "Revision Test Series": "RTS"
            };
            return mapping[examName] || examName; // Return short form or original if not found
        }


        /**
         * Fetches student data from the Google Apps Script web app.
         */
        async function fetchStudentDataFromGoogleSheet() {
            const loadingIndicator = document.getElementById('loadingIndicator');
            const studentTableContainer = document.getElementById('studentTableContainer');
            const errorMessage = document.getElementById('errorMessage');

            loadingIndicator.classList.remove('hidden');
            studentTableContainer.classList.add('hidden');
            errorMessage.classList.add('hidden');
            document.getElementById('noSearchResults').classList.add('hidden'); // Hide no results on initial load

            try {
                const response = await fetch(googleSheetUrl);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();

                // Ensure data types are consistent for calculations (Mark, OutOf, Percentage)
                // Clean names here as well
                allStudentData = data.map(record => ({
                    ...record,
                    StudentName: cleanText(record.StudentName),
                    Examtype: cleanText(record.Examtype), // Clean Examtype
                    Subject: cleanText(record.Subject),   // Clean Subject
                    Mark: parseFloat(record.Mark),
                    OutOf: parseFloat(record.OutOf),
                    Percentage: parseFloat(record.Percentage)
                }));

                renderStudentTable(); // Render table after data is fetched
                studentTableContainer.classList.remove('hidden'); // Show the table
            } catch (error) {
                console.error('Error fetching data:', error);
                errorMessage.classList.remove('hidden'); // Show error message
            } finally {
                loadingIndicator.classList.add('hidden'); // Hide loading indicator
            }
        }

        /**
         * Renders the main student table with unique student entries.
         */
        function renderStudentTable(filteredStudents = null) {
            const tableBody = document.getElementById('studentTableBody');
            tableBody.innerHTML = ''; // Clear existing rows
            document.getElementById('noSearchResults').classList.add('hidden');

            const studentsToDisplay = filteredStudents || getUniqueStudents();

            if (studentsToDisplay.length === 0) {
                const message = filteredStudents ? 'No students found matching your search.' : 'No student data available. Please ensure your Google Sheet is populated and the Apps Script is correctly configured.';
                const row = tableBody.insertRow();
                const cell = row.insertCell();
                cell.colSpan = 4; // Span across all columns
                cell.className = 'py-4 px-4 text-center text-gray-500';
                cell.textContent = message;
                document.getElementById('noSearchResults').classList.remove('hidden'); // Show if no search results
                return;
            }

            studentsToDisplay.forEach(student => {
                const row = tableBody.insertRow();
                row.className = 'hover:bg-gray-50 transition-colors duration-200';

                // Student Name Cell - Cleaned
                let cell = row.insertCell();
                cell.className = 'py-3 px-4 whitespace-nowrap text-sm font-medium text-gray-900';
                cell.textContent = cleanText(student.StudentName);

                // Student ID Cell
                cell = row.insertCell();
                cell.className = 'py-3 px-4 whitespace-nowrap text-sm text-gray-700';
                cell.textContent = student.StudentID;

                // Class Cell
                cell = row.insertCell();
                cell.className = 'py-3 px-4 whitespace-nowrap text-sm text-gray-700';
                cell.textContent = student.Class;

                // Action (View) Button Cell
                cell = row.insertCell();
                cell.className = 'py-3 px-4 whitespace-nowrap text-center';
                const viewButton = document.createElement('button');
                viewButton.textContent = 'View Performance';
                viewButton.className = 'custom-button view-performance-button'; // Using the new custom button class
                viewButton.onclick = () => showStudentPerformance(student.StudentID);
                cell.appendChild(viewButton);
            });
        }

        /**
         * Extracts unique student information from allStudentData.
         * @returns {Array} An array of unique student objects.
         */
        function getUniqueStudents() {
            const uniqueStudentsMap = new Map();
            allStudentData.forEach(record => {
                if (!uniqueStudentsMap.has(record.StudentID)) {
                    uniqueStudentsMap.set(record.StudentID, {
                        StudentID: record.StudentID,
                        StudentName: cleanText(record.StudentName), // Ensure name is cleaned here too
                        Class: record.Class
                    });
                }
            });
            return Array.from(uniqueStudentsMap.values());
        }

        /**
         * Filters the student table based on search input.
         * This function is now explicitly called by the Search button or onkeyup.
         */
        function filterStudentTable() {
            const searchValue = document.getElementById('studentSearch').value.toLowerCase();
            const uniqueStudents = getUniqueStudents();
            const filteredStudents = uniqueStudents.filter(student =>
                cleanText(student.StudentName).toLowerCase().includes(searchValue) || // Clean name for search
                student.StudentID.toLowerCase().includes(searchValue)
            );
            renderStudentTable(filteredStudents);
        }

        /**
         * Resets the search bar and displays all students again.
         */
        function resetSearch() {
            document.getElementById('studentSearch').value = ''; // Clear search input
            renderStudentTable(getUniqueStudents()); // Re-render table with all unique students
        }

        /**
         * Displays the performance modal for a given student.
         * @param {string} studentId - The ID of the student to display.
         */
        function showStudentPerformance(studentId) {
            const modal = document.getElementById('performanceModal');
            const modalContent = document.getElementById('modalContent');
            const modalStudentName = document.getElementById('modalStudentName');
            const modalStudentId = document.getElementById('modalStudentId');
            const examTypeFilter = document.getElementById('examTypeFilter');
            const subjectFilter = document.getElementById('subjectFilter');
            const chartDataTypeFilter = document.getElementById('chartDataType');
            const graphGroupingFilter = document.getElementById('graphGrouping'); // New filter
            const overallAveragePercentage = document.getElementById('overallAveragePercentage');
            const teacherRemarks = document.getElementById('teacherRemarks'); // Get the textarea

            currentStudentRecords = allStudentData.filter(record => record.StudentID === studentId);

            if (currentStudentRecords.length === 0) {
                console.error('No records found for student ID:', studentId);
                return;
            }

            const uniqueExamTypes = [...new Set(currentStudentRecords.map(record => cleanText(record.Examtype)))].sort();
            const uniqueSubjects = [...new Set(currentStudentRecords.map(record => cleanText(record.Subject)))].sort();

            examTypeFilter.innerHTML = '<option value="all">All Exam Types</option>';
            uniqueExamTypes.forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type; // Use cleaned text
                examTypeFilter.appendChild(option);
            });

            subjectFilter.innerHTML = '<option value="all">All Subjects</option>';
            uniqueSubjects.forEach(subject => {
                const option = document.createElement('option');
                option.value = subject;
                option.textContent = subject; // Use cleaned text
                subjectFilter.appendChild(option);
            });

            // Reset filters to "all" and chart type to "percentage" when opening modal
            examTypeFilter.value = 'all';
            subjectFilter.value = 'all';
            chartDataTypeFilter.value = 'percentage';
            graphGroupingFilter.value = 'individual'; // Set default grouping
            teacherRemarks.value = ''; // Clear remarks when opening modal for a new student

            modalStudentName.textContent = `Performance for: ${cleanText(currentStudentRecords[0].StudentName)}`;
            modalStudentId.textContent = `Student ID: ${currentStudentRecords[0].StudentID} | Class: ${currentStudentRecords[0].Class}`;

            // Calculate and display overall average percentage
            const totalPercentage = currentStudentRecords.reduce((sum, record) => sum + record.Percentage, 0);
            const averagePercentage = currentStudentRecords.length > 0 ? (totalPercentage / currentStudentRecords.length).toFixed(2) : 'N/A';
            overallAveragePercentage.textContent = `Average %: ${averagePercentage}%`;


            updatePerformanceView();

            // Event listeners are now set directly in HTML for simplicity (onchange)
            // examTypeFilter.onchange = updatePerformanceView;
            // subjectFilter.onchange = updatePerformanceView;

            modal.classList.add('visible'); // Use the new modal visibility class
            setTimeout(() => {
                modalContent.classList.remove('scale-95', 'opacity-0');
                modalContent.classList.add('scale-100');
            }, 50);
        }

        /**
         * Closes the performance modal.
         */
        function closeModal() {
            const modal = document.getElementById('performanceModal');
            const modalContent = document.getElementById('modalContent');

            modalContent.classList.remove('scale-100');
            modalContent.classList.add('scale-95');
            setTimeout(() => {
                modal.classList.remove('visible'); // Use the new modal visibility class
                if (currentChart) {
                    currentChart.destroy();
                    currentChart = null;
                }
            }, 300);
        }

        /**
         * Renders or updates the student performance line chart and detailed exam table
         * based on selected filters and chart data type.
         */
        function updatePerformanceView() {
            const ctx = document.getElementById('performanceChart').getContext('2d');
            const examDetailsTableBody = document.getElementById('examDetailsTableBody');
            const examTypeFilter = document.getElementById('examTypeFilter');
            const subjectFilter = document.getElementById('subjectFilter');
            const chartDataType = document.getElementById('chartDataType').value; // Get selected chart data type
            const graphGrouping = document.getElementById('graphGrouping').value; // Get selected graph grouping

            examDetailsTableBody.innerHTML = '';

            const selectedExamType = examTypeFilter.value;
            const selectedSubject = subjectFilter.value;

            let filteredRecords = currentStudentRecords;
            if (selectedExamType !== 'all') {
                filteredRecords = filteredRecords.filter(record => cleanText(record.Examtype) === selectedExamType);
            }
            if (selectedSubject !== 'all') {
                filteredRecords = filteredRecords.filter(record => cleanText(record.Subject) === selectedSubject);
            }

            // Always sort by timestamp for the detailed table, regardless of graph grouping
            filteredRecords.sort((a, b) => new Date(a.Timestamp) - new Date(b.Timestamp));

            // --- Render Detailed Exam Table ---
            if (filteredRecords.length === 0) {
                const row = examDetailsTableBody.insertRow();
                const cell = row.insertCell();
                cell.colSpan = 7;
                cell.className = 'py-3 px-4 text-center text-gray-500';
                cell.textContent = 'No exam records found for the selected filters.';
            } else {
                filteredRecords.forEach(record => {
                    const row = examDetailsTableBody.insertRow();
                    row.className = 'hover:bg-gray-50 transition-colors duration-200';

                    let cell = row.insertCell();
                    cell.className = 'py-2 px-3 whitespace-nowrap text-sm text-gray-700';
                    cell.textContent = new Date(record.Timestamp).toLocaleDateString();

                    cell = row.insertCell();
                    cell.className = 'py-2 px-3 whitespace-nowrap text-sm text-gray-700';
                    cell.textContent = cleanText(record.Examtype);

                    cell = row.insertCell();
                    cell.className = 'py-2 px-3 whitespace-nowrap text-sm text-gray-700';
                    cell.textContent = cleanText(record.Subject);

                    cell = row.insertCell();
                    cell.className = 'py-2 px-3 whitespace-nowrap text-sm text-gray-700';
                    cell.textContent = record.Mark;

                    cell = row.insertCell();
                    cell.className = 'py-2 px-3 whitespace-nowrap text-sm text-gray-700';
                    cell.textContent = record.OutOf;

                    cell = row.insertCell();
                    cell.className = 'py-2 px-3 whitespace-nowrap text-sm text-gray-700';
                    cell.textContent = `${record.Percentage}%`;

                    cell = row.insertCell();
                    cell.className = 'py-2 px-3 whitespace-nowrap text-sm text-gray-700';
                    cell.textContent = record.Grade;
                });
            }


            // --- Prepare Chart Data based on Grouping ---
            let labels = [];
            let chartData = [];
            let yAxisLabel = '';
            let yAxisMax = 100;
            let yAxisCallback = function(value) { return value + '%'; };
            let tooltipCallback = function(context) { return `${context.dataset.label}: ${context.raw}%`; };

            if (chartDataType === 'percentage') {
                yAxisLabel = '%';
                yAxisMax = 100;
                yAxisCallback = function(value) { return value + '%'; };
                tooltipCallback = function(context) { return `${context.dataset.label}: ${context.raw}%`; };
            } else if (chartDataType === 'marks') {
                yAxisLabel = 'Marks (Score)';
                yAxisMax = Math.max(...filteredRecords.map(record => record.OutOf), 100);
                yAxisCallback = function(value) { return value; };
                tooltipCallback = function(context) {
                    const record = filteredRecords[context.dataIndex];
                    return `${context.dataset.label}: ${record.Mark} out of ${record.OutOf}`;
                };
            }

            if (graphGrouping === 'individual') {
                // Sort by timestamp for individual results
                filteredRecords.sort((a, b) => new Date(a.Timestamp) - new Date(b.Timestamp));
                labels = filteredRecords.map(record => {
                    const examType = getShortExamName(cleanText(record.Examtype));
                    const subject = cleanText(record.Subject);
                    const date = new Date(record.Timestamp).toLocaleDateString();
                    return `${examType} (${date}) - ${subject}`;
                });
                chartData = filteredRecords.map(record => chartDataType === 'percentage' ? record.Percentage : record.Mark);
            } else if (graphGrouping === 'subject_average') {
                const groupedBySubject = {};
                filteredRecords.forEach(record => {
                    const subject = cleanText(record.Subject);
                    if (!groupedBySubject[subject]) {
                        groupedBySubject[subject] = [];
                    }
                    groupedBySubject[subject].push(chartDataType === 'percentage' ? record.Percentage : record.Mark);
                });

                labels = Object.keys(groupedBySubject).sort();
                chartData = labels.map(subject => {
                    const sum = groupedBySubject[subject].reduce((acc, val) => acc + val, 0);
                    return sum / groupedBySubject[subject].length;
                });
                yAxisLabel = chartDataType === 'percentage' ? 'Average %' : 'Average Marks (Score)';
                tooltipCallback = function(context) {
                    const groupLabel = context.label;
                    const value = context.raw.toFixed(2); // Format average
                    return `Average for ${groupLabel}: ${value}${chartDataType === 'percentage' ? '%' : ''}`;
                };

            } else if (graphGrouping === 'exam_type_average') {
                const groupedByExamType = {};
                filteredRecords.forEach(record => {
                    const examType = cleanText(record.Examtype);
                    if (!groupedByExamType[examType]) {
                        groupedByExamType[examType] = [];
                    }
                    groupedByExamType[examType].push(chartDataType === 'percentage' ? record.Percentage : record.Mark);
                });

                labels = Object.keys(groupedByExamType).sort();
                chartData = labels.map(examType => {
                    const sum = groupedByExamType[examType].reduce((acc, val) => acc + val, 0);
                    return sum / groupedByExamType[examType].length;
                });
                yAxisLabel = chartDataType === 'percentage' ? 'Average %' : 'Average Marks (Score)';
                tooltipCallback = function(context) {
                    const groupLabel = context.label;
                    const value = context.raw.toFixed(2); // Format average
                    return `Average for ${groupLabel}: ${value}${chartDataType === 'percentage' ? '%' : ''}`;
                };
            }


            if (currentChart) {
                currentChart.destroy();
            }

            currentChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: chartDataType === 'percentage' ? 'Performance %' : 'Student Marks',
                        data: chartData,
                        borderColor: '#6366f1', /* Indigo-500 */
                        backgroundColor: 'rgba(99, 102, 241, 0.2)', /* Light indigo with transparency */
                        tension: 0.3,
                        pointBackgroundColor: '#6366f1',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: '#6366f1',
                        pointRadius: 5,
                        pointHoverRadius: 7,
                        fill: true,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                font: {
                                    size: 14,
                                    family: 'Poppins' /* Changed to Poppins */
                                },
                                color: '#2d3748'
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: tooltipCallback
                            },
                            titleFont: {
                                family: 'Poppins' /* Changed to Poppins */
                            },
                            bodyFont: {
                                family: 'Poppins' /* Changed to Poppins */
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: graphGrouping === 'individual' ? 'Exam Instances' : (graphGrouping === 'subject_average' ? 'Subjects' : 'Exam Types'),
                                color: '#2d3748',
                                font: {
                                    size: 10, // Reduced from 14 to 10 for better fit
                                    weight: 'bold',
                                    family: 'Poppins' /* Changed to Poppins */
                                }
                            },
                            ticks: {
                                color: '#4a5568',
                                font: {
                                    size: 9, // Reduced from 10 to 9 for labels to prevent overlap
                                    family: 'Poppins' /* Changed to Poppins */
                                },
                                minRotation: 60, // Increased rotation for better fit
                                maxRotation: 60
                            },
                            grid: {
                                display: false
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: yAxisLabel,
                                color: '#2d3748',
                                font: {
                                    size: 14, // Reduced from 16 to 14
                                    weight: 'bold',
                                    family: 'Poppins' /* Changed to Poppins */
                                }
                            },
                            min: 0,
                            max: yAxisMax, // Dynamic max for Y-axis
                            ticks: {
                                callback: yAxisCallback,
                                color: '#4a5568',
                                font: {
                                    size: 11, // Reduced from default to 11
                                    family: 'Poppins' /* Changed to Poppins */
                                }
                            },
                            grid: {
                                color: '#e2e8f0' /* Lighter gray for grid lines */
                            }
                        }
                    }
                }
            });
        }

        // Array to store original elements and their replacements/styles for download preparation
        let originalElementsState = [];

        /**
         * Prepares the modal content for download by modifying elements for better rendering.
         */
        async function prepareModalForDownload() {
            const modalContent = document.getElementById('modalContent');
            const studentName = cleanText(document.getElementById('modalStudentName').textContent.replace('Performance for: ', ''));
            const studentId = document.getElementById('modalStudentId').textContent.split('|')[0].replace('Student ID: ', '').trim();
            const studentClass = document.getElementById('modalStudentId').textContent.split('|')[1].replace('Class:', '').trim();
            const teacherRemarks = document.getElementById('teacherRemarks').value.trim();

            // Show loading indicator
            showLoadingIndicator('Preparing for download...');

            // Store original display styles of main modal elements to revert later
            const elementsToHide = modalContent.children;
            originalElementsState = [];
            Array.from(elementsToHide).forEach(el => {
                originalElementsState.push({ element: el, originalDisplay: el.style.display });
                el.style.display = 'none'; // Hide all original content
            });

            // Temporarily move modalContent off-screen and remove height constraints for capture
            originalElementsState.push({ element: modalContent, originalStyle: modalContent.style.cssText });
            modalContent.style.position = 'absolute';
            modalContent.style.left = '-9999px';
            modalContent.style.maxHeight = 'none'; // Remove max-height for capture
            modalContent.style.overflowY = 'visible'; // Allow content to expand

            // Also ensure the chart container itself doesn't have max-height for capture
            const performanceChartContainer = document.querySelector('#performanceModal .relative.h-auto.w-full'); // Removed max-h-96
            if (performanceChartContainer) {
                originalElementsState.push({ element: performanceChartContainer, originalStyle: performanceChartContainer.style.cssText });
                performanceChartContainer.style.maxHeight = 'none';
                // Adjusted height for better fit in downloaded reports
                performanceChartContainer.style.height = '450px'; // Reduced from 600px
            }


            // Create a new container for downloadable content
            const downloadableContent = document.createElement('div');
            downloadableContent.id = 'downloadableContent';
            downloadableContent.style.width = '1200px'; // Set a fixed width for high-res capture
            downloadableContent.style.padding = '20px';
            downloadableContent.style.boxSizing = 'border-box';
            downloadableContent.style.fontFamily = 'Poppins, sans-serif';
            downloadableContent.style.color = '#333';
            downloadableContent.style.backgroundColor = '#fff'; // Ensure white background for PDF/JPEG
            downloadableContent.style.position = 'relative'; // For absolute positioning of logo

            // ADDED: Logo at the top center
            const logoImg = document.createElement('img');
            // IMPORTANT: Replace this URL with your actual public logo URL
            // This placeholder is 820x312 pixels as requested.
            logoImg.src = 'YOUR_ALIF_EDU_LOGO_PUBLIC_URL_HERE';
            logoImg.alt = 'alif edu (600 x 300 px) (820 x 312 px).png'; // Using the exact file name here
            logoImg.style.display = 'block'; // Make it a block element
            logoImg.style.margin = '0 auto 20px auto'; // Center it and add margin below
            logoImg.style.maxWidth = '80%'; // Ensure it's responsive within the content
            logoImg.style.height = 'auto'; // Maintain aspect ratio
            logoImg.style.zIndex = '1'; // Ensure it's above other elements if needed
            downloadableContent.appendChild(logoImg);


            // 1. Progress Card (centered)
            downloadableContent.innerHTML += `<h2 style="text-align: center; font-size: 2em; font-weight: 700; color: var(--primary-blue); margin-bottom: 20px; position: relative; z-index: 1;">Progress Card</h2>`;

            // 2. Student Name, ID, Class (on one line)
            downloadableContent.innerHTML += `
                <p style="font-size: 1.1em; margin-bottom: 20px; position: relative; z-index: 1;">
                    <strong>Student Name:</strong> ${studentName} &nbsp;&nbsp;&nbsp;
                    <strong>ID:</strong> ${studentId} &nbsp;&nbsp;&nbsp;
                    <strong>Class:</strong> ${studentClass}
                </p>
            `;

            // 3. Exam Name (explicitly stated, smaller font, using short form)
            const selectedExamType = document.getElementById('examTypeFilter').value;
            downloadableContent.innerHTML += `
                <p style="font-size: 0.9em; margin-bottom: 20px; position: relative; z-index: 1;">
                    <strong>Exam Name:</strong> ${getShortExamName(selectedExamType === 'all' ? 'All Exam Types' : selectedExamType)}
                </p>
            `;

            // 4. The mark list of the exam (Detailed Exam Results Table)
            const examTable = document.getElementById('examDetailsTableBody').parentNode.cloneNode(true); // Clone the whole table
            examTable.style.marginBottom = '30px';
            examTable.style.border = '1px solid #eee'; // Add a border for clarity in PDF
            examTable.style.borderRadius = '8px';
            examTable.style.overflow = 'hidden'; // Ensure rounded corners apply
            examTable.style.position = 'relative'; // For z-index
            examTable.style.zIndex = '1'; // Ensure it's above the logo
            downloadableContent.appendChild(examTable);

            // 5. Graph
            const chartCanvas = document.getElementById('performanceChart');
            const chartImg = document.createElement('img');
            chartImg.src = chartCanvas.toDataURL('image/png');
            chartImg.style.width = '100%';
            chartImg.style.height = 'auto';
            chartImg.style.marginBottom = '30px';
            chartImg.style.border = '1px solid #eee'; // Add border for clarity
            chartImg.style.borderRadius = '8px';
            chartImg.style.position = 'relative'; // For z-index
            chartImg.style.zIndex = '1'; // Ensure it's above the logo
            downloadableContent.appendChild(chartImg);

            // 6. Class Teacher's Remarks/Suggestions:
            downloadableContent.innerHTML += `
                <div style="margin-bottom: 30px; padding: 15px; border: 1px solid #ddd; border-radius: 8px; background-color: #f9f9f9; position: relative; z-index: 1;">
                    <h3 style="font-size: 1.1em; font-weight: 600; color: var(--dark-text); margin-bottom: 10px;">Class Teacher's Remarks/Suggestions:</h3>
                    <p style="font-size: 1em; line-height: 1.6; color: #555;">${teacherRemarks || 'No remarks/suggestions provided.'}</p>
                </div>
            `;

            // 7. Principal Sign (Principal's Signature & Official Seal)
            downloadableContent.innerHTML += `
                <div style="display: flex; justify-content: space-between; align-items: flex-end; margin-top: 40px; padding-top: 20px; border-top: 1px solid #eee; position: relative; z-index: 1;">
                    <div style="text-align: center; width: 48%; padding-right: 10px;">
                        <div style="height: 60px; border-b border-gray-400 mb-2"></div>
                        <p style="font-size: 0.9em; font-weight: 600; color: #555;">Principal's Signature</p>
                    </div>
                    <div style="text-align: center; width: 48%; padding-left: 10px;">
                        <div style="height: 60px; border-b border-gray-400 mb-2"></div>
                        <p style="font-size: 0.9em; font-weight: 600; color: #555;">Official Seal</p>
                    </div>
                </div>
            `;

            modalContent.appendChild(downloadableContent);
            hideLoadingIndicator(); // Hide loading indicator after content is prepared
        }

        /**
         * Reverts the modal content back to its interactive state after download.
         */
        function revertModalFromDownload() {
            const modalContent = document.getElementById('modalContent');
            const downloadableContent = document.getElementById('downloadableContent');
            if (downloadableContent) {
                // Remove the temporary fixed width
                downloadableContent.style.width = '';
                modalContent.removeChild(downloadableContent);
            }

            // Revert modalContent styles
            originalElementsState.forEach(item => {
                if (item.element === modalContent) {
                    item.element.style.cssText = item.originalStyle; // Restore original inline style
                } else if (item.element === document.querySelector('#performanceModal .relative.h-auto.w-full')) { // Updated selector
                    item.element.style.cssText = item.originalStyle; // Restore original inline style for chart container
                } else {
                    item.element.style.display = item.originalDisplay;
                }
            });
            originalElementsState = []; // Clear the array
        }

        /**
         * Downloads the content of the performance modal as a PDF.
         */
        async function downloadPdf() {
            const studentName = cleanText(document.getElementById('modalStudentName').textContent.replace('Performance for: ', ''));
            const studentId = document.getElementById('modalStudentId').textContent.split('|')[0].replace('Student ID: ', '').trim();

            showLoadingIndicator('Generating PDF...');
            await prepareModalForDownload(); // Await this as it involves image loading
            const downloadableContent = document.getElementById('downloadableContent');

            const scaleFactor = 4; // Higher scale for better clarity

            const canvas = await html2canvas(downloadableContent, {
                scale: scaleFactor,
                useCORS: true,
                windowWidth: downloadableContent.scrollWidth,
                windowHeight: downloadableContent.scrollHeight,
                scrollY: -window.scrollY,
                scrollX: -window.scrollX
            });

            revertModalFromDownload();
            hideLoadingIndicator(); // Hide loading indicator after download is complete

            const imgData = canvas.toDataURL('image/png');
            const pdf = new window.jspdf.jsPDF('p', 'mm', 'a4');

            const imgWidth = 210; // A4 width in mm
            const pageHeight = 297; // A4 height in mm
            const imgHeight = (canvas.height * imgWidth) / canvas.width;

            let position = 0;
            let heightLeft = imgHeight;

            pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
            heightLeft -= pageHeight;

            while (heightLeft >= 0) {
                position = heightLeft - imgHeight;
                pdf.addPage();
                pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;
            }

            pdf.save(`Student_Performance_${studentName.replace(/[^a-zA-Z0-9]/g, '_')}_${studentId}.pdf`);
        }

        /**
         * Downloads the content of the performance modal as a JPEG image.
         */
        async function downloadJpeg() {
            const studentName = cleanText(document.getElementById('modalStudentName').textContent.replace('Performance for: ', ''));
            const studentId = document.getElementById('modalStudentId').textContent.split('|')[0].replace('Student ID: ', '').trim();

            showLoadingIndicator('Generating JPEG...');
            await prepareModalForDownload(); // Await this as it involves image loading
            const downloadableContent = document.getElementById('downloadableContent');

            const scaleFactor = 4; // Higher scale for better clarity

            const canvas = await html2canvas(downloadableContent, {
                scale: scaleFactor,
                useCORS: true,
                windowWidth: downloadableContent.scrollWidth,
                windowHeight: downloadableContent.scrollHeight,
                scrollY: -window.scrollY,
                scrollX: -window.scrollX
            });

            revertModalFromDownload();
            hideLoadingIndicator(); // Hide loading indicator after download is complete

            const imgData = canvas.toDataURL('image/jpeg', 0.95); // 0.95 is JPEG quality for higher clarity
            
            // Create a temporary link element
            const link = document.createElement('a');
            link.href = imgData;
            link.download = `Student_Performance_${studentName.replace(/[^a-zA-Z0-9]/g, '_')}_${studentId}.jpeg`;
            document.body.appendChild(link); // Append to body to ensure it's in the DOM
            link.click(); // Programmatically click the link to trigger download
            document.body.removeChild(link); // Clean up the temporary link

            // Show a message if the download didn't start (might still be pop-up blocker or other issue)
            // This is a fallback and might not always catch all scenarios.
            setTimeout(() => {
                if (!link.download) { // Simple check if download attribute was honored
                     showDownloadMessage();
                }
            }, 500); // Give it a short moment to try downloading
        }

        /**
         * Shows the custom download message box.
         */
        function showDownloadMessage() {
            const messageBox = document.getElementById('downloadMessage');
            messageBox.classList.remove('hidden');
            messageBox.classList.add('show');
        }

        /**
         * Hides the custom download message box.
         */
        function hideDownloadMessage() {
            const messageBox = document.getElementById('downloadMessage');
            messageBox.classList.remove('show');
            messageBox.classList.add('hidden');
        }

        /**
         * Shows the loading indicator with a given message.
         * @param {string} message - The message to display.
         */
        function showLoadingIndicator(message) {
            const loadingIndicator = document.getElementById('loadingIndicator');
            const loadingSpan = loadingIndicator.querySelector('span');
            loadingSpan.textContent = message;
            loadingIndicator.classList.remove('hidden');
        }

        /**
         * Hides the loading indicator.
         */
        function hideLoadingIndicator() {
            const loadingIndicator = document.getElementById('loadingIndicator');
            loadingIndicator.classList.add('hidden');
        }

        /**
         * Copies a summary of the student's performance to the clipboard.
         */
        function copyPerformanceSummary() {
            const studentName = cleanText(document.getElementById('modalStudentName').textContent.replace('Performance for: ', ''));
            const studentId = document.getElementById('modalStudentId').textContent.split('|')[0].replace('Student ID: ', '').trim();
            const studentClass = document.getElementById('modalStudentId').textContent.split('|')[1].replace('Class:', '').trim();
            const averagePercentage = document.getElementById('overallAveragePercentage').textContent.replace('Average %: ', '');
            const teacherRemarks = document.getElementById('teacherRemarks').value.trim();

            let examDetails = '';
            // Sort records by subject and then by exam type for consistent output
            const sortedRecords = [...currentStudentRecords].sort((a, b) => {
                const subjectComparison = a.Subject.localeCompare(b.Subject);
                if (subjectComparison !== 0) return subjectComparison;
                return a.Examtype.localeCompare(b.Examtype);
            });

            sortedRecords.forEach(record => {
                examDetails += `  - ${cleanText(record.Subject)} (${cleanText(record.Examtype)}): Mark ${record.Mark}/${record.OutOf}, % ${record.Percentage}%, Grade ${record.Grade}\n`;
            });

            const summaryText = `
Student Performance Summary:

Student Name: ${studentName}
Student ID: ${studentId}
Class: ${studentClass}
Overall Average %: ${averagePercentage}

Detailed Exam Results:
${examDetails || '  No detailed exam results available for current filters.'}
Class Teacher's Remarks/Suggestions:
${teacherRemarks || '  No remarks/suggestions provided.'}

For a detailed performance report, please refer to the attached PDF/JPEG or log in to the student portal.
            `.trim();

            // Create a temporary textarea element to hold the text
            const tempTextArea = document.createElement('textarea');
            tempTextArea.value = summaryText;
            document.body.appendChild(tempTextArea);

            // Select the text and copy it
            tempTextArea.select();
            document.execCommand('copy');

            // Remove the temporary textarea
            document.body.removeChild(tempTextArea);

            // Show toast notification
            const copyToast = document.getElementById('copyToast');
            copyToast.classList.remove('hidden');
            copyToast.classList.add('show');
            setTimeout(() => {
                copyToast.classList.remove('show');
                copyToast.classList.add('hidden');
            }, 3000); // Hide after 3 seconds
        }

        // Initial data fetch when the DOM is fully loaded
        document.addEventListener('DOMContentLoaded', fetchStudentDataFromGoogleSheet);
    </script>
</body>
</html>
