<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Billing Panel</title>
  <script defer src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-blue-100 to-indigo-200 min-h-screen p-8 font-sans">
  <div class="max-w-2xl mx-auto bg-white shadow-2xl rounded-2xl p-8">
    <h2 class="text-2xl font-bold text-center text-indigo-700 mb-6">Student Billing Panel</h2>

    <form id="billingForm" class="space-y-4">
      <div>
        <label class="block font-semibold">Receipt No</label>
        <input type="text" id="receiptNo" name="receiptNo" class="w-full rounded-xl p-2 bg-gray-100 shadow-inner" readonly>
      </div>

      <div>
        <label class="block font-semibold">Date</label>
        <input type="date" id="date" name="date" class="w-full rounded-xl p-2 bg-gray-100 shadow-inner" readonly>
      </div>

      <div>
        <label class="block font-semibold">Student Name</label>
        <input type="text" id="studentName" name="studentName" class="w-full rounded-xl p-2 bg-gray-100 shadow-inner" required>
      </div>

      <div>
        <label class="block font-semibold">Student ID</label>
        <input type="text" id="studentId" name="studentId" class="w-full rounded-xl p-2 bg-gray-100 shadow-inner" required>
      </div>

      <div>
        <label class="block font-semibold">Class</label>
        <input type="text" id="class" name="class" class="w-full rounded-xl p-2 bg-gray-100 shadow-inner" required>
      </div>

      <div>
        <label class="block font-semibold">Fee Type</label>
        <select id="feeType" name="feeType" class="w-full rounded-xl p-2 bg-gray-100 shadow-inner">
          <option value="">Select</option>
          <option value="Tuition Fee">Tuition Fee</option>
          <option value="Admission Fee">Admission Fee</option>
          <option value="Exam Fee">Exam Fee</option>
          <option value="Book Fee">Book Fee</option>
        </select>
      </div>

      <div id="teacherSection" class="hidden">
        <label class="block font-semibold">Add Teacher Details</label>
        <div id="teacherList" class="space-y-2"></div>
        <button type="button" id="addTeacherBtn" class="mt-2 bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">+ Add Teacher</button>
      </div>

      <div id="amountGroup">
        <label class="block font-semibold">Amount</label>
        <input type="number" id="amount" name="amount" class="w-full rounded-xl p-2 bg-gray-100 shadow-inner">
      </div>

      <div>
        <label class="block font-semibold">Discount</label>
        <input type="number" id="discount" name="discount" class="w-full rounded-xl p-2 bg-gray-100 shadow-inner">
      </div>

      <div>
        <label class="block font-semibold">Payment Status</label>
        <select id="status" name="status" class="w-full rounded-xl p-2 bg-gray-100 shadow-inner">
          <option value="Paid">Paid</option>
          <option value="Pending">Pending</option>
          <option value="Discounted">Discounted</option>
        </select>
      </div>

      <button type="submit" class="w-full mt-4 bg-indigo-600 text-white font-semibold py-2 rounded-xl hover:bg-indigo-700 transition">Submit</button>
    </form>

    <div id="confirmation" class="text-center text-green-600 font-bold mt-4 hidden">Form submitted successfully!</div>

    <div id="receipt" class="mt-8 p-6 rounded-xl bg-white shadow-xl hidden">
      <h3 class="text-xl font-bold text-center text-indigo-700 mb-4">Receipt</h3>
      <div id="receiptContent" class="text-gray-800 space-y-1"></div>
      <button onclick="downloadPDF()" class="mt-4 bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">Download PDF</button>
    </div>
  </div>

  <script>
    const scriptURL = 'https://script.google.com/macros/s/AKfycbz1EeKiFbWshwqgQa9t-D3-dtBjzIYy99g1p8-p8V0Blhv6e4cs9m5aIjEQrhPPYlH7ew/exec';

    document.addEventListener('DOMContentLoaded', () => {
      const today = new Date().toISOString().split('T')[0];
      document.getElementById("date").value = today;

      fetch(`${scriptURL}?action=getNextReceiptNo`)
        .then(res => res.json())
        .then(data => document.getElementById("receiptNo").value = data.receiptNo)
        .catch(err => alert("Error fetching receipt number."));
    });

    document.getElementById("feeType").addEventListener("change", function () {
      const isTuition = this.value === "Tuition Fee";
      document.getElementById("teacherSection").style.display = isTuition ? "block" : "none";
      document.getElementById("amountGroup").style.display = isTuition ? "none" : "block";
    });

    document.getElementById("addTeacherBtn").addEventListener("click", function () {
      const container = document.createElement("div");
      container.className = "bg-gray-50 p-4 rounded-xl shadow-inner space-y-2";
      container.innerHTML = `
        <div>
          <label class="block font-semibold">Teacher Name</label>
          <input type="text" class="teacherName w-full rounded-xl p-2 bg-gray-100" required>
        </div>
        <div>
          <label class="block font-semibold">Hours</label>
          <input type="number" class="teacherHours w-full rounded-xl p-2 bg-gray-100" required>
        </div>
        <div>
          <label class="block font-semibold">Per Hour Rate</label>
          <input type="number" class="teacherRate w-full rounded-xl p-2 bg-gray-100" required>
        </div>
      `;
      document.getElementById("teacherList").appendChild(container);
    });

    document.getElementById("billingForm").addEventListener("submit", function (e) {
      e.preventDefault();

      let amount = parseFloat(document.getElementById("amount").value);
      const isTuition = document.getElementById("feeType").value === "Tuition Fee";

      let teacherData = [];
      if (isTuition) {
        amount = 0;
        document.querySelectorAll("#teacherList > div").forEach(el => {
          const name = el.querySelector(".teacherName").value;
          const hours = parseFloat(el.querySelector(".teacherHours").value);
          const rate = parseFloat(el.querySelector(".teacherRate").value);
          const subtotal = hours * rate;
          amount += subtotal;
          teacherData.push({ name, hours, rate, subtotal });
        });
      }

      const discount = parseFloat(document.getElementById("discount").value || 0);
      const totalAmount = amount - discount;

      const formData = {
        receiptNo: document.getElementById("receiptNo").value,
        date: document.getElementById("date").value,
        studentName: document.getElementById("studentName").value,
        studentId: document.getElementById("studentId").value,
        class: document.getElementById("class").value,
        feeType: document.getElementById("feeType").value,
        teacherDetails: teacherData,
        amount: amount,
        discount: discount,
        totalAmount: totalAmount,
        status: document.getElementById("status").value
      };

      fetch(scriptURL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(formData)
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          document.getElementById("confirmation").classList.remove("hidden");
          document.getElementById("receipt").classList.remove("hidden");
          document.getElementById("receiptContent").innerHTML = `
            <p><strong>Receipt No:</strong> ${formData.receiptNo}</p>
            <p><strong>Date:</strong> ${formData.date}</p>
            <p><strong>Student Name:</strong> ${formData.studentName}</p>
            <p><strong>Student ID:</strong> ${formData.studentId}</p>
            <p><strong>Class:</strong> ${formData.class}</p>
            <p><strong>Fee Type:</strong> ${formData.feeType}</p>
            <p><strong>Amount:</strong> ${formData.amount}</p>
            <p><strong>Discount:</strong> ${formData.discount}</p>
            <p><strong>Total:</strong> ${formData.totalAmount}</p>
            <p><strong>Status:</strong> ${formData.status}</p>
          `;
        } else {
          alert("Submission failed.");
        }
      })
      .catch(err => alert("Error submitting form."));
    });

    function downloadPDF() {
      window.print();
    }
  </script>
</body>
</html>
