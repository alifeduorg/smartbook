<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Billing Panel</title>
    <!-- Firebase SDK Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script> <!-- For PDF download -->
</head>
<body>
    <h2>Billing Panel</h2>

    <!-- Dashboard Button -->
    <button id="dashboardBtn" onclick="goToDashboard()">Go to Dashboard</button>

    <hr>

    <!-- Form to Submit Billing Data -->
    <form id="billingForm">
        <label for="student">Student Name:</label><br>
        <input type="text" id="student" name="student"><br><br>

        <label for="studentId">Student ID:</label><br>
        <input type="text" id="studentId" name="studentId"><br><br>

        <label for="plan">Fee Plan:</label><br>
        <input type="text" id="plan" name="plan"><br><br>

        <label for="total">Total Fee:</label><br>
        <input type="number" id="total" name="total"><br><br>

        <label for="paid">Paid Fee:</label><br>
        <input type="number" id="paid" name="paid"><br><br>

        <label for="balance">Balance:</label><br>
        <input type="number" id="balance" name="balance"><br><br>

        <label for="paymentMode">Payment Mode:</label><br>
        <input type="text" id="paymentMode" name="paymentMode"><br><br>

        <label for="date">Date of Payment:</label><br>
        <input type="date" id="date" name="date"><br><br>

        <button type="button" onclick="submitForm()">Submit & Generate Slip</button>
    </form>

    <hr>

    <h3>Generated Fee Slip</h3>
    <div id="feeSlip"></div>

    <!-- View Fee Slip Button -->
    <button onclick="viewSlip()">View Slip</button>

    <!-- Download Fee Slip Button -->
    <button onclick="downloadSlip()">Download Fee Slip</button>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCmlx84oYqa_yBIHFNVa0lqiA-8Eq12ezw",
            authDomain: "alifedubilling-72aca.firebaseapp.com",
            projectId: "alifedubilling-72aca",
            storageBucket: "alifedubilling-72aca.firebasestorage.app",
            messagingSenderId: "689907023891",
            appId: "1:689907023891:web:acb38eb8f158eb472affe6",
            measurementId: "G-TDLC65EYFJ"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore(app);

        // Google Sheets Web App URL (replace with your actual URL)
        const googleSheetsUrl = "https://script.google.com/macros/s/AKfycbyhVD_GWLlE1JeMScnEKBSsWypN0_rUKvANrfqw_NUPfk9wuRoq5tEuViz-OwZO3DjBhQ/exec";

        // Fetch data from Google Sheets
        async function fetchSheetData() {
            try {
                const response = await fetch(googleSheetsUrl);
                const data = await response.json();
                console.log(data); // Log the data for testing

                // Display the data in the form (you can customize this)
                if (data && data.length > 0) {
                    const student = data[0]; // Example: fetch first student's data
                    document.getElementById("student").value = student.studentName;
                    document.getElementById("studentId").value = student.studentId;
                    document.getElementById("plan").value = student.feePlan;
                    document.getElementById("total").value = student.totalFee;
                    document.getElementById("paid").value = student.paidFee;
                    document.getElementById("balance").value = student.balance;
                }
            } catch (error) {
                console.error('Error fetching data:', error);
            }
        }

        // Fetch the sheet data when the page loads
        window.onload = fetchSheetData;

        // Submit form and save data to Firebase Firestore
        async function submitForm() {
            const classValue = "Class 10"; // For example, hardcoded or fetch from user input
            const studentName = document.getElementById("student").value;
            const studentId = document.getElementById("studentId").value;
            const plan = document.getElementById("plan").value;
            const total = document.getElementById("total").value;
            const paid = document.getElementById("paid").value;
            const balance = document.getElementById("balance").value;
            const paymentMode = document.getElementById("paymentMode").value;
            const date = document.getElementById("date").value;

            const formData = {
                class: classValue,
                name: studentName,
                id: studentId,
                plan: plan,
                total: total,
                paid: paid,
                balance: balance,
                paymentMode: paymentMode,
                date: date
            };

            try {
                const docRef = await db.collection("billingRecords").add(formData);
                console.log("Document written with ID: ", docRef.id);
                alert("Data submitted successfully!");
                generateSlip(formData);
            } catch (e) {
                console.error("Error adding document: ", e);
                alert("Error submitting data.");
            }
        }

        // Function to generate and display the fee slip
        function generateSlip(formData) {
            const slipHtml = `
                <strong>Student Name:</strong> ${formData.name}<br>
                <strong>Class:</strong> ${formData.class}<br>
                <strong>Student ID:</strong> ${formData.id}<br>
                <strong>Fee Plan:</strong> ${formData.plan}<br>
                <strong>Total Fee:</strong> ₹${formData.total}<br>
                <strong>Paid Fee:</strong> ₹${formData.paid}<br>
                <strong>Balance:</strong> ₹${formData.balance}<br>
                <strong>Payment Mode:</strong> ${formData.paymentMode}<br>
                <strong>Date of Payment:</strong> ${formData.date}<br>
            `;
            document.getElementById("feeSlip").innerHTML = slipHtml;
        }

        // View Fee Slip
        function viewSlip() {
            const slipContent = document.getElementById("feeSlip").innerHTML;
            if (slipContent) {
                window.open().document.write(slipContent);
            } else {
                alert("No slip available to view.");
            }
        }

        // Download Fee Slip as PDF
        function downloadSlip() {
            const slipContent = document.getElementById("feeSlip").innerHTML;
            if (slipContent) {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                doc.html(slipContent, {
                    callback: function (doc) {
                        doc.save('fee-slip.pdf');
                    }
                });
            } else {
                alert("No slip available to download.");
            }
        }

        // Dashboard Button (Simple redirect)
        function goToDashboard() {
            window.location.href = 'dashboard.html'; // Modify this URL as per your dashboard page
        }
    </script>
</body>
</html>
