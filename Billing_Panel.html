<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Billing Panel</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f9fafb;
      padding: 20px;
      max-width: 700px;
      margin: auto;
    }
    h2 {
      text-align: center;
      margin-bottom: 20px;
    }
    label {
      display: block;
      margin-top: 15px;
      font-weight: 600;
    }
    input, select {
      width: 100%;
      padding: 8px;
      margin-top: 6px;
      border-radius: 5px;
      border: 1px solid #ccc;
      font-size: 14px;
      box-sizing: border-box;
    }
    .inline-group {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .inline-group > * {
      flex: 1;
    }
    button {
      margin-top: 25px;
      background-color: #007bff;
      color: white;
      border: none;
      padding: 12px;
      font-size: 16px;
      border-radius: 8px;
      cursor: pointer;
      width: 100%;
      transition: background-color 0.3s ease;
    }
    button:hover {
      background-color: #0056b3;
    }
    #totalAmount {
      font-weight: 700;
      margin-top: 10px;
      font-size: 18px;
    }
    #slip {
      margin-top: 30px;
      padding: 15px;
      border: 2px solid #007bff;
      border-radius: 10px;
      background: white;
      display: none;
    }
    #slip h3 {
      text-align: center;
      margin-bottom: 15px;
    }
    #slip p {
      margin: 5px 0;
    }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</head>
<body>

  <h2>Billing Panel</h2>

  <form id="billingForm" onsubmit="return submitForm(event)">
    <label>Receipt No (auto-generated)</label>
    <input type="text" id="receiptNo" name="receiptNo" readonly />

    <label>Student Name</label>
    <input type="text" id="studentName" name="studentName" required />

    <label>Student ID</label>
    <input type="text" id="studentId" name="studentId" required />

    <label>Date</label>
    <input type="date" id="date" name="date" required />

    <label>Class</label>
    <select id="classSelect" name="classSelect" required>
      <option value="">Select Class</option>
      <option>Class 1</option>
      <option>Class 2</option>
      <option>Class 3</option>
      <option>Class 4</option>
      <option>Class 5</option>
    </select>

    <label>Fee Type</label>
    <select id="feeType" name="feeType" required onchange="feeTypeChanged()">
      <option value="">Select Fee Type</option>
      <option value="tuition">Tuition Fee</option>
      <option value="admission">Admission Fee</option>
      <option value="exam">Exam Fee</option>
      <option value="book">Book Fee</option>
    </select>

    <div id="tuitionDetails" style="display:none; margin-top:10px;">
      <label>Number of Hours</label>
      <input type="number" id="numHours" min="1" step="0.1" value="1" onchange="calculateTotal()" />

      <label>Subject Teacher</label>
      <select id="subjectTeacher" onchange="calculateTotal()">
        <option value="">Select Teacher</option>
        <option value="30">Math - $30/hr</option>
        <option value="25">English - $25/hr</option>
        <option value="35">Science - $35/hr</option>
        <option value="20">History - $20/hr</option>
      </select>
    </div>

    <label>Amount</label>
    <input type="number" id="amount" name="amount" readonly />

    <label>Discount (if any)</label>
    <input type="number" id="discount" name="discount" min="0" step="0.01" value="0" onchange="calculateTotal()" />

    <label>Payment Status</label>
    <select id="paymentStatus" name="paymentStatus" required>
      <option value="">Select Status</option>
      <option>Paid</option>
      <option>Pending</option>
      <option>Partial</option>
    </select>

    <button type="submit">Submit & Generate Slip</button>
  </form>

  <div id="slip">
    <h3>Fee Receipt</h3>
    <p><strong>Receipt No:</strong> <span id="slipReceiptNo"></span></p>
    <p><strong>Student Name:</strong> <span id="slipStudentName"></span></p>
    <p><strong>Student ID:</strong> <span id="slipStudentId"></span></p>
    <p><strong>Date:</strong> <span id="slipDate"></span></p>
    <p><strong>Class:</strong> <span id="slipClass"></span></p>
    <p><strong>Fee Type:</strong> <span id="slipFeeType"></span></p>
    <p><strong>Hours:</strong> <span id="slipHours"></span></p>
    <p><strong>Rate per Hour:</strong> $<span id="slipRate"></span></p>
    <p><strong>Discount:</strong> $<span id="slipDiscount"></span></p>
    <p><strong>Total Amount:</strong> $<span id="slipTotal"></span></p>
    <p><strong>Payment Status:</strong> <span id="slipPaymentStatus"></span></p>
    <button onclick="downloadSlip()">Download Receipt PDF</button>
  </div>

  <script>
    // Initialize receipt number from localStorage or start at 1000
    function initReceiptNo() {
      let receiptNo = localStorage.getItem('receiptNo');
      if (!receiptNo) {
        receiptNo = 1000;
        localStorage.setItem('receiptNo', receiptNo);
      }
      document.getElementById('receiptNo').value = receiptNo;
    }

    function feeTypeChanged() {
      const feeType = document.getElementById('feeType').value;
      const tuitionDetails = document.getElementById('tuitionDetails');
      if (feeType === 'tuition') {
        tuitionDetails.style.display = 'block';
        calculateTotal();
      } else {
        tuitionDetails.style.display = 'none';
        document.getElementById('amount').value = getFlatFee(feeType);
      }
    }

    function getFlatFee(feeType) {
      switch (feeType) {
        case 'admission': return 100; // flat admission fee
        case 'exam': return 50;
        case 'book': return 75;
        default: return 0;
      }
    }

    function calculateTotal() {
      const feeType = document.getElementById('feeType').value;
      let amount = 0;
      if (feeType === 'tuition') {
        const hours = parseFloat(document.getElementById('numHours').value) || 0;
        const rate = parseFloat(document.getElementById('subjectTeacher').value) || 0;
        amount = hours * rate;
      } else {
        amount = getFlatFee(feeType);
      }

      const discount = parseFloat(document.getElementById('discount').value) || 0;
      amount = amount - discount;
      if (amount < 0) amount = 0;
      document.getElementById('amount').value = amount.toFixed(2);
    }

    function submitForm(e) {
      e.preventDefault();

      // Gather form data
      const receiptNo = document.getElementById('receiptNo').value;
      const studentName = document.getElementById('studentName').value.trim();
      const studentId = document.getElementById('studentId').value.trim();
      const date = document.getElementById('date').value;
      const className = document.getElementById('classSelect').value;
      const feeType = document.getElementById('feeType').value;
      const hours = feeType === 'tuition' ? parseFloat(document.getElementById('numHours').value) : 0;
      const rate = feeType === 'tuition' ? parseFloat(document.getElementById('subjectTeacher').value) : 0;
      const discount = parseFloat(document.getElementById('discount').value) || 0;
      const totalAmount = parseFloat(document.getElementById('amount').value);
      const paymentStatus = document.getElementById('paymentStatus').value;

      // Validate minimum fields again
      if (!studentName || !studentId || !date || !className || !feeType || !paymentStatus) {
        alert('Please fill all required fields.');
        return;
      }
      if (feeType === 'tuition' && (!hours || !rate)) {
        alert('Please select subject teacher and hours for tuition fee.');
        return;
      }

      // Store in Google Sheet via Google Apps Script API (replace YOUR_WEB_APP_URL)
      const payload = {
        receiptNo, studentName, studentId, date, className,
        feeType, hours, rate, discount, totalAmount, paymentStatus
      };

      fetch('https://script.google.com/macros/s/AKfycbz1EeKiFbWshwqgQa9t-D3-dtBjzIYy99g1p8-p8V0Blhv6e4cs9m5aIjEQrhPPYlH7ew/exec', {
        method: 'POST',
        body: JSON.stringify(payload),
        headers: { 'Content-Type': 'application/json' }
      })
      .then(res => res.json())
      .then(data => {
        if (data.status === 'success') {
          alert('Billing info saved successfully!');
          showSlip(payload);
          incrementReceiptNo();
          document.getElementById('billingForm').reset();
          document.getElementById('amount').value = '';
          document.getElementById('tuitionDetails').style.display = 'none';
        } else {
          alert('Failed to save billing info.');
        }
      })
      .catch(err => {
       
