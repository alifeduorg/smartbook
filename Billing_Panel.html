<!DOCTYPE html>
<html>
<head>
  <title>Billing Panel</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #ffffff;
      margin: 20px;
      color: #333;
    }
    .container {
      background-color: white;
      border: 3px solid navy;
      border-radius: 10px;
      padding: 20px;
      max-width: 800px;
      margin: auto;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
    }
    h2 {
      text-align: center;
      color: navy;
    }
    label {
      font-weight: bold;
    }
    .form-group {
      margin-bottom: 15px;
    }
    select, input[type="text"], input[type="number"] {
      width: 100%;
      padding: 8px;
      border-radius: 5px;
      border: 1px solid #ccc;
    }
    button {
      background-color: gold;
      color: navy;
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      font-size: 16px;
      cursor: pointer;
    }
    #feeSlip {
      display: none;
      background: #fff;
      border: 2px solid navy;
      padding: 20px;
      margin-top: 20px;
    }
  </style>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>
<body>
  <div class="container">
    <h2>Billing Panel</h2>
    <div class="form-group">
      <label for="billDate">Bill Date:</label>
      <input type="text" id="billDate" readonly>
    </div>
    <div class="form-group">
      <label for="receiptNo">Receipt No:</label>
      <input type="text" id="receiptNo" readonly>
    </div>
    <div class="form-group">
      <label for="classSelect">Class:</label>
      <select id="classSelect" onchange="updateStudents()"></select>
    </div>
    <div class="form-group">
      <label for="studentName">Student Name:</label>
      <select id="studentName" onchange="updateStudentID()"></select>
    </div>
    <div class="form-group">
      <label for="studentID">Student ID:</label>
      <input type="text" id="studentID" readonly>
    </div>
    <div class="form-group">
      <label for="feePlan">Fee Plan:</label>
      <select id="feePlan">
        <option value="Basic">Basic</option>
        <option value="Standard">Standard</option>
        <option value="Premium">Premium</option>
      </select>
    </div>
    <div class="form-group">
      <label for="daysPurchased">Days Purchased:</label>
      <input type="number" id="daysPurchased">
    </div>
    <div class="form-group">
      <label for="totalFee">Total Fee:</label>
      <input type="number" id="totalFee">
    </div>
    <div class="form-group">
      <label for="paidAmount">Paid Amount:</label>
      <input type="number" id="paidAmount" oninput="calculateBalance()">
    </div>
    <div class="form-group">
      <label for="balance">Balance:</label>
      <input type="number" id="balance" readonly>
    </div>
    <div class="form-group">
      <label for="paymentMode">Payment Mode:</label>
      <input type="text" id="paymentMode">
    </div>
    <div class="form-group">
      <label for="remarks">Remarks:</label>
      <input type="text" id="remarks">
    </div>
    <div class="form-group">
      <label for="paymentStatus">Payment Status:</label>
      <select id="paymentStatus">
        <option value="Paid">Paid</option>
        <option value="Unpaid">Unpaid</option>
      </select>
    </div>
    <button onclick="submitData()">Submit</button>
    <button onclick="generateFeeSlip()">Show Fee Slip</button>
    <div id="feeSlip"></div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCmlx84oYqa_yBIHFNVa0lqiA-8Eq12ezw",
      authDomain: "alifedubilling-72aca.firebaseapp.com",
      projectId: "alifedubilling-72aca",
      storageBucket: "alifedubilling-72aca.firebasestorage.app",
      messagingSenderId: "689907023891",
      appId: "1:689907023891:web:acb38eb8f158eb472affe6",
      measurementId: "G-TDLC65EYFJ"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const scriptUrl = "https://script.google.com/macros/s/AKfycbyhVD_GWLlE1JeMScnEKBSsWypN0_rUKvANrfqw_NUPfk9wuRoq5tEuViz-OwZO3DjBhQ/exec"; // Replace with your deployed Google Apps Script Web App URL

    document.addEventListener("DOMContentLoaded", () => {
      document.getElementById("billDate").value = new Date().toISOString().split('T')[0];
      fetchClasses();
      getLatestReceiptNo();
    });

    let studentData = [];

    function fetchClasses() {
      fetch(scriptUrl + '?action=getClassStudents')
        .then(res => res.json())
        .then(data => {
          studentData = data;
          const classSet = new Set(studentData.map(s => s.Class));
          const classSelect = document.getElementById("classSelect");
          classSet.forEach(cls => {
            const opt = document.createElement("option");
            opt.value = cls;
            opt.text = cls;
            classSelect.appendChild(opt);
          });
        });
    }

    function updateStudents() {
      const selectedClass = document.getElementById("classSelect").value;
      const filtered = studentData.filter(s => s.Class === selectedClass);
      const studentSelect = document.getElementById("studentName");
      studentSelect.innerHTML = "";
      filtered.forEach(st => {
        const opt = document.createElement("option");
        opt.value = st["Student Name"];
        opt.text = st["Student Name"];
        opt.dataset.id = st["Student ID"];
        studentSelect.appendChild(opt);
      });
      updateStudentID();
    }

    function updateStudentID() {
      const studentSelect = document.getElementById("studentName");
      const selected = studentSelect.options[studentSelect.selectedIndex];
      document.getElementById("studentID").value = selected.dataset.id;
    }

    function calculateBalance() {
      const total = parseFloat(document.getElementById("totalFee").value) || 0;
      const paid = parseFloat(document.getElementById("paidAmount").value) || 0;
      document.getElementById("balance").value = total - paid;
    }

    function getLatestReceiptNo() {
      db.collection("billing").orderBy("timestamp", "desc").limit(1).get().then(snapshot => {
        const last = snapshot.docs[0]?.data()?.receiptNo || 1000;
        document.getElementById("receiptNo").value = last + 1;
      });
    }

    function submitData() {
      const formData = {
        billDate: document.getElementById("billDate").value,
        receiptNo: parseInt(document.getElementById("receiptNo").value),
        class: document.getElementById("classSelect").value,
        studentName: document.getElementById("studentName").value,
        studentID: document.getElementById("studentID").value,
        feePlan: document.getElementById("feePlan").value,
        daysPurchased: parseInt(document.getElementById("daysPurchased").value),
        totalFee: parseFloat(document.getElementById("totalFee").value),
        paidAmount: parseFloat(document.getElementById("paidAmount").value),
        balance: parseFloat(document.getElementById("balance").value),
        paymentMode: document.getElementById("paymentMode").value,
        remarks: document.getElementById("remarks").value,
        paymentStatus: document.getElementById("paymentStatus").value,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      };

      db.collection("billing").add(formData).then(() => {
        alert("Billing Data Saved");
        generateFeeSlip();
      });
    }

    function generateFeeSlip() {
      const slip = document.getElementById("feeSlip");
      slip.style.display = "block";
      slip.innerHTML = `
        <h3>Fee Slip</h3>
        <p><strong>Receipt No:</strong> ${document.getElementById("receiptNo").value}</p>
        <p><strong>Date:</strong> ${document.getElementById("billDate").value}</p>
        <p><strong>Name:</strong> ${document.getElementById("studentName").value}</p>
        <p><strong>Class:</strong> ${document.getElementById("classSelect").value}</p>
        <p><strong>Fee Plan:</strong> ${document.getElementById("feePlan").value}</p>
        <p><strong>Total:</strong> ₹${document.getElementById("totalFee").value}</p>
        <p><strong>Paid:</strong> ₹${document.getElementById("paidAmount").value}</p>
        <p><strong>Balance:</strong> ₹${document.getElementById("balance").value}</p>
        <button onclick="window.print()">Download</button>
      `;
    }
  </script>
</body>
</html>
