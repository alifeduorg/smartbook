<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Billing Panel</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: white;
      color: black;
      margin: 0;
      padding: 0;
    }
    .container {
      width: 80%;
      margin: 0 auto;
      padding: 20px;
    }
    h1 {
      color: #2e3b4e;
      text-align: center;
    }
    .form-container {
      background-color: #f1f1f1;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    select, input, button {
      width: 100%;
      padding: 10px;
      margin: 10px 0;
      font-size: 16px;
    }
    .button {
      background-color: #f5a623;
      border: none;
      color: white;
      cursor: pointer;
    }
    .button:hover {
      background-color: #d47f1b;
    }
    .slip-container {
      display: none;
      margin-top: 20px;
      padding: 15px;
      background-color: #f8f8f8;
      border-radius: 8px;
    }
    .slip-container h2 {
      color: #333;
    }
    .slip-container p {
      margin: 10px 0;
    }
    #dashboardBtn {
      background-color: navy;
      color: white;
      padding: 10px 20px;
      cursor: pointer;
      border: none;
      font-size: 18px;
    }
    #dashboardBtn:hover {
      background-color: #333;
    }
  </style>
</head>
<body>

  <div class="container">
    <h1>Billing Panel</h1>
    <div class="form-container">
      <form id="billingForm">
        <label for="classSelect">Select Class</label>
        <select id="classSelect" onchange="fetchStudents()">
          <option value="">--Select Class--</option>
        </select>

        <label for="studentSelect">Select Student</label>
        <select id="studentSelect" onchange="fillStudentID()">
          <option value="">--Select Student--</option>
        </select>

        <label for="feePlan">Fee Plan</label>
        <select id="feePlan">
          <option value="Basic">Basic</option>
          <option value="Standard">Standard</option>
          <option value="Premium">Premium</option>
        </select>

        <label for="daysPurchased">Days Purchased</label>
        <input type="number" id="daysPurchased" placeholder="Enter number of days" required>

        <label for="totalFee">Total Fee</label>
        <input type="number" id="totalFee" placeholder="Auto-calculated" disabled>

        <label for="paidAmount">Paid Amount</label>
        <input type="number" id="paidAmount" placeholder="Enter paid amount" required>

        <label for="balance">Balance</label>
        <input type="number" id="balance" placeholder="Auto-calculated" disabled>

        <label for="paymentMode">Payment Mode</label>
        <input type="text" id="paymentMode" placeholder="Enter payment mode" required>

        <button type="button" class="button" onclick="submitBillingData()">Submit</button>
      </form>
    </div>

    <!-- Billing Slip -->
    <div class="slip-container" id="slipContainer">
      <h2>Fee Receipt</h2>
      <p id="slipDetails"></p>
      <button id="downloadBtn" onclick="downloadSlip()">Download Receipt</button>
    </div>

    <button id="dashboardBtn" onclick="window.location.href='dashboard.html'">Go to Dashboard</button>
  </div>

  <script>
    const classSelect = document.getElementById("classSelect");
    const studentSelect = document.getElementById("studentSelect");
    const feePlan = document.getElementById("feePlan");
    const daysPurchased = document.getElementById("daysPurchased");
    const totalFee = document.getElementById("totalFee");
    const paidAmount = document.getElementById("paidAmount");
    const balance = document.getElementById("balance");

    // Fetching classes from Google Sheets
    async function fetchClasses() {
      const response = await fetch(`https://script.google.com/macros/s/AKfycbyhVD_GWLlE1JeMScnEKBSsWypN0_rUKvANrfqw_NUPfk9wuRoq5tEuViz-OwZO3DjBhQ/exec`);
      const data = await response.json();
      data.classes.forEach(classItem => {
        let option = document.createElement("option");
        option.value = classItem;
        option.innerText = classItem;
        classSelect.appendChild(option);
      });
    }

    // Fetching students for selected class
    async function fetchStudents() {
      const classValue = classSelect.value;
      const response = await fetch(`https://script.google.com/macros/s/AKfycbyhVD_GWLlE1JeMScnEKBSsWypN0_rUKvANrfqw_NUPfk9wuRoq5tEuViz-OwZO3DjBhQ/exec?class=${classValue}`);
      const students = await response.json();
      studentSelect.innerHTML = '<option value="">--Select Student--</option>'; // Reset
      students.forEach(student => {
        let option = document.createElement("option");
        option.value = student.id;
        option.innerText = student.name;
        studentSelect.appendChild(option);
      });
    }

    // Fill student ID based on student name selection
    function fillStudentID() {
      const selectedStudentID = studentSelect.value;
      const selectedStudentName = studentSelect.options[studentSelect.selectedIndex].innerText;
      if (selectedStudentID && selectedStudentName) {
        console.log("Selected Student ID:", selectedStudentID);
      }
    }

    // Submit billing data
    async function submitBillingData() {
      const billDate = new Date().toLocaleDateString();
      const receiptNo = Math.floor(Math.random() * 1000000); // Simple random receipt number
      const studentID = studentSelect.value;
      const studentName = studentSelect.options[studentSelect.selectedIndex].innerText;
      const feeAmount = totalFee.value;
      const paidAmt = paidAmount.value;
      const remainingBalance = feeAmount - paidAmt;
      const paymentModeValue = document.getElementById("paymentMode").value;
      const feePlanValue = feePlan.value;
      const classValue = classSelect.value;

      // Firebase Firestore storage
      const db = firebase.firestore();
      db.collection("billingData").add({
        billDate: billDate,
        receiptNo: receiptNo,
        studentName: studentName,
        studentID: studentID,
        feePlan: feePlanValue,
        daysPurchased: daysPurchased.value,
        totalFee: feeAmount,
        paidAmount: paidAmt,
        balance: remainingBalance,
        paymentMode: paymentModeValue,
        paymentStatus: paidAmt >= feeAmount ? "Paid" : "Pending",
        class: classValue
      });

      // Display receipt slip
      document.getElementById("slipDetails").innerHTML = `
        <strong>Receipt No: </strong>${receiptNo}<br>
        <strong>Student Name: </strong>${studentName}<br>
        <strong>Class: </strong>${classValue}<br>
        <strong>Fee Plan: </strong>${feePlanValue}<br>
        <strong>Total Fee: </strong>${feeAmount}<br>
        <strong>Paid Amount: </strong>${paidAmt}<br>
        <strong>Balance: </strong>${remainingBalance}<br>
        <strong>Payment Mode: </strong>${paymentModeValue}<br>
        <strong>Payment Status: </strong>${paidAmt >= feeAmount ? "Paid" : "Pending"}
      `;
      document.getElementById("slipContainer").style.display = "block";
    }

    // Download the receipt
    function downloadSlip() {
      const slipContent = document.getElementById("slipContainer").innerHTML;
      const a = document.createElement("a");
      const blob = new Blob([slipContent], { type: 'application/octet-stream' });
      a.href = URL.createObjectURL(blob);
      a.download = `Receipt_${new Date().getTime()}.html`;
      a.click();
    }

    // Initialize classes on page load
    window.onload = () => {
      fetchClasses();
    }
  </script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-analytics.js"></script>
</body>
</html>
