<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Billing Panel</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #ffffff;
      color: #333;
      padding: 20px;
    }
    .panel {
      background: linear-gradient(to right, #f9f6e8, #f9e7c1);
      border: 2px solid navy;
      border-radius: 15px;
      padding: 30px;
      max-width: 800px;
      margin: auto;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }
    label {
      display: block;
      margin: 10px 0 5px;
      font-weight: bold;
    }
    input, select {
      width: 100%;
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
    button {
      margin-top: 15px;
      padding: 10px 20px;
      border: none;
      background-color: navy;
      color: #fff;
      border-radius: 8px;
      cursor: pointer;
    }
    .dashboard-btn {
      background-color: goldenrod;
      margin-bottom: 20px;
    }
    .modal {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      justify-content: center;
      align-items: center;
    }
    .modal-content {
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      max-width: 500px;
      text-align: left;
    }
  </style>
</head>
<body>
  <button class="dashboard-btn" onclick="goToDashboard()">Dashboard</button>
  <div class="panel">
    <h2>Billing Panel</h2>
    <label>Receipt No</label>
    <input type="text" id="receiptNo">

    <label>Class</label>
    <select id="class" onchange="loadStudents()"></select>

    <label>Student Name</label>
    <select id="student" onchange="fillStudentId()"></select>

    <label>Student ID</label>
    <input type="text" id="studentId" readonly>

    <label>Fee Plan</label>
    <select id="feePlan">
      <option>Basic</option>
      <option>Standard</option>
      <option>Premium</option>
    </select>

    <label>Class Start Date</label>
    <input type="date" id="startDate">

    <label>Hourly Rate</label>
    <input type="number" id="hourlyRate" oninput="calculateTotal()">

    <label>Days Purchased</label>
    <input type="number" id="days" oninput="calculateTotal()">

    <label>Total Fee</label>
    <input type="number" id="totalFee" readonly>

    <label>Paid Amount</label>
    <input type="number" id="paidAmount" oninput="updateBalance()">

    <label>Balance</label>
    <input type="number" id="balance" readonly>

    <label>Payment Mode</label>
    <input type="text" id="mode">

    <label>Remarks</label>
    <input type="text" id="remarks">

    <label>Payment Status</label>
    <select id="status">
      <option>Paid</option>
      <option>Pending</option>
    </select>

    <button onclick="submitForm()">Submit</button>
  </div>

  <div class="modal" id="feeSlipModal">
    <div class="modal-content" id="feeSlipContent">
      <h3>Fee Slip</h3>
      <div id="slipDetails"></div>
      <button onclick="downloadSlip()">Download as PDF</button>
      <button onclick="closeModal()">Close</button>
    </div>
  </div>

  <script>
    const API_URL = 'https://script.google.com/macros/s/AKfycbyhVD_GWLlE1JeMScnEKBSsWypN0_rUKvANrfqw_NUPfk9wuRoq5tEuViz-OwZO3DjBhQ/exec'; // Replace with your deployed URL
    let studentMap = {};

    function goToDashboard() {
      window.location.href = 'http://smartbook.alifedu.org/admin-dashboard.html'; // Replace if needed
    }

    fetch(API_URL)
      .then(res => res.json())
      .then(data => {
        studentMap = data;
        const classDropdown = document.getElementById("class");
        classDropdown.innerHTML = '<option value="">Select Class</option>';
        Object.keys(data).forEach(cls => {
          const opt = document.createElement("option");
          opt.value = cls;
          opt.textContent = cls;
          classDropdown.appendChild(opt);
        });
      });

    function loadStudents() {
      const selectedClass = document.getElementById("class").value;
      const studentDropdown = document.getElementById("student");
      studentDropdown.innerHTML = '<option value="">Select Student</option>';
      if (studentMap[selectedClass]) {
        studentMap[selectedClass].forEach(st => {
          const opt = document.createElement("option");
          opt.value = st.name;
          opt.dataset.id = st.id;
          opt.textContent = st.name;
          studentDropdown.appendChild(opt);
        });
      }
    }

    function fillStudentId() {
      const selectedOption = document.getElementById("student").selectedOptions[0];
      document.getElementById("studentId").value = selectedOption?.dataset.id || "";
    }

    function calculateTotal() {
      const rate = parseFloat(document.getElementById("hourlyRate").value || 0);
      const days = parseInt(document.getElementById("days").value || 0);
      document.getElementById("totalFee").value = rate * days;
      updateBalance();
    }

    function updateBalance() {
      const total = parseFloat(document.getElementById("totalFee").value || 0);
      const paid = parseFloat(document.getElementById("paidAmount").value || 0);
      document.getElementById("balance").value = total - paid;
    }

    function submitForm() {
      const data = {
        receiptNo: document.getElementById("receiptNo").value,
        class: document.getElementById("class").value,
        name: document.getElementById("student").value,
        id: document.getElementById("studentId").value,
        plan: document.getElementById("feePlan").value,
        startDate: document.getElementById("startDate").value,
        days: document.getElementById("days").value,
        total: document.getElementById("totalFee").value,
        paid: document.getElementById("paidAmount").value,
        balance: document.getElementById("balance").value,
        mode: document.getElementById("mode").value,
        remarks: document.getElementById("remarks").value,
        status: document.getElementById("status").value
      };

      fetch(API_URL, {
        method: "POST",
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
      })
      .then(res => res.text())
      .then(res => {
        if (res.includes("Success")) {
          showSlip(data);
        } else {
          alert("Submit Failed: " + res);
        }
      })
      .catch(err => alert("Submit Failed: " + err));
    }

    function showSlip(data) {
      const slip = document.getElementById("slipDetails");
      slip.innerHTML = Object.entries(data).map(([k,v]) => `<p><strong>${k}:</strong> ${v}</p>`).join('');
      document.getElementById("feeSlipModal").style.display = 'flex';
    }

    function closeModal() {
      document.getElementById("feeSlipModal").style.display = 'none';
    }

    function downloadSlip() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.text("Fee Slip", 10, 10);

      const slipData = document.getElementById("slipDetails").innerText.split("\n");
      slipData.forEach((line, index) => doc.text(line, 10, 20 + (index * 10)));
      doc.save("fee-slip.pdf");
    }
  </script>
</body>
</html>
