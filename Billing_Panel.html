<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: white;
      color: navy;
      padding: 20px;
    }

    h1 {
      background: navy;
      color: gold;
      padding: 10px;
      border-radius: 8px;
    }

    label {
      font-weight: bold;
      margin-top: 10px;
      display: block;
    }

    input, select {
      width: 100%;
      padding: 8px;
      margin: 5px 0 15px 0;
      border: 2px solid navy;
      border-radius: 5px;
    }

    button {
      background: gold;
      color: navy;
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
    }

    .slip-popup {
      display: none;
      position: fixed;
      top: 10%;
      left: 10%;
      width: 80%;
      background: white;
      border: 3px solid navy;
      padding: 20px;
      z-index: 1000;
    }

    #dashboardBtn {
      background: navy;
      color: white;
      padding: 5px 15px;
      float: right;
      margin-top: -40px;
    }
  </style>
</head>
<body>

<h1>Billing Panel</h1>
<button id="dashboardBtn">Dashboard</button>

<form id="billingForm">
  <label>Bill Date</label>
  <input type="text" id="billDate" name="billDate" readonly>

  <label>Receipt No</label>
  <input type="text" id="receiptNo" name="receiptNo" readonly>

  <label>Class</label>
  <select id="classSelect" required></select>

  <label>Student Name</label>
  <select id="studentSelect" required></select>

  <label>Student ID</label>
  <input type="text" id="studentId" name="studentId" readonly>

  <label>Fee Plan</label>
  <select id="feePlan">
    <option>Basic</option>
    <option>Standard</option>
    <option>Premium</option>
  </select>

  <label>Class Start Date</label>
  <input type="date" name="classStartDate" required>

  <label>Days Purchased</label>
  <input type="number" name="daysPurchased" id="daysPurchased" required>

  <label>Total Fee</label>
  <input type="number" name="totalFee" id="totalFee" required>

  <label>Paid Amount</label>
  <input type="number" name="paidAmount" id="paidAmount" required>

  <label>Balance</label>
  <input type="text" name="balance" id="balance" readonly>

  <label>Payment Mode</label>
  <select name="paymentMode">
    <option>Cash</option>
    <option>Online</option>
    <option>UPI</option>
    <option>Bank Transfer</option>
  </select>

  <label>Remarks</label>
  <input type="text" name="remarks">

  <label>Payment Status</label>
  <select name="paymentStatus">
    <option>Paid</option>
    <option>Partially Paid</option>
    <option>Pending</option>
  </select>

  <button type="submit">Submit & View Slip</button>
</form>

<!-- POPUP -->
<div class="slip-popup" id="slipPopup"></div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('billDate').value = today;

    google.script.run.withSuccessHandler(fillClasses).getClassList();
    google.script.run.withSuccessHandler(val => document.getElementById('receiptNo').value = val).getNextReceiptNumber();
  });

  document.getElementById('classSelect').addEventListener('change', e => {
    google.script.run.withSuccessHandler(fillStudents).getStudentsByClass(e.target.value);
  });

  function fillClasses(classes) {
    const select = document.getElementById('classSelect');
    select.innerHTML = '';
    classes.forEach(c => {
      const opt = document.createElement('option');
      opt.text = c;
      select.add(opt);
    });
    google.script.run.withSuccessHandler(fillStudents).getStudentsByClass(select.value);
  }

  function fillStudents(students) {
    const studentSelect = document.getElementById('studentSelect');
    studentSelect.innerHTML = '';
    students.forEach(stu => {
      const opt = document.createElement('option');
      opt.text = stu.name;
      opt.value = stu.id;
      studentSelect.add(opt);
    });
    document.getElementById('studentId').value = studentSelect.options[0]?.value || '';
  }

  document.getElementById('studentSelect').addEventListener('change', e => {
    document.getElementById('studentId').value = e.target.value;
  });

  document.getElementById('paidAmount').addEventListener('input', calculateBalance);
  document.getElementById('totalFee').addEventListener('input', calculateBalance);

  function calculateBalance() {
    const total = parseFloat(document.getElementById('totalFee').value) || 0;
    const paid = parseFloat(document.getElementById('paidAmount').value) || 0;
    document.getElementById('balance').value = total - paid;
  }

  document.getElementById('billingForm').addEventListener('submit', e => {
    e.preventDefault();
    const formData = Object.fromEntries(new FormData(e.target).entries());

    google.script.run.withSuccessHandler(() => {
      showSlip(formData);
    }).submitBillingData(formData);
  });

  function showSlip(data) {
    const popup = document.getElementById('slipPopup');
    popup.innerHTML = `
      <h2>Fee Receipt</h2>
      <p><strong>Date:</strong> ${data.billDate}</p>
      <p><strong>Receipt No:</strong> ${data.receiptNo}</p>
      <p><strong>Student:</strong> ${data.studentName} (${data.studentId})</p>
      <p><strong>Class:</strong> ${data.class}</p>
      <p><strong>Fee Plan:</strong> ${data.feePlan}</p>
      <p><strong>Start Date:</strong> ${data.classStartDate}</p>
      <p><strong>Total Fee:</strong> ₹${data.totalFee}</p>
      <p><strong>Paid:</strong> ₹${data.paidAmount}</p>
      <p><strong>Balance:</strong> ₹${data.balance}</p>
      <p><strong>Status:</strong> ${data.paymentStatus}</p>
      <button onclick="print()">Download Slip</button>
    `;
    popup.style.display = 'block';
  }

  function print() {
    const printWindow = window.open('', '_blank');
    printWindow.document.write('<html><head><title>Slip</title></head><body>' + document.getElementById('slipPopup').innerHTML + '</body></html>');
    printWindow.document.close();
    printWindow.print();
  }
</script>

</body>
</html>
