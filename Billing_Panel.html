<!DOCTYPE html>
<html>
<head>
  <title>Billing Panel - Alif Edu</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #ffffff;
      margin: 20px;
    }
    h2 {
      color: #0A1172;
    }
    .container {
      border: 2px solid #FFD700;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    label {
      font-weight: bold;
      color: #0A1172;
    }
    input, select, textarea {
      width: 100%;
      padding: 8px;
      margin-top: 4px;
      margin-bottom: 12px;
      border: 1px solid #ccc;
      border-radius: 6px;
    }
    button {
      background-color: #0A1172;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    button:hover {
      background-color: #FFD700;
      color: #0A1172;
    }
    .fee-slip {
      display: none;
      position: fixed;
      top: 10%;
      left: 25%;
      width: 50%;
      background: white;
      border: 3px solid #0A1172;
      border-radius: 10px;
      padding: 20px;
      z-index: 10;
      box-shadow: 0 0 15px rgba(0,0,0,0.3);
    }
    .fee-slip h3 {
      color: #0A1172;
      text-align: center;
    }
    .overlay {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background-color: rgba(0, 0, 0, 0.4);
      z-index: 5;
    }
  </style>
</head>
<body>

<div class="container">
  <h2>Billing Panel - Alif Edu</h2>
  <label>Bill Date:</label>
  <input type="date" id="billDate" readonly>

  <label>Receipt No:</label>
  <input type="text" id="receiptNo" readonly>

  <label>Class:</label>
  <select id="classSelect" onchange="loadStudents()">
    <option value="">--Select Class--</option>
    <option value="Class 1">Class 1</option>
    <option value="Class 2">Class 2</option>
    <!-- Add more as needed -->
  </select>

  <label>Student Name:</label>
  <select id="studentSelect" onchange="fillStudentId()"></select>

  <label>Student ID:</label>
  <input type="text" id="studentId" readonly>

  <label>Fee Plan:</label>
  <select id="feePlan" onchange="updateTotalFee()">
    <option value="">--Select--</option>
    <option value="Basic">Basic</option>
    <option value="Standard">Standard</option>
    <option value="Premium">Premium</option>
  </select>

  <label>Class Start Date:</label>
  <input type="date" id="startDate">

  <label>Days Purchased:</label>
  <input type="number" id="daysPurchased" onchange="updateTotalFee()">

  <label>Total Fee:</label>
  <input type="number" id="totalFee" readonly>

  <label>Paid Amount:</label>
  <input type="number" id="paidAmount" onchange="updateBalance()">

  <label>Balance:</label>
  <input type="number" id="balance" readonly>

  <label>Payment Mode:</label>
  <select id="paymentMode">
    <option value="Cash">Cash</option>
    <option value="Online">Online</option>
  </select>

  <label>Remarks:</label>
  <textarea id="remarks"></textarea>

  <label>Payment Status:</label>
  <select id="paymentStatus">
    <option value="Paid">Paid</option>
    <option value="Partial">Partial</option>
    <option value="Unpaid">Unpaid</option>
  </select>

  <button onclick="submitData()">Submit</button>
  <button onclick="showSlip()">View Fee Slip</button>
  <button onclick="window.print()">Download</button>
  <button onclick="location.href='dashboard.html'">Dashboard</button>
</div>

<div class="overlay" id="overlay" onclick="hideSlip()"></div>
<div class="fee-slip" id="feeSlip">
  <h3>Fee Slip</h3>
  <p id="slipContent"></p>
</div>

<script>
  let studentData = {}; // fetched from Google Sheet

  function updateTotalFee() {
    const plan = document.getElementById("feePlan").value;
    const days = Number(document.getElementById("daysPurchased").value || 0);
    const rates = { Basic: 100, Standard: 200, Premium: 300 };
    document.getElementById("totalFee").value = days * (rates[plan] || 0);
    updateBalance();
  }

  function updateBalance() {
    const total = Number(document.getElementById("totalFee").value);
    const paid = Number(document.getElementById("paidAmount").value || 0);
    document.getElementById("balance").value = total - paid;
  }

  function fillStudentId() {
    const name = document.getElementById("studentSelect").value;
    const id = studentData[name];
    document.getElementById("studentId").value = id || '';
  }

  function loadStudents() {
    const selectedClass = document.getElementById("classSelect").value;
    google.script.run.withSuccessHandler((data) => {
      studentData = {};
      const studentSelect = document.getElementById("studentSelect");
      studentSelect.innerHTML = "<option value=''>--Select--</option>";
      data.forEach(row => {
        if (row[0] === selectedClass) {
          studentData[row[2]] = row[1]; // name: ID
          studentSelect.innerHTML += `<option value="${row[2]}">${row[2]}</option>`;
        }
      });
    }).getStudentList();
  }

  function submitData() {
    const data = {
      billDate: document.getElementById("billDate").value,
      receiptNo: document.getElementById("receiptNo").value,
      class: document.getElementById("classSelect").value,
      studentName: document.getElementById("studentSelect").value,
      studentId: document.getElementById("studentId").value,
      feePlan: document.getElementById("feePlan").value,
      startDate: document.getElementById("startDate").value,
      daysPurchased: document.getElementById("daysPurchased").value,
      totalFee: document.getElementById("totalFee").value,
      paidAmount: document.getElementById("paidAmount").value,
      balance: document.getElementById("balance").value,
      paymentMode: document.getElementById("paymentMode").value,
      remarks: document.getElementById("remarks").value,
      paymentStatus: document.getElementById("paymentStatus").value,
    };
    google.script.run.storeBillingData(data);
    alert("Billing data submitted!");
  }

  function showSlip() {
    let content = `
      <strong>Bill Date:</strong> ${document.getElementById("billDate").value}<br>
      <strong>Receipt No:</strong> ${document.getElementById("receiptNo").value}<br>
      <strong>Class:</strong> ${document.getElementById("classSelect").value}<br>
      <strong>Student:</strong> ${document.getElementById("studentSelect").value}<br>
      <strong>Fee Plan:</strong> ${document.getElementById("feePlan").value}<br>
      <strong>Total:</strong> ₹${document.getElementById("totalFee").value}<br>
      <strong>Paid:</strong> ₹${document.getElementById("paidAmount").value}<br>
      <strong>Balance:</strong> ₹${document.getElementById("balance").value}<br>
    `;
    document.getElementById("slipContent").innerHTML = content;
    document.getElementById("overlay").style.display = "block";
    document.getElementById("feeSlip").style.display = "block";
  }

  function hideSlip() {
    document.getElementById("overlay").style.display = "none";
    document.getElementById("feeSlip").style.display = "none";
  }

  window.onload = () => {
    const today = new Date().toISOString().split("T")[0];
    document.getElementById("billDate").value = today;
    google.script.run.withSuccessHandler(num => {
      document.getElementById("receiptNo").value = num;
    }).getNextReceiptNo();
  }
</script>

</body>
</html>
