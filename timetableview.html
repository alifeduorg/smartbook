<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Student Timetable Viewer</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        /* Define CSS Variables for a consistent and friendly color palette */
        :root {
            --primary-dark-blue: #1A3A5E; /* Deep, professional blue for main elements */
            --secondary-accent-yellow: #FFC107; /* Bright, inviting yellow for highlights */
            --light-bg-blue: #E3F2FD; /* Very light blue for overall background */
            --mid-bg-blue: #BBDEFB; /* Slightly darker blue for gradient transitions */
            --text-dark: #333; /* Standard dark text color */
            --text-light: #fff; /* White text for dark backgrounds */
            --border-color: #D0D0D0; /* Light border for inputs and elements */
            --shadow-light: 0 4px 15px rgba(0, 0, 0, 0.08); /* Subtle shadow */
            --shadow-medium: 0 8px 25px rgba(0, 0, 0, 0.12); /* More pronounced shadow */
            --shadow-deep: 0 12px 30px rgba(0, 0, 0, 0.15); /* Deeper shadow for hover/focus */
            --border-radius-sm: 10px; /* Small border radius */
            --border-radius-md: 15px; /* Medium border radius */
            --border-radius-lg: 20px; /* Large border radius for containers */
        }

        /* General Body and Font Styles */
        body {
            margin: 0;
            padding: 20px; /* Adjusted padding for better responsiveness */
            font-family: 'Inter', sans-serif; /* Modern, clean font */
            background: linear-gradient(135deg, var(--light-bg-blue), var(--mid-bg-blue)); /* Soft blue gradient */
            color: var(--text-dark);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative; /* Needed for absolute positioning of background animation */
            overflow-x: hidden; /* Hide horizontal overflow */
        }

        /* Layered Background Animation - Large, subtle shapes */
        body::before,
        body::after {
            content: '';
            position: absolute;
            background: rgba(255, 255, 255, 0.3); /* Translucent white for a dreamy effect */
            border-radius: 50%; /* Circular shapes */
            opacity: 0.6;
            filter: blur(80px); /* Soft blur */
            z-index: -2; /* Behind all content and other animation layer */
        }

        body::before {
            width: 350px;
            height: 350px;
            top: -70px;
            left: -70px;
            animation: moveShapeOne 18s infinite alternate ease-in-out; /* Slower, unique animation */
        }

        body::after {
            width: 450px;
            height: 450px;
            bottom: -100px;
            right: -100px;
            animation: moveShapeTwo 22s infinite alternate-reverse ease-in-out; /* Different timing for variety */
        }

        @keyframes moveShapeOne {
            0% { transform: translate(0, 0) scale(1); }
            25% { transform: translate(60px, -40px) scale(1.08); }
            50% { transform: translate(-20px, 70px) scale(0.98); }
            75% { transform: translate(80px, 30px) scale(1.05); }
            100% { transform: translate(0, 0) scale(1); }
        }

        @keyframes moveShapeTwo {
            0% { transform: translate(0, 0) scale(1); }
            50% { transform: translate(-25px, 25px) rotate(180deg); }
            100% { transform: translate(0, 0) rotate(360deg); }
        }

        /* Background Animation - Smaller, more dynamic shapes */
        .background-animation {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            z-index: -1; /* Ensure it stays behind content, but above body::before/after */
        }

        .shape {
            position: absolute;
            background: rgba(255, 255, 255, 0.15); /* Semi-transparent white */
            border-radius: 50%;
            animation: float 15s infinite ease-in-out alternate;
            opacity: 0.7;
            filter: blur(20px); /* Slightly less blur for these shapes */
        }

        .shape:nth-child(1) {
            width: 90px; height: 90px; left: 10%; top: 20%;
            animation-duration: 18s;
            background: rgba(26, 58, 94, 0.1); /* Using RGB values for --primary-dark-blue */
        }

        .shape:nth-child(2) {
            width: 130px; height: 130px; left: 70%; top: 50%;
            animation-duration: 22s;
            background: rgba(255, 193, 7, 0.15); /* Yellow hint */
        }

        .shape:nth-child(3) {
            width: 70px; height: 70px; left: 40%; top: 80%;
            animation-duration: 16s;
        }

        .shape:nth-child(4) {
            width: 110px; height: 110px; left: 85%; top: 10%;
            animation-duration: 20s;
            background: rgba(26, 58, 94, 0.1);
        }

        .shape:nth-child(5) {
            width: 100px; height: 100px; left: 20%; top: 60%;
            animation-duration: 19s;
            background: rgba(255, 193, 7, 0.15);
        }

        @keyframes float {
            0% { transform: translate(0, 0) rotate(0deg); }
            50% { transform: translate(25px, -25px) rotate(180deg); } /* Slightly more movement */
            100% { transform: translate(0, 0) rotate(360deg); }
        }

        /* Header Styles */
        header {
            padding: 1rem 2rem;
            background: var(--primary-dark-blue); /* Dark blue header */
            color: var(--text-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow-medium); /* Enhanced shadow */
            position: relative;
            z-index: 10; /* Ensure header is above background animation */
            border-bottom-left-radius: var(--border-radius-md); /* Rounded bottom corners */
            border-bottom-right-radius: var(--border-radius-md);
        }

        header h1 {
            font-size: 1.8rem;
            margin: 0;
            font-weight: 700;
        }

        /* Dashboard Button */
        .dashboard-button {
            background: var(--secondary-accent-yellow); /* Bright yellow */
            color: var(--primary-dark-blue);
            border: none;
            padding: 0.7rem 1.4rem; /* Slightly larger padding */
            border-radius: 28px; /* More rounded, pill-like */
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease; /* Smooth transition for all properties */
            box-shadow: var(--shadow-light);
        }

        .dashboard-button:hover {
            background: #FFD54F; /* Lighter yellow on hover */
            transform: translateY(-3px); /* Slight lift effect */
            box-shadow: var(--shadow-medium);
        }

        /* Main Container */
        .container {
            padding: 2rem;
            max-width: 900px; /* Max width for better readability on large screens */
            margin: 2rem auto; /* Center container with margin */
            background: rgba(255, 255, 255, 0.95); /* Semi-transparent white background for content */
            border-radius: var(--border-radius-lg); /* More rounded corners */
            box-shadow: var(--shadow-medium); /* Softer, larger shadow */
            flex-grow: 1; /* Allow container to grow and fill space */
            position: relative;
            z-index: 5; /* Above background, below header */
            backdrop-filter: blur(8px); /* Subtle glassmorphism on container */
            -webkit-backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.3); /* Light border for glass effect */
        }

        /* Form Elements (Select, Input) */
        select, input[type="date"] {
            padding: 0.9rem 1.2rem; /* Increased padding */
            border-radius: var(--border-radius-md); /* More rounded */
            border: 1px solid var(--border-color); /* Lighter border */
            font-size: 1rem;
            margin: 0.75rem 0 1.5rem 0; /* More margin below */
            width: calc(100% - 2.4rem); /* Adjust width for padding */
            max-width: 400px;
            display: block;
            box-shadow: inset 0 1px 4px rgba(0, 0, 0, 0.08); /* Inner shadow */
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
            background-color: #fcfcfc; /* Slightly off-white background */
        }

        select:focus, input[type="date"]:focus {
            outline: none;
            border-color: var(--secondary-accent-yellow); /* Yellow border on focus */
            box-shadow: 0 0 0 4px rgba(255, 193, 7, 0.3); /* Glow effect on focus */
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #555;
        }

        /* Action Buttons Styling (Run, Download) */
        .action-button-group {
            display: flex;
            flex-direction: column; /* Stack buttons on smaller screens */
            gap: 15px; /* Space between buttons */
            margin-top: 2.5rem;
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
        }

        .action-button-group button {
            padding: 1rem 2rem; /* Larger padding */
            border: none;
            border-radius: var(--border-radius-md); /* More rounded */
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-medium);
            display: flex; /* Use flexbox for spinner */
            align-items: center;
            justify-content: center;
            gap: 10px; /* Space between text and spinner */
            width: 100%; /* Ensure buttons take full width of group */
        }

        .action-button-group button:hover {
            transform: translateY(-3px); /* More pronounced lift */
            box-shadow: var(--shadow-deep);
        }

        .show-timetable-btn {
            background-color: var(--secondary-accent-yellow);
            color: var(--primary-dark-blue);
        }

        .show-timetable-btn:hover {
            background-color: #FFD54F; /* Lighter yellow on hover */
        }

        .download-btn {
            background-color: var(--primary-dark-blue);
            color: var(--text-light);
        }

        .download-btn:hover {
            background-color: #2A4D75; /* Darker blue on hover */
        }

        /* Spinner for Buttons */
        .action-button-group button .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid var(--text-light); /* Spinner color matches text */
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: none; /* Hidden by default */
        }

        .show-timetable-btn .spinner {
             border-top: 4px solid var(--primary-dark-blue); /* Yellow button spinner uses dark blue */
        }


        .action-button-group button.loading .spinner {
            display: block; /* Show spinner when loading */
        }

        .action-button-group button.loading span {
            display: none; /* Hide text when loading */
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Table Styles */
        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            box-shadow: var(--shadow-medium); /* Deeper shadow */
            border-radius: var(--border-radius-md); /* More rounded table */
            overflow: hidden; /* Ensures rounded corners are visible */
            background: white;
            margin-top: 2rem;
            border: 1px solid #f0f0f0; /* Light border for table */
        }

        thead {
            background: var(--primary-dark-blue); /* Dark blue header */
            color: var(--text-light);
        }

        th, td {
            padding: 1rem 1.2rem; /* Increased padding */
            text-align: left;
            border-bottom: 1px solid #f0f0f0; /* Lighter border for rows */
        }

        tbody tr:nth-child(even) {
            background-color: #f8fcfd; /* Light stripe for even rows */
        }

        tbody tr:hover {
            background-color: #e6f7ff; /* Lighter blue on hover */
            cursor: pointer;
        }

        /* Custom Modal for Alerts */
        .modal {
            display: none; /* Hidden by default */
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5); /* Darker overlay */
            justify-content: center;
            align-items: center;
            opacity: 0; /* For fade-in effect */
            transition: opacity 0.3s ease;
        }

        .modal.show { /* Class to show modal */
            display: flex;
            opacity: 1;
        }

        .modal-content {
            background-color: #fefefe;
            padding: 30px;
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-deep);
            width: 80%;
            max-width: 450px; /* Slightly larger modal */
            text-align: center;
            position: relative;
            transform: translateY(-20px); /* For slide-in effect */
            transition: transform 0.3s ease;
        }

        .modal.show .modal-content {
            transform: translateY(0);
        }

        .modal-content h3 {
            color: var(--primary-dark-blue);
            margin-top: 0;
            font-size: 1.5rem; /* Slightly larger title */
        }

        .modal-content p {
            margin-bottom: 25px;
            font-size: 1.1rem;
            line-height: 1.5;
        }

        .modal-close-btn {
            background-color: var(--secondary-accent-yellow);
            color: var(--primary-dark-blue);
            border: none;
            padding: 12px 30px; /* Larger button */
            border-radius: var(--border-radius-md);
            cursor: pointer;
            font-size: 1.1rem; /* Larger font */
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-light);
        }

        .modal-close-btn:hover {
            background-color: #FFD54F;
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }

        /* Scroll Buttons */
        .scroll-button {
            position: fixed;
            right: 25px; /* Slightly more prominent */
            width: 55px; /* Larger buttons */
            height: 55px;
            background-color: var(--primary-dark-blue);
            color: var(--text-light);
            border: none;
            border-radius: 50%;
            font-size: 1.8rem; /* Larger icon */
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: var(--shadow-medium);
            transition: background-color 0.3s ease, transform 0.3s ease, opacity 0.3s ease;
            z-index: 99;
            opacity: 0.9; /* Slightly less opaque */
        }

        .scroll-button:hover {
            background-color: #2A4D75;
            transform: scale(1.1); /* More pronounced scale */
            opacity: 1;
        }

        .scroll-up {
            bottom: 90px; /* Position above scroll-down */
        }

        .scroll-down {
            bottom: 25px;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            body {
                padding: 15px;
            }
            header {
                flex-direction: column;
                padding: 1rem;
                text-align: center;
            }
            header h1 {
                margin-bottom: 0.8rem;
                font-size: 1.6rem;
            }
            .dashboard-button {
                padding: 0.6rem 1.2rem;
                font-size: 0.9rem;
            }
            .container {
                padding: 1.5rem;
                margin: 1.5rem auto;
            }
            th, td {
                padding: 0.8rem;
                font-size: 0.85rem;
            }
            select, input[type="date"] {
                max-width: 100%;
                width: calc(100% - 2.4rem); /* Adjust for padding in smaller screens */
                padding: 0.7rem 1.2rem;
                font-size: 0.9rem;
            }
            .action-button-group button {
                padding: 0.8rem 1.5rem;
                font-size: 1rem;
            }
            .scroll-button {
                width: 45px;
                height: 45px;
                font-size: 1.5rem;
                right: 15px;
            }
            .scroll-up {
                bottom: 75px;
            }
            .scroll-down {
                bottom: 15px;
            }
            .modal-content {
                padding: 20px;
                width: 95%;
            }
            .modal-content h3 {
                font-size: 1.3rem;
            }
            .modal-content p {
                font-size: 1rem;
            }
            .modal-close-btn {
                padding: 10px 20px;
                font-size: 1rem;
            }
        }

        @media (max-width: 480px) {
            body {
                padding: 10px;
            }
            header {
                padding: 0.8rem;
            }
            header h1 {
                font-size: 1.4rem;
            }
            .container {
                padding: 1rem;
                margin: 1rem auto;
            }
            th, td {
                padding: 0.5rem;
                font-size: 0.8rem;
            }
            select, input[type="date"] {
                padding: 0.6rem 1rem;
                font-size: 0.85rem;
            }
            .scroll-button {
                width: 40px;
                height: 40px;
                font-size: 1.3rem;
                right: 10px;
            }
            .scroll-up {
                bottom: 60px;
            }
            .scroll-down {
                bottom: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="background-animation">
        <div class="shape"></div>
        <div class="shape"></div>
        <div class="shape"></div>
        <div class="shape"></div>
        <div class="shape"></div>
    </div>

    <header>
        <h1>Student Timetable</h1>
        <button class="dashboard-button" onclick="goToDashboard()">Back to Dashboard</button>
    </header>

    <div class="container">
        <label for="studentSelect">Select Student</label>
        <select id="studentSelect">
            <option value="">Select Student</option>
        </select>

        <label for="startDate">Start Date</label>
        <input type="date" id="startDate" />

        <label for="endDate">End Date</label>
        <input type="date" id="endDate" />

        <div class="action-button-group">
            <button class="show-timetable-btn" id="showTimetableBtn">
                <span class="spinner"></span>
                <span>Show Timetable</span>
            </button>
            <button class="download-btn" id="downloadBtn">
                <span class="spinner"></span>
                <span>Download Timetable as PDF</span>
            </button>
        </div>

        <table id="timetable">
            <thead>
                <tr>
                    <th>Week Start</th>
                    <th>Day</th>
                    <th>Time</th>
                    <th>Subject</th>
                    <th>Teacher</th>
                </tr>
            </thead>
            <tbody>
                <!-- Timetable data will be inserted here -->
            </tbody>
        </table>


    </div>

    <div id="messageModal" class="modal">
        <div class="modal-content">
            <h3 id="modalTitle"></h3>
            <p id="modalMessage"></p>
            <button class="modal-close-btn" onclick="hideModal()">OK</button>
        </div>
    </div>

    <button class="scroll-button scroll-up" onclick="scrollToTop()">&#9650;</button>
    <button class="scroll-button scroll-down" onclick="scrollToBottom()">&#9660;</button>

    <script>
        // Google Sheet URL for timetable data
        const sheetURL = 'https://script.google.com/macros/s/AKfycbzARIynxtCX1rbMPIfY0Uwnwfk2ozLYmifGK5pA49J1a8G8ad1Z_DIYvoYXYE1dlJjNNA/exec';
        let timetableData = []; // Array to store fetched timetable data

        // Fetch data from Google Sheet on page load
        fetch(sheetURL)
            .then(res => res.json())
            .then(data => {
                // Sort data by "Week Start" in descending order
                timetableData = data.sort((a, b) => new Date(b["Week Start"]) - new Date(a["Week Start"]));
                populateStudents(timetableData); // Populate student dropdown
                renderTimetable(); // Initial render after data is fetched
            })
            .catch(error => {
                console.error("Error fetching timetable data:", error);
                showModal("Error", "Failed to load timetable data. Please try again later.");
            });

        /**
         * Formats an ISO date string to YYYY-MM-DD format.
         * @param {string} isoString - The ISO date string.
         * @returns {string} Formatted date string or empty string if input is invalid.
         */
        function formatDate(isoString) {
            if (!isoString) return '';
            const date = new Date(isoString);
            // Ensure date is valid before formatting
            if (isNaN(date.getTime())) return '';
            return date.toISOString().split('T')[0];
        }

        /**
         * Formats an ISO date string to HH:MM AM/PM format.
         * @param {string} isoString - The ISO date string.
         * @returns {string} Formatted time string or empty string if input is invalid.
         */
        function formatTime(isoString) {
            if (!isoString) return '';
            const date = new Date(isoString);
            // Ensure date is valid before formatting
            if (isNaN(date.getTime())) return '';
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        /**
         * Populates the student dropdown with unique student IDs and names.
         * @param {Array<Object>} data - The timetable data.
         */
        function populateStudents(data) {
            const dropdown = document.getElementById('studentSelect');
            const studentMap = new Map(); // Use a Map to store unique student IDs and names

            data.forEach(row => {
                // Explicitly convert to string and handle potential null/undefined values
                const id = String(row["Student ID"] || '').trim();
                const name = String(row["Student Name"] || '').trim();

                if (id && !studentMap.has(id)) {
                    studentMap.set(id, name);
                    const option = document.createElement('option');
                    option.value = id;
                    option.textContent = `${id} - ${name}`;
                    dropdown.appendChild(option);
                }
            });
        }

        /**
         * Renders the timetable based on the selected student and date range.
         */
        function renderTimetable() {
            const selectedID = document.getElementById('studentSelect').value;
            const startDateInput = document.getElementById('startDate').value;
            const endDateInput = document.getElementById('endDate').value;
            const tbody = document.querySelector('#timetable tbody');
            tbody.innerHTML = ''; // Clear existing table rows

            if (!selectedID) {
                // If no student is selected, clear the table and show a message
                const tr = document.createElement('tr');
                tr.innerHTML = `<td colspan="5" style="text-align: center; padding: 20px;">Please select a student to view their timetable.</td>`;
                tbody.appendChild(tr);
                return;
            }

            let currentFilteredData = timetableData.filter(entry => entry["Student ID"] === selectedID);

            // Apply date filtering if both start and end dates are provided
            if (startDateInput && endDateInput) {
                const startDate = new Date(startDateInput);
                const endDate = new Date(endDateInput);

                if (isNaN(startDate.getTime()) || isNaN(endDate.getTime())) {
                    showModal("Invalid Dates", "Please enter valid start and end dates.");
                    return;
                }

                if (startDate > endDate) {
                    showModal("Invalid Date Range", "Start date cannot be after end date.");
                    return;
                }

                currentFilteredData = currentFilteredData.filter(entry => {
                    const weekStart = new Date(entry["Week Start"]);
                    // Normalize dates to start of day for accurate comparison
                    const normalizedWeekStart = new Date(weekStart.getFullYear(), weekStart.getMonth(), weekStart.getDate());
                    const normalizedStartDate = new Date(startDate.getFullYear(), startDate.getMonth(), startDate.getDate());
                    const normalizedEndDate = new Date(endDate.getFullYear(), endDate.getMonth(), endDate.getDate());

                    return normalizedWeekStart >= normalizedStartDate && normalizedWeekStart <= normalizedEndDate;
                });
            } else if (startDateInput || endDateInput) {
                // If only one date is provided
                showModal("Missing Date", "Please select both start and end dates to filter by date range, or leave both empty to see all timetable data for the selected student.");
                 // Optionally clear dates here if user wants to retry
                 document.getElementById('startDate').value = '';
                 document.getElementById('endDate').value = '';
                return;
            }

            if (currentFilteredData.length === 0) {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td colspan="5" style="text-align: center; padding: 20px;">No timetable data found for the selected student and date range.</td>`;
                tbody.appendChild(tr);
                return;
            }

            // Populate the table with filtered data
            currentFilteredData.forEach(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${formatDate(row["Week Start"] || '')}</td>
                    <td>${row["Day"] || ''}</td>
                    <td>${formatTime(row["Time"] || '')}</td>
                    <td>${row["Subject"] || ''}</td>
                    <td>${row["Teacher"] || ''}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        // Event listener for student selection change
        document.getElementById('studentSelect').addEventListener('change', renderTimetable);

        // Event listener for the new 'Show Timetable' button click
        document.getElementById('showTimetableBtn').addEventListener('click', renderTimetable);

        // Event listener for download button click
        document.getElementById('downloadBtn').addEventListener('click', async () => {
            const downloadBtn = document.getElementById('downloadBtn');
            downloadBtn.classList.add('loading'); // Add loading class
            downloadBtn.disabled = true; // Disable button during download

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            const selectedID = document.getElementById('studentSelect').value;
            const startDateInput = document.getElementById('startDate').value;
            const endDateInput = document.getElementById('endDate').value;

            // Validate inputs
            if (!selectedID) {
                showModal("Missing Selection", "Please select a student.");
                downloadBtn.classList.remove('loading');
                downloadBtn.disabled = false;
                return;
            }
            if (!startDateInput || !endDateInput) {
                showModal("Missing Dates", "Please select both start and end dates to download PDF.");
                downloadBtn.classList.remove('loading');
                downloadBtn.disabled = false;
                return;
            }

            const startDate = new Date(startDateInput);
            const endDate = new Date(endDateInput);

            if (isNaN(startDate.getTime()) || isNaN(endDate.getTime())) {
                showModal("Invalid Dates", "Please enter valid start and end dates.");
                downloadBtn.classList.remove('loading');
                downloadBtn.disabled = false;
                return;
            }

            if (startDate > endDate) {
                showModal("Invalid Date Range", "Start date cannot be after end date.");
                downloadBtn.classList.remove('loading');
                downloadBtn.disabled = false;
                return;
            }

            // Filter data based on selected student and date range for PDF
            const filteredForPdf = timetableData.filter(entry => {
                const weekStart = new Date(entry["Week Start"]);
                const normalizedWeekStart = new Date(weekStart.getFullYear(), weekStart.getMonth(), weekStart.getDate());
                const normalizedStartDate = new Date(startDate.getFullYear(), startDate.getMonth(), startDate.getDate());
                const normalizedEndDate = new Date(endDate.getFullYear(), endDate.getMonth(), endDate.getDate());
                return entry["Student ID"] === selectedID && normalizedWeekStart >= normalizedStartDate && normalizedWeekStart <= normalizedEndDate;
            });

            if (filteredForPdf.length === 0) {
                showModal("No Data", "No timetable data found for the selected student and date range to generate PDF.");
                downloadBtn.classList.remove('loading');
                downloadBtn.disabled = false;
                return;
            }

            try {
                // Generate PDF content
                let y = 20;
                doc.setFontSize(14);
                doc.text(`Student Timetable for ID: ${selectedID}`, 10, y);
                y += 10;
                doc.setFontSize(10);
                doc.text(`From: ${formatDate(startDateInput)} To: ${formatDate(endDateInput)}`, 10, y);
                y += 15;

                // Add table headers to PDF
                doc.setFontSize(10);
                doc.text("Week Start", 10, y);
                doc.text("Day", 40, y);
                doc.text("Time", 70, y);
                doc.text("Subject", 100, y);
                doc.text("Teacher", 150, y);
                y += 5;
                doc.line(10, y, 200, y); // Draw a line under headers
                y += 5;

                // Add timetable entries to PDF
                filteredForPdf.forEach(row => {
                    if (y > 270) { // Check if new page is needed (approx height)
                        doc.addPage();
                        y = 20;
                        doc.setFontSize(14);
                        doc.text(`Student Timetable for ID: ${selectedID} (Cont.)`, 10, y);
                        y += 10;
                        doc.setFontSize(10);
                        doc.text(`From: ${formatDate(startDateInput)} To: ${formatDate(endDateInput)}`, 10, y);
                        y += 15;
                        doc.text("Week Start", 10, y);
                        doc.text("Day", 40, y);
                        doc.text("Time", 70, y);
                        doc.text("Subject", 100, y);
                        doc.text("Teacher", 150, y);
                        y += 5;
                        doc.line(10, y, 200, y);
                        y += 5;
                    }
                    doc.text(formatDate(row["Week Start"] || ''), 10, y);
                    doc.text(row["Day"] || '', 40, y);
                    doc.text(formatTime(row["Time"] || ''), 70, y);
                    doc.text(row["Subject"] || '', 100, y);
                    doc.text(row["Teacher"] || '', 150, y);
                    y += 8;
                });

                // Save the PDF
                doc.save(`Timetable_${selectedID}_${formatDate(startDateInput)}_to_${formatDate(endDateInput)}.pdf`);
                showModal("Success!", "Timetable PDF downloaded successfully.");
            } catch (error) {
                console.error("Error generating PDF:", error);
                showModal("Error", "Failed to generate PDF. Please try again.");
            } finally {
                downloadBtn.classList.remove('loading'); // Remove loading class
                downloadBtn.disabled = false; // Re-enable button
            }
        });

        /**
         * Navigates back to the previous page (dashboard).
         */
        function goToDashboard() {
            window.history.back();
        }

        /* Custom Modal Functions */
        const messageModal = document.getElementById('messageModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalMessage = document.getElementById('modalMessage');

        /**
         * Displays the custom message modal.
         * @param {string} title - The title of the message.
         * @param {string} message - The content of the message.
         */
        function showModal(title, message) {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            messageModal.classList.add('show'); // Add 'show' class to trigger display and animation
        }

        /**
         * Hides the custom message modal.
         */
        function hideModal() {
            messageModal.classList.remove('show'); // Remove 'show' class to hide and trigger animation
        }

        /**
         * Scrolls the window to the top of the page.
         */
        function scrollToTop() {
            window.scrollTo({
                top: 0,
                behavior: 'smooth' // Smooth scrolling
            });
        }

        /**
         * Scrolls the window to the bottom of the page.
         */
        function scrollToBottom() {
            window.scrollTo({
                top: document.body.scrollHeight,
                behavior: 'smooth' // Smooth scrolling
            });
        }
    </script>
</body>
</html>
