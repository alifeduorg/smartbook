<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Student Timetable Viewer</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Define CSS Variables for a consistent and friendly color palette */
        :root {
            --primary-dark-blue: #0E2945; /* Deeper, richer navy blue */
            --primary-medium-blue: #1A3A5E; /* Original primary dark blue, now for gradients */
            --primary-light-blue: #3E6A8A; /* Slightly lighter shade for more dynamic gradients */
            --secondary-accent-yellow: #FFC107; /* Bright, inviting yellow */
            --secondary-light-yellow: #FFD54F; /* Lighter yellow for hover states */
            --tertiary-green: #4CAF50; /* Green for JPEG download */
            --tertiary-light-green: #66BB6A; /* Lighter green for hover */
            --quaternary-purple: #8A2BE2; /* New color for "Download All" */
            --quaternary-light-purple: #9932CC; /* Lighter purple for hover */
            --light-bg-color: #F8F9FA; /* Very light, almost white for primary backgrounds */
            --mid-bg-color: #E2EBF1; /* A subtle cool grey/blue for background transitions */
            --text-dark: #2C3E50; /* Darker text for better contrast */
            --text-light: #fff; /* White text for dark backgrounds */
            --border-color-light: #DCE4EA; /* Very light border for table cells */
            --border-color-medium: #AABFCF; /* Slightly more defined border for inputs */
            --shadow-subtle: 0 2px 8px rgba(0, 0, 0, 0.05); /* Very light shadow */
            --shadow-default: 0 6px 20px rgba(0, 0, 0, 0.1); /* Standard shadow */
            --shadow-hover: 0 12px 30px rgba(0, 0, 0, 0.15); /* More pronounced shadow for hover/focus */
            --border-radius-sm: 10px; /* Small border radius */
            --border-radius-md: 16px; /* Medium border radius */
            --border-radius-lg: 24px; /* Large border radius for containers */
        }

        /* General Body and Font Styles */
        body {
            margin: 0;
            padding: 25px; /* Increased padding for more breathing room, especially on mobile */
            font-family: 'Inter', sans-serif; /* Modern, clean font */
            background: linear-gradient(135deg, var(--light-bg-color), var(--mid-bg-color)); /* Soft, cool gradient */
            color: var(--text-dark);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Layered Background Animation - Large, subtle shapes */
        body::before,
        body::after {
            content: '';
            position: absolute;
            background: rgba(255, 255, 255, 0.2); /* Slightly less opaque white for dreamy effect */
            border-radius: 50%;
            opacity: 0.6;
            filter: blur(90px); /* Increased blur */
            z-index: -2;
        }

        body::before {
            width: 380px;
            height: 380px;
            top: -90px;
            left: -90px;
            animation: moveShapeOne 20s infinite alternate ease-in-out; /* Adjusted animation timing */
        }

        body::after {
            width: 480px;
            height: 480px;
            bottom: -120px;
            right: -120px;
            animation: moveShapeTwo 25s infinite alternate-reverse ease-in-out; /* Adjusted animation timing */
        }

        @keyframes moveShapeOne {
            0% { transform: translate(0, 0) scale(1); }
            25% { transform: translate(70px, -50px) scale(1.09); }
            50% { transform: translate(-30px, 80px) scale(0.97); }
            75% { transform: translate(90px, 40px) scale(1.06); }
            100% { transform: translate(0, 0) scale(1); }
        }

        @keyframes moveShapeTwo {
            0% { transform: translate(0, 0) scale(1); }
            50% { transform: translate(-60px, 40px) scale(0.94); }
            100% { transform: translate(0, 0) scale(1); }
        }

        /* Background Animation - Smaller, more dynamic shapes */
        .background-animation {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            z-index: -1;
        }

        .shape {
            position: absolute;
            background: rgba(255, 255, 255, 0.1); /* Very subtle transparent white */
            border-radius: 50%;
            animation: float 18s infinite ease-in-out alternate; /* Adjusted timing */
            opacity: 0.6; /* Slightly less opaque */
            filter: blur(25px); /* Increased blur */
        }

        .shape:nth-child(1) {
            width: 100px; height: 100px; left: 15%; top: 10%;
            animation-duration: 20s;
            background: rgba(14, 41, 69, 0.15); /* Primary dark blue hint */
        }

        .shape:nth-child(2) {
            width: 140px; height: 140px; left: 65%; top: 45%;
            animation-duration: 25s;
            background: rgba(255, 193, 7, 0.1); /* Yellow hint */
        }

        .shape:nth-child(3) {
            width: 80px; height: 80px; left: 30%; top: 75%;
            animation-duration: 17s;
        }

        .shape:nth-child(4) {
            width: 120px; height: 120px; left: 80%; top: 5%;
            animation-duration: 22s;
            background: rgba(14, 41, 69, 0.15);
        }

        .shape:nth-child(5) {
            width: 110px; height: 110px; left: 25%; top: 55%;
            animation-duration: 21s;
            background: rgba(255, 193, 7, 0.1);
        }

        @keyframes float {
            0% { transform: translate(0, 0) rotate(0deg); }
            50% { transform: translate(30px, -30px) rotate(180deg); }
            100% { transform: translate(0, 0) rotate(360deg); }
        }

        /* Header Styles with Animation */
        header {
            padding: 1.2rem 2.5rem; /* Increased padding */
            background: linear-gradient(90deg, var(--primary-dark-blue) 0%, var(--primary-medium-blue) 50%, var(--primary-dark-blue) 100%);
            background-size: 250% 100%; /* Wider gradient for more movement */
            color: var(--text-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow-default); /* Stronger shadow */
            position: relative;
            z-index: 10;
            border-bottom-left-radius: var(--border-radius-md);
            border-bottom-right-radius: var(--border-radius-md);
            animation: headerGradientShift 18s ease infinite alternate; /* Slower, smoother shift */
            overflow: hidden;
            transition: all 0.3s ease-in-out; /* Smooth transition for responsiveness */
        }

        @keyframes headerGradientShift {
            0% { background-position: 0% 50%; }
            100% { background-position: 100% 50%; }
        }

        header h1 {
            font-size: 2rem; /* Larger title */
            margin: 0;
            font-weight: 800; /* Bolder title */
            letter-spacing: 0.5px; /* Slight letter spacing */
            text-shadow: var(--shadow-subtle); /* Subtle text shadow */
        }

        /* Dashboard Button */
        .dashboard-button {
            background: var(--secondary-accent-yellow);
            color: var(--primary-dark-blue);
            border: none;
            padding: 0.8rem 1.6rem; /* Increased padding */
            border-radius: 30px; /* More pill-like */
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease-in-out; /* Smooth transition for all properties */
            box-shadow: var(--shadow-subtle);
            animation: bounceIn 0.8s ease-out;
            min-width: 120px; /* Ensure a decent size */
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .dashboard-button:hover {
            background: var(--secondary-light-yellow);
            transform: translateY(-4px) scale(1.03); /* More pronounced lift and scale */
            box-shadow: var(--shadow-default);
        }

        @keyframes bounceIn {
            0% { opacity: 0; transform: translateY(-30px); }
            60% { opacity: 1; transform: translateY(8px); }
            100% { transform: translateY(0); }
        }

        /* Main Container */
        .container {
            padding: 2.5rem; /* Increased padding */
            max-width: 950px; /* Slightly wider max-width */
            margin: 2.5rem auto; /* More margin for separation */
            background: rgba(255, 255, 255, 0.98); /* Less transparent, more solid white */
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-default); /* Consistent shadow */
            flex-grow: 1;
            position: relative;
            z-index: 5;
            backdrop-filter: blur(10px); /* Increased blur for glassmorphism */
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.5); /* Stronger light border */
            animation: fadeInScale 0.8s ease-out forwards;
        }

        @keyframes fadeInScale {
            0% { opacity: 0; transform: scale(0.95) translateY(20px); }
            100% { opacity: 1; transform: scale(1) translateY(0); }
        }

        /* Form Elements (Select, Input) */
        .form-group {
            margin-bottom: 1.8rem; /* Space between form groups */
        }

        select, input[type="date"] {
            padding: 1rem 1.4rem; /* More padding */
            border-radius: var(--border-radius-md);
            border: 1px solid var(--border-color-medium); /* More visible border */
            font-size: 1.05rem; /* Slightly larger font */
            width: calc(100% - 2.8rem); /* Adjust width for padding */
            max-width: 450px; /* Increased max width */
            display: block;
            box-shadow: inset 0 1px 6px rgba(0, 0, 0, 0.06); /* Deeper inner shadow */
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
            background-color: var(--light-bg-color); /* Light background */
            -webkit-appearance: none;
            color: var(--text-dark); /* Ensure text color is dark */
        }

        select:focus, input[type="date"]:focus {
            outline: none;
            border-color: var(--secondary-accent-yellow);
            box-shadow: 0 0 0 5px rgba(255, 193, 7, 0.4); /* More pronounced glow */
        }

        label {
            display: block;
            margin-bottom: 0.6rem; /* More space below label */
            font-weight: 600;
            color: var(--text-dark); /* Ensure labels are dark */
            font-size: 0.95rem; /* Slightly smaller for labels */
        }

        .date-input-group {
            display: flex;
            flex-direction: column;
            gap: 10px; /* Space between date input and buttons */
            max-width: 450px;
        }

        .date-buttons {
            display: flex;
            gap: 10px;
            margin-top: 5px;
        }

        .date-buttons button {
            flex: 1;
            padding: 0.7rem 1rem;
            border: 1px solid var(--border-color-medium);
            border-radius: var(--border-radius-md);
            background-color: var(--mid-bg-color);
            color: var(--text-dark);
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-subtle);
        }

        .date-buttons button:hover {
            background-color: var(--border-color-light);
            transform: translateY(-2px);
            box-shadow: var(--shadow-default);
        }

        /* Action Buttons Styling (Run, Download) */
        .action-button-group {
            display: flex;
            flex-direction: column;
            gap: 18px; /* More space between buttons */
            margin-top: 3rem; /* More space above buttons */
            max-width: 450px; /* Consistent max width */
            margin-left: auto;
            margin-right: auto;
        }

        .action-button-group button {
            padding: 1.1rem 2.2rem; /* Larger padding */
            border: none;
            border-radius: var(--border-radius-md);
            font-size: 1.15rem; /* Slightly larger font */
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease-in-out;
            box-shadow: var(--shadow-default);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px; /* More space for spinner */
            width: 100%;
            min-height: 55px; /* Increased min-height for better touch target */
            position: relative;
            overflow: hidden;
            letter-spacing: 0.2px; /* Subtle letter spacing */
        }

        .action-button-group button:hover {
            transform: translateY(-4px); /* Consistent lift */
            box-shadow: var(--shadow-hover); /* Deeper shadow on hover */
        }

        /* Ripple effect for buttons */
        .ripple {
            position: absolute;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.8); /* Stronger ripple */
            animation: ripple-animation 0.6s linear forwards;
            transform: scale(0);
            pointer-events: none;
            z-index: 1;
        }

        .show-timetable-btn {
            background-color: var(--secondary-accent-yellow);
            color: var(--primary-dark-blue);
        }

        .show-timetable-btn:hover {
            background-color: var(--secondary-light-yellow);
        }

        .download-btn {
            background-color: var(--primary-dark-blue);
            color: var(--text-light);
        }

        .download-btn:hover {
            background-color: var(--primary-light-blue);
        }

        /* New style for JPEG download button */
        .download-jpeg-btn {
            background-color: var(--tertiary-green); /* A nice green color */
            color: var(--text-light);
        }

        .download-jpeg-btn:hover {
            background-color: var(--tertiary-light-green); /* Lighter green on hover */
        }

        /* Spinner for Buttons */
        .action-button-group button .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid var(--text-light);
            border-radius: 50%;
            width: 22px; /* Slightly larger spinner */
            height: 22px;
            animation: spin 1s linear infinite;
            display: none;
            z-index: 2;
        }

        .show-timetable-btn .spinner {
             border-top: 4px solid var(--primary-dark-blue); /* Yellow button spinner uses dark blue */
        }

        .action-button-group button.loading .spinner {
            display: block;
        }

        .action-button-group button.loading span {
            display: none;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes ripple-animation {
            to {
                transform: scale(4);
                opacity: 0;
            }
        }

        /* Timetable Display Section */
        .timetable-display-section {
            margin-top: 3rem;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.5s ease-out, transform 0.5s ease-out;
        }

        .timetable-display-section.show {
            opacity: 1;
            transform: translateY(0);
        }

        .timetable-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary-dark-blue);
            text-align: center;
            margin-bottom: 1.5rem;
            letter-spacing: 0.5px;
            text-shadow: var(--shadow-subtle);
        }

        /* Table Styles (for the single table) */
        #timetable {
            width: 100%;
            border-collapse: separate; /* Use separate to allow border-radius on outer table */
            border-spacing: 0;
            box-shadow: var(--shadow-default);
            border-radius: var(--border-radius-md);
            overflow: hidden; /* Ensures rounded corners */
            background: white;
            border: 1px solid var(--border-color-light);
            display: table; /* Ensure it's displayed now */
        }

        #timetable thead {
            background: var(--primary-dark-blue);
            color: var(--text-light);
        }

        #timetable th,
        #timetable td {
            padding: 1.1rem 1.4rem;
            text-align: left;
            border-bottom: 1px solid var(--border-color-light);
            font-size: 0.95rem;
        }

        #timetable tbody tr:nth-child(even) {
            background-color: #F8FCFE;
        }

        #timetable tbody tr:last-child td {
            border-bottom: none; /* No border on last row of the main table */
        }

        #timetable tbody tr:hover {
            background-color: #E6F3FF;
            cursor: pointer;
        }

        /* Custom Modal for Alerts */
        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7); /* Darker overlay for strong focus */
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s ease;
            -webkit-backdrop-filter: blur(8px); /* More blur for modal background */
            backdrop-filter: blur(8px);
        }

        .modal.show {
            display: flex;
            opacity: 1;
        }

        .modal-content {
            background-color: #fefefe;
            padding: 35px; /* More padding */
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-hover); /* Prominent shadow */
            width: 85%; /* Wider modal on small screens */
            max-width: 480px; /* Slightly larger max width */
            text-align: center;
            position: relative;
            transform: translateY(-25px); /* More pronounced slide-in */
            transition: transform 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.6); /* More visible glass effect border */
        }

        .modal.show .modal-content {
            transform: translateY(0);
        }

        .modal-content h3 {
            color: var(--primary-dark-blue);
            margin-top: 0;
            font-size: 1.6rem; /* Slightly larger title */
            font-weight: 700;
        }

        .modal-content p {
            margin-bottom: 30px; /* More space below message */
            font-size: 1.15rem; /* Slightly larger font */
            line-height: 1.6; /* Improved line height */
        }

        .modal-close-btn {
            background-color: var(--secondary-accent-yellow);
            color: var(--primary-dark-blue);
            border: none;
            padding: 14px 35px; /* Larger padding */
            border-radius: var(--border-radius-md);
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-subtle);
        }

        .modal-close-btn:hover {
            background-color: var(--secondary-light-yellow);
            transform: translateY(-3px); /* More lift */
            box-shadow: var(--shadow-default);
        }

        /* Scroll Buttons */
        .scroll-button {
            position: fixed;
            right: 30px; /* Further from edge */
            width: 60px; /* Larger buttons */
            height: 60px;
            background-color: var(--primary-dark-blue);
            color: var(--text-light);
            border: none;
            border-radius: 50%;
            font-size: 2rem; /* Larger icon */
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: var(--shadow-default);
            transition: background-color 0.3s ease, transform 0.3s ease, opacity 0.3s ease;
            z-index: 99;
            opacity: 0.9;
        }

        .scroll-button:hover {
            background-color: var(--primary-light-blue);
            transform: scale(1.15); /* More pronounced scale */
            opacity: 1;
        }

        .scroll-up {
            bottom: 100px; /* Adjusted position */
        }

        .scroll-down {
            bottom: 30px; /* Adjusted position */
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            body {
                padding: 18px;
            }
            header {
                padding: 1.2rem;
            }
            header h1 {
                font-size: 1.8rem;
            }
            .dashboard-button {
                padding: 0.7rem 1.4rem;
                font-size: 0.95rem;
            }
            .container {
                padding: 2rem;
                margin: 2rem auto;
            }
            #timetable th, #timetable td {
                padding: 1rem;
                font-size: 0.9rem;
            }
            select, input[type="date"] {
                padding: 0.8rem 1.2rem;
                font-size: 0.95rem;
                width: calc(100% - 2.4rem); /* Adjust for smaller padding */
            }
            .action-button-group button {
                padding: 1rem 1.8rem;
                font-size: 1.05rem;
                min-height: 50px;
            }
            .scroll-button {
                width: 50px;
                height: 50px;
                font-size: 1.6rem;
                right: 20px;
            }
            .scroll-up {
                bottom: 85px;
            }
            .scroll-down {
                bottom: 20px;
            }
            .modal-content {
                padding: 25px;
                width: 90%;
            }
            .modal-content h3 {
                font-size: 1.4rem;
            }
            .modal-content p {
                font-size: 1.05rem;
            }
            .modal-close-btn {
                padding: 12px 25px;
                font-size: 1.05rem;
            }
            .timetable-title {
                font-size: 1.5rem;
            }
            .date-buttons {
                flex-direction: column; /* Stack date buttons on small screens */
            }
        }

        @media (max-width: 480px) {
            body {
                padding: 15px;
            }
            header {
                padding: 1rem;
            }
            header h1 {
                font-size: 1.6rem;
            }
            .container {
                padding: 1.5rem;
                margin: 1.5rem auto;
            }
            #timetable th, #timetable td {
                padding: 0.8rem;
                font-size: 0.85rem;
            }
            select, input[type="date"] {
                padding: 0.7rem 1rem;
                font-size: 0.9rem;
                width: calc(100% - 2rem); /* Adjust for smaller padding */
            }
            .action-button-group {
                gap: 15px;
            }
            .action-button-group button {
                padding: 0.9rem 1.5rem;
                font-size: 1rem;
                min-height: 45px;
            }
            .scroll-button {
                width: 45px;
                height: 45px;
                font-size: 1.4rem;
                right: 15px;
            }
            .scroll-up {
                bottom: 70px;
            }
            .scroll-down {
                bottom: 15px;
            }
            .modal-content {
                padding: 20px;
            }
            .timetable-title {
                font-size: 1.3rem;
            }
        }
    </style>
</head>
<body>
    <div class="background-animation">
        <div class="shape"></div>
        <div class="shape"></div>
        <div class="shape"></div>
        <div class="shape"></div>
        <div class="shape"></div>
    </div>

    <header>
        <h1>Student Timetable</h1>
        <button class="dashboard-button" onclick="goToDashboard()">
            <i class="fas fa-arrow-left"></i> Back to Dashboard
        </button>
    </header>

    <div class="container">
        <div class="form-group">
            <label for="studentSelect">Select Student</label>
            <select id="studentSelect">
                <option value="">Select Student</option>
            </select>
        </div>

        <div class="form-group">
            <label for="startDate">Start Date (for weekly range)</label>
            <div class="date-input-group">
                <input type="date" id="startDate" />
                <div class="date-buttons">
                    <button id="setTodayStartDateBtn">Today</button>
                    <button id="clearStartDateBtn">Clear</button>
                </div>
            </div>
        </div>

        <div class="form-group">
            <label for="endDate">End Date (for weekly range)</label>
            <div class="date-input-group">
                <input type="date" id="endDate" />
                <div class="date-buttons">
                    <button id="setTodayEndDateBtn">Today</button>
                    <button id="clearEndDateBtn">Clear</button>
                </div>
            </div>
        </div>

        <div class="action-button-group">
            <button class="show-timetable-btn" id="showTimetableBtn">
                <span class="spinner"></span>
                <span><i class="fas fa-calendar-alt"></i> Show Timetable</span>
            </button>
            <button class="download-btn" id="downloadPdfBtn">
                <span class="spinner"></span>
                <span><i class="fas fa-file-pdf"></i> Download as PDF</span>
            </button>
            <button class="download-jpeg-btn" id="downloadJpegBtn">
                <span class="spinner"></span>
                <span><i class="fas fa-file-image"></i> Download as JPEG</span>
            </button>
        </div>

        <div class="timetable-display-section" id="timetableDisplaySection">
            <h2 class="timetable-title" id="currentTimetableTitle"></h2>
            <div style="overflow-x: auto;">
                <table id="timetable">
                    <thead>
                        <tr>
                            <th>Day</th>
                            <th>Date</th>
                            <th>Time</th>
                            <th>Subject</th>
                            <th>Teacher</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Timetable data will be inserted here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="messageModal" class="modal">
        <div class="modal-content">
            <h3 id="modalTitle"></h3>
            <p id="modalMessage"></p>
            <button class="modal-close-btn" onclick="hideModal()">OK</button>
        </div>
    </div>

    <button class="scroll-button scroll-up" onclick="scrollToTop()">&#9650;</button>
    <button class="scroll-button scroll-down" onclick="scrollToBottom()">&#9660;</button>

    <script>
        // Google Sheet URL for timetable data
        const sheetURL = 'https://script.google.com/macros/s/AKfycbzARIynxtCX1rbMPIfY0Uwnwfk2ozLYmifGK5pA49J1a8G8ad1Z_DIYvoYXYE1dlJjNNA/exec';
        let timetableData = []; // Array to store fetched timetable data
        let currentDisplayedTimetableData = []; // To store the data currently shown in the table

        // DOM elements
        const studentSelect = document.getElementById('studentSelect');
        const startDateInput = document.getElementById('startDate');
        const endDateInput = document.getElementById('endDate');
        const showTimetableBtn = document.getElementById('showTimetableBtn');
        const downloadPdfBtn = document.getElementById('downloadPdfBtn');
        const downloadJpegBtn = document.getElementById('downloadJpegBtn');
        const timetableTbody = document.querySelector('#timetable tbody');
        const timetableDisplaySection = document.getElementById('timetableDisplaySection');
        const currentTimetableTitle = document.getElementById('currentTimetableTitle');
        const messageModal = document.getElementById('messageModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalMessage = document.getElementById('modalMessage');

        // Function to add ripple effect to buttons
        function addRippleEffect(event) {
            const button = event.currentTarget;
            const circle = document.createElement('span');
            const diameter = Math.max(button.clientWidth, button.clientHeight);
            const radius = diameter / 2;

            circle.style.width = circle.style.height = `${diameter}px`;
            circle.style.left = `${event.clientX - button.offsetLeft - radius}px`;
            circle.style.top = `${event.clientY - button.offsetTop - radius}px`;
            circle.classList.add('ripple');

            const ripple = button.getElementsByClassName('ripple')[0];
            if (ripple) {
                ripple.remove();
            }

            button.appendChild(circle);
        }

        /**
         * Helper to get the date for a specific day of the week within a week starting on a given date.
         * @param {string} weekStartDateISO - The ISO string of the week's start date (e.g., "2023-01-01").
         * @param {string} dayOfWeekString - The name of the day (e.g., "Monday", "Sunday").
         * @returns {Date | null} The Date object for that specific day, or null if invalid input.
         */
        function getDateForDayInWeek(weekStartDateISO, dayOfWeekString) {
            if (!weekStartDateISO || !dayOfWeekString) return null;

            const startDate = new Date(weekStartDateISO);
            if (isNaN(startDate.getTime())) return null;

            // Ensure startDate is correctly interpreted as local date to avoid timezone issues
            const startDateLocal = new Date(startDate.getFullYear(), startDate.getMonth(), startDate.getDate());

            const days = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
            const startDayIndex = startDateLocal.getDay(); // 0 for Sunday, 1 for Monday, etc.
            const targetDayIndex = days.indexOf(dayOfWeekString);

            if (targetDayIndex === -1) return null; // Invalid day string

            const diff = targetDayIndex - startDayIndex;
            const actualDate = new Date(startDateLocal);
            actualDate.setDate(startDateLocal.getDate() + diff);

            return actualDate;
        }

        /**
         * Calculates the start (Sunday) and end (Saturday) dates of the week for a given date.
         * Dates are normalized to midnight for accurate comparison.
         * @param {Date} date - The date within the week.
         * @returns {{weekStart: Date, weekEnd: Date}} An object containing the start and end dates of the week.
         */
        function getWeekRange(date) {
            const d = new Date(date.getFullYear(), date.getMonth(), date.getDate()); // Normalize to start of day
            const dayOfWeek = d.getDay(); // 0 = Sunday, 1 = Monday, ..., 6 = Saturday

            const weekStart = new Date(d);
            weekStart.setDate(d.getDate() - dayOfWeek); // Go back to Sunday

            const weekEnd = new Date(d);
            weekEnd.setDate(d.getDate() + (6 - dayOfWeek)); // Go forward to Saturday
            weekEnd.setHours(23, 59, 59, 999); // Set to end of Saturday for inclusive range

            return { weekStart, weekEnd };
        }


        // Fetch data from Google Sheet on page load
        fetch(sheetURL)
            .then(res => res.json())
            .then(data => {
                // Sort data by "Week Start" in ascending order to ensure chronological display
                timetableData = data.sort((a, b) => {
                    const dateA = getDateForDayInWeek(a["Week Start"], a["Day"]);
                    const dateB = getDateForDayInWeek(b["Week Start"], b["Day"]);
                    if (dateA && dateB) {
                        return dateA.getTime() - dateB.getTime();
                    }
                    return 0; // Maintain original order if dates are invalid
                });
                populateStudents(timetableData); // Populate student dropdown
                renderTimetable(); // Initial render after data is fetched
            })
            .catch(error => {
                console.error("Error fetching timetable data:", error);
                showModal("Error", "Failed to load timetable data. Please try again later.");
            });

        /**
         * Formats an ISO date string or Date object to DD/MM/YYYY format.
         * @param {string | Date} dateInput - The ISO date string or Date object.
         * @returns {string} Formatted date string or empty string if input is invalid.
         */
        function formatDate(dateInput) {
            if (!dateInput) return '';
            const date = (dateInput instanceof Date) ? dateInput : new Date(dateInput);

            // Ensure date is valid before formatting
            if (isNaN(date.getTime())) return '';
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0'); // Month is 0-indexed
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }

        /**
         * Formats an ISO date string to HH:MM AM/PM format.
         * @param {string} isoString - The ISO date string.
         * @returns {string} Formatted time string or empty string if input is invalid.
         */
        function formatTime(isoString) {
            if (!isoString) return '';
            const date = new Date(isoString);
            // Ensure date is valid before formatting
            if (isNaN(date.getTime())) return '';
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        /**
         * Populates the student dropdown with unique student IDs and names.
         * @param {Array<Object>} data - The timetable data.
         */
        function populateStudents(data) {
            const studentMap = new Map(); // Use a Map to store unique student IDs and names

            data.forEach(row => {
                // Explicitly convert to string and handle potential null/undefined values
                const id = String(row["Student ID"] || '').trim();
                const name = String(row["Student Name"] || '').trim();

                if (id && !studentMap.has(id)) {
                    studentMap.set(id, name);
                    const option = document.createElement('option');
                    option.value = id;
                    option.textContent = `${name} (ID: ${id})`; // Display name and ID in dropdown
                    studentSelect.appendChild(option);
                }
            });
        }

        /**
         * Renders the timetable based on the selected student and date range into a single table.
         * Filters by full weeks if start and end dates are provided.
         */
        function renderTimetable() {
            const selectedOption = studentSelect.selectedOptions[0];
            const selectedID = selectedOption ? selectedOption.value : '';
            const selectedStudentName = selectedOption && selectedOption.value ? selectedOption.textContent.split('(')[0].trim() : '';
            const startDateValue = startDateInput.value;
            const endDateValue = endDateInput.value;
            timetableTbody.innerHTML = ''; // Clear existing table rows
            timetableDisplaySection.classList.remove('show'); // Hide section initially
            currentDisplayedTimetableData = []; // Clear previously displayed data

            if (!selectedID) {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td colspan="5" style="text-align: center; padding: 20px;">Please select a student to view their timetable.</td>`;
                timetableTbody.appendChild(tr);
                currentTimetableTitle.textContent = "Student Timetable";
                return;
            }

            let studentSpecificData = timetableData.filter(entry => String(entry["Student ID"]) === selectedID);

            let dataToDisplay = [];
            let displayStartDate = null;
            let displayEndDate = null;
            let titleSuffix = "";

            // Logic for filtering based on date inputs
            if (startDateValue && endDateValue) {
                const inputStartDate = new Date(startDateValue);
                const inputEndDate = new Date(endDateValue);

                if (isNaN(inputStartDate.getTime()) || isNaN(inputEndDate.getTime())) {
                    showModal("Invalid Dates", "Please enter valid start and end dates.");
                    return;
                }

                if (inputStartDate > inputEndDate) {
                    showModal("Invalid Date Range", "Start date cannot be after end date.");
                    return;
                }

                const { weekStart: filterStartWeek } = getWeekRange(inputStartDate);
                const { weekEnd: finalEndOfWeek } = getWeekRange(inputEndDate);

                dataToDisplay = studentSpecificData.filter(entry => {
                    const entryDate = getDateForDayInWeek(entry["Week Start"], entry["Day"]);
                    if (!entryDate) return false;
                    const normalizedEntryDate = new Date(entryDate.getFullYear(), entryDate.getMonth(), entryDate.getDate());
                    return normalizedEntryDate >= filterStartWeek && normalizedEntryDate <= finalEndOfWeek;
                });

                displayStartDate = filterStartWeek;
                displayEndDate = finalEndOfWeek;
                titleSuffix = ` (${formatDate(displayStartDate)} - ${formatDate(displayEndDate)})`;

            } else if (startDateValue && !endDateValue) {
                // If only start date is provided, automatically set end date to end of that week
                const inputStartDate = new Date(startDateValue);
                if (isNaN(inputStartDate.getTime())) {
                    showModal("Invalid Start Date", "Please enter a valid start date.");
                    return;
                }
                const { weekStart: autoWeekStart, weekEnd: autoWeekEnd } = getWeekRange(inputStartDate);
                endDateInput.value = autoWeekEnd.toISOString().split('T')[0]; // Set the end date input field

                dataToDisplay = studentSpecificData.filter(entry => {
                    const entryDate = getDateForDayInWeek(entry["Week Start"], entry["Day"]);
                    if (!entryDate) return false;
                    const normalizedEntryDate = new Date(entryDate.getFullYear(), entryDate.getMonth(), entryDate.getDate());
                    return normalizedEntryDate >= autoWeekStart && normalizedEntryDate <= autoWeekEnd;
                });

                displayStartDate = autoWeekStart;
                displayEndDate = autoWeekEnd;
                titleSuffix = ` (${formatDate(displayStartDate)} - ${formatDate(displayEndDate)})`;

            } else if (!startDateValue && endDateValue) {
                // If only end date is provided, clear both and prompt
                showModal("Missing Start Date", "Please select a start date to define a weekly range, or clear both dates to view the full timetable.");
                endDateInput.value = ''; // Clear end date
                dataToDisplay = studentSpecificData; // Show full timetable
                // Determine full range for title
                if (studentSpecificData.length > 0) {
                    const allDates = studentSpecificData.map(entry => getDateForDayInWeek(entry["Week Start"], entry["Day"]))
                                                        .filter(date => date !== null)
                                                        .sort((a, b) => a.getTime() - b.getTime());
                    if (allDates.length > 0) {
                        displayStartDate = allDates[0];
                        displayEndDate = allDates[allDates.length - 1];
                        titleSuffix = ` (Full Timetable: ${formatDate(displayStartDate)} - ${formatDate(displayEndDate)})`;
                    }
                }
                
            } else {
                // No dates selected, show full timetable for the student
                dataToDisplay = studentSpecificData;
                // Determine full range for title
                if (studentSpecificData.length > 0) {
                    const allDates = studentSpecificData.map(entry => getDateForDayInWeek(entry["Week Start"], entry["Day"]))
                                                        .filter(date => date !== null)
                                                        .sort((a, b) => a.getTime() - b.getTime());
                    if (allDates.length > 0) {
                        displayStartDate = allDates[0];
                        displayEndDate = allDates[allDates.length - 1];
                        titleSuffix = ` (Full Timetable: ${formatDate(displayStartDate)} - ${formatDate(displayEndDate)})`;
                    }
                }
            }

            // If no data found after filtering
            if (dataToDisplay.length === 0) {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td colspan="5" style="text-align: center; padding: 20px;">No timetable data found for the selected student and date range.</td>`;
                timetableTbody.appendChild(tr);
                currentTimetableTitle.textContent = `Timetable for ${selectedStudentName}`;
                return;
            }

            // Sort the data to display by date and then time
            dataToDisplay.sort((a, b) => {
                const dateA = getDateForDayInWeek(a["Week Start"], a["Day"]);
                const dateB = getDateForDayInWeek(b["Week Start"], b["Day"]);
                if (dateA && dateB) {
                    const dateComparison = dateA.getTime() - dateB.getTime();
                    if (dateComparison !== 0) return dateComparison;

                    const timeA = new Date(`1970/01/01 ${a["Time"]}`);
                    const timeB = new Date(`1970/01/01 ${b["Time"]}`);
                    return timeA.getTime() - timeB.getTime();
                }
                return 0;
            });

            // Update global variable for currently displayed data
            currentDisplayedTimetableData = dataToDisplay;

            // Update timetable title
            currentTimetableTitle.textContent = `Timetable for ${selectedStudentName}${titleSuffix}`;

            // Populate the table with the sorted data
            currentDisplayedTimetableData.forEach(row => {
                const tr = document.createElement('tr');
                const actualDate = getDateForDayInWeek(row["Week Start"], row["Day"]);
                tr.innerHTML = `
                    <td>${row["Day"] || ''}</td>
                    <td>${formatDate(actualDate || '')}</td>
                    <td>${formatTime(row["Time"] || '')}</td>
                    <td>${row["Subject"] || ''}</td>
                    <td>${row["Teacher"] || ''}</td>
                `;
                timetableTbody.appendChild(tr);
            });

            timetableDisplaySection.classList.add('show'); // Show timetable section with animation
        }

        /**
         * Generic function to handle PDF download.
         * @param {Array<Object>} dataToDownload - The filtered data to include in the PDF.
         * @param {string} studentName - The name of the selected student.
         * @param {string} downloadFileName - The desired file name for the download.
         * @param {string} titleForPdf - The title to be used inside the PDF.
         * @param {HTMLElement} buttonElement - The button element that triggered the download.
         */
        async function downloadTimetableAsPdf(dataToDownload, studentName, downloadFileName, titleForPdf, buttonElement) {
            buttonElement.classList.add('loading');
            buttonElement.disabled = true;

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            try {
                let y = 20;
                doc.setFontSize(14);
                doc.text(titleForPdf, 10, y);
                y += 10;

                doc.setFontSize(10);
                doc.text("Day", 10, y);
                doc.text("Date", 40, y);
                doc.text("Time", 75, y);
                doc.text("Subject", 105, y);
                doc.text("Teacher", 155, y);
                y += 5;
                doc.line(10, y, 200, y);
                y += 5;

                dataToDownload.forEach(row => {
                    const actualDate = getDateForDayInWeek(row["Week Start"], row["Day"]);
                    if (y > 270) {
                        doc.addPage();
                        y = 20;
                        doc.setFontSize(14);
                        doc.text(`${titleForPdf} (Cont.)`, 10, y);
                        y += 10;
                        doc.setFontSize(10);
                        doc.text("Day", 10, y);
                        doc.text("Date", 40, y);
                        doc.text("Time", 75, y);
                        doc.text("Subject", 105, y);
                        doc.text("Teacher", 155, y);
                        y += 5;
                        doc.line(10, y, 200, y);
                        y += 5;
                    }
                    doc.text(row["Day"] || '', 10, y);
                    doc.text(formatDate(actualDate || ''), 40, y);
                    doc.text(formatTime(row["Time"] || ''), 75, y);
                    doc.text(row["Subject"] || '', 105, y);
                    doc.text(row["Teacher"] || '', 155, y);
                    y += 8;
                });

                doc.save(downloadFileName);
                showModal("Success!", "Timetable PDF downloaded successfully.");
            } catch (error) {
                console.error("Error generating PDF:", error);
                showModal("Error", "Failed to generate PDF. Please try again.");
            } finally {
                buttonElement.classList.remove('loading');
                buttonElement.disabled = false;
            }
        }

        /**
         * Generic function to handle JPEG download.
         * @param {Array<Object>} dataToDownload - The filtered data to include in the JPEG (used for rendering before capture).
         * @param {string} studentName - The name of the selected student.
         * @param {string} downloadFileName - The desired file name for the download.
         * @param {string} titleForJpeg - The title to be used inside the captured image.
         * @param {HTMLElement} buttonElement - The button element that triggered the download.
         */
        async function downloadTimetableAsJpeg(dataToDownload, studentName, downloadFileName, titleForJpeg, buttonElement) {
            buttonElement.classList.add('loading');
            buttonElement.disabled = true;

            // Temporarily update the displayed timetable to match the data being downloaded
            const originalTimetableContent = timetableTbody.innerHTML;
            const originalTitle = currentTimetableTitle.textContent;

            timetableTbody.innerHTML = '';
            dataToDownload.forEach(row => {
                const tr = document.createElement('tr');
                const actualDate = getDateForDayInWeek(row["Week Start"], row["Day"]);
                tr.innerHTML = `
                    <td>${row["Day"] || ''}</td>
                    <td>${formatDate(actualDate || '')}</td>
                    <td>${formatTime(row["Time"] || '')}</td>
                    <td>${row["Subject"] || ''}</td>
                    <td>${row["Teacher"] || ''}</td>
                `;
                timetableTbody.appendChild(tr);
            });

            currentTimetableTitle.textContent = titleForJpeg;
            timetableDisplaySection.classList.add('show'); // Ensure it's visible

            const timetableTable = document.getElementById('timetable');

            if (!timetableTable || timetableTable.offsetHeight === 0 || timetableTable.offsetWidth === 0) {
                showModal("Error", "Timetable table is not visible or rendered correctly for JPEG generation.");
                buttonElement.classList.remove('loading');
                buttonElement.disabled = false;
                // Restore original content if capture fails
                timetableTbody.innerHTML = originalTimetableContent;
                currentTimetableTitle.textContent = originalTitle;
                return;
            }

            try {
                const canvas = await html2canvas(timetableTable, {
                    scale: 2,
                    logging: false,
                    useCORS: true,
                    backgroundColor: '#ffffff'
                });

                const imageData = canvas.toDataURL('image/jpeg', 0.9);

                const link = document.createElement('a');
                link.href = imageData;
                link.download = downloadFileName;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                showModal("Success!", "Timetable JPEG downloaded successfully.");

            } catch (error) {
                console.error("Error generating JPEG:", error);
                showModal("Error", "Failed to generate JPEG. Please ensure the timetable is visible and try again.");
            } finally {
                buttonElement.classList.remove('loading');
                buttonElement.disabled = false;
                // Restore original content after capture
                timetableTbody.innerHTML = originalTimetableContent;
                currentTimetableTitle.textContent = originalTitle;
                renderTimetable(); // Re-render the timetable based on current selections
            }
        }


        // Event listeners
        studentSelect.addEventListener('change', renderTimetable);

        // Modified startDateInput event listener
        startDateInput.addEventListener('change', () => {
            const startDateValue = startDateInput.value;
            if (startDateValue) {
                const inputStartDate = new Date(startDateValue);
                if (!isNaN(inputStartDate.getTime())) {
                    const { weekEnd: autoWeekEnd } = getWeekRange(inputStartDate);
                    endDateInput.value = autoWeekEnd.toISOString().split('T')[0];
                }
            }
            renderTimetable(); // Always re-render after start date changes
        });

        endDateInput.addEventListener('change', renderTimetable); // Auto-update on end date change

        showTimetableBtn.addEventListener('click', (event) => {
            addRippleEffect(event);
            renderTimetable(); // Explicitly re-render if needed
        });

        // Set Today buttons
        document.getElementById('setTodayStartDateBtn').addEventListener('click', (event) => {
            addRippleEffect(event);
            const today = new Date();
            startDateInput.value = today.toISOString().split('T')[0];
            // Trigger change event to auto-update end date and re-render
            startDateInput.dispatchEvent(new Event('change'));
        });

        document.getElementById('setTodayEndDateBtn').addEventListener('click', (event) => {
            addRippleEffect(event);
            const today = new Date();
            endDateInput.value = today.toISOString().split('T')[0];
            renderTimetable(); // Re-render after setting date
        });

        // Clear Date buttons
        document.getElementById('clearStartDateBtn').addEventListener('click', (event) => {
            addRippleEffect(event);
            startDateInput.value = '';
            renderTimetable(); // Re-render after clearing date
        });

        document.getElementById('clearEndDateBtn').addEventListener('click', (event) => {
            addRippleEffect(event);
            endDateInput.value = '';
            renderTimetable(); // Re-render after clearing date
        });


        // Event listener for PDF download button click
        downloadPdfBtn.addEventListener('click', async (event) => {
            addRippleEffect(event);

            const selectedOption = studentSelect.selectedOptions[0];
            const selectedID = selectedOption ? selectedOption.value : '';
            const selectedStudentName = selectedOption ? selectedOption.textContent.split('(')[0].trim() : '';

            if (!selectedID) {
                showModal("Missing Selection", "Please select a student.");
                return;
            }
            if (currentDisplayedTimetableData.length === 0) {
                showModal("No Data", "No timetable data is currently displayed for download.");
                return;
            }

            const downloadFileName = `Timetable_${selectedID}_${currentTimetableTitle.textContent.replace(/[^a-zA-Z0-9_ -]/g, '').replace(/\s/g, '_')}.pdf`;
            const titleForPdf = currentTimetableTitle.textContent; // Use the displayed title

            await downloadTimetableAsPdf(currentDisplayedTimetableData, selectedStudentName, downloadFileName, titleForPdf, downloadPdfBtn);
        });

        // Event listener for JPEG download button click
        downloadJpegBtn.addEventListener('click', async (event) => {
            addRippleEffect(event);

            const selectedOption = studentSelect.selectedOptions[0];
            const selectedID = selectedOption ? selectedOption.value : '';
            const selectedStudentName = selectedOption ? selectedOption.textContent.split('(')[0].trim() : '';

            if (!selectedID) {
                showModal("Missing Selection", "Please select a student.");
                return;
            }
            if (currentDisplayedTimetableData.length === 0) {
                showModal("No Data", "No timetable data is currently displayed for download.");
                return;
            }

            const downloadFileName = `Timetable_${selectedID}_${currentTimetableTitle.textContent.replace(/[^a-zA-Z0-9_ -]/g, '').replace(/\s/g, '_')}.jpeg`;
            const titleForJpeg = currentTimetableTitle.textContent; // Use the displayed title

            await downloadTimetableAsJpeg(currentDisplayedTimetableData, selectedStudentName, downloadFileName, titleForJpeg, downloadJpegBtn);
        });

        // Add ripple effect to the Dashboard button
        document.querySelector('.dashboard-button').addEventListener('click', addRippleEffect);


        /**
         * Navigates back to the previous page (dashboard).
         */
        function goToDashboard() {
            window.history.back();
        }

        /* Custom Modal Functions */
        /**
         * Displays the custom message modal.
         * @param {string} title - The title of the message.
         * @param {string} message - The content of the message.
         */
        function showModal(title, message) {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            messageModal.classList.add('show'); // Add 'show' class to trigger display and animation
        }

        /**
         * Hides the custom message modal.
         */
        function hideModal() {
            modalTitle.textContent = '';
            modalMessage.textContent = '';
            messageModal.classList.remove('show'); // Remove 'show' class to hide and trigger animation
        }

        /**
         * Scrolls the window to the top of the page.
         */
        function scrollToTop() {
            window.scrollTo({
                top: 0,
                behavior: 'smooth' // Smooth scrolling
            });
        }

        /**
         * Scrolls the window to the bottom of the page.
         */
        function scrollToBottom() {
            window.scrollTo({
                top: document.body.scrollHeight,
                behavior: 'smooth' // Smooth scrolling
            });
        }
    </script>
</body>
</html>
