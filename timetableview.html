<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Student Log Filter</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
    }
    select, input, button {
      margin: 10px;
      padding: 6px;
    }
    table, th, td {
      border: 1px solid #ccc;
      border-collapse: collapse;
      padding: 5px;
    }
    table {
      margin-top: 20px;
      width: 100%;
    }
  </style>
</head>
<body>

  <h2>Student Log Filter</h2>

  <!-- Filters -->
  <label for="studentSelect">Student ID:</label>
  <select id="studentSelect">
    <option value="">-- Select Student --</option>
    <!-- Options populated dynamically -->
  </select>

  <label for="startDate">Start Date:</label>
  <input type="date" id="startDate">

  <label for="endDate">End Date:</label>
  <input type="date" id="endDate">

  <button id="filterBtn">Filter</button>
  <button id="downloadBtn">Download PDF</button>

  <!-- Filtered Table -->
  <table id="studentTable">
    <thead>
      <tr>
        <th>Date</th>
        <th>Student ID</th>
        <th>Student Name</th>
        <th>Subject</th>
        <th>Teacher</th>
        <th>What Was Taught</th>
        <th>Homework</th>
      </tr>
    </thead>
    <tbody>
      <!-- Filtered entries will go here -->
    </tbody>
  </table>

  <script>
    const sheetURL = "https://script.google.com/macros/s/AKfycbzARIynxtCX1rbMPIfY0Uwnwfk2ozLYmifGK5pA49J1a8G8ad1Z_DIYvoYXYE1dlJjNNA/exec";
    let allData = [];
    let filtered = [];

    const studentSelect = document.getElementById('studentSelect');
    const startInput = document.getElementById('startDate');
    const endInput = document.getElementById('endDate');
    const tableBody = document.querySelector('#studentTable tbody');

    // Fetch logbook data
    async function fetchData() {
      try {
        const response = await fetch(sheetURL);
        const data = await response.json();
        allData = data;

        // Populate student select
        const uniqueIDs = [...new Set(allData.map(entry => entry.studentID))];
        uniqueIDs.forEach(id => {
          const option = document.createElement("option");
          option.value = id;
          option.textContent = id;
          studentSelect.appendChild(option);
        });
      } catch (error) {
        console.error("Error fetching data:", error);
        alert("Failed to fetch data.");
      }
    }

    // Filter logic
    document.getElementById('filterBtn').addEventListener('click', () => {
      const selectedID = studentSelect.value;
      const startDate = new Date(startInput.value);
      const endDate = new Date(endInput.value);

      if (!selectedID || !startInput.value || !endInput.value) {
        alert('Please select student and date range.');
        return;
      }

      filtered = allData.filter(entry => {
        const entryDate = new Date(entry.date);
        return entry.studentID === selectedID &&
               entryDate >= startDate &&
               entryDate <= endDate;
      });

      tableBody.innerHTML = '';
      if (filtered.length === 0) {
        tableBody.innerHTML = `<tr><td colspan="7">No data found.</td></tr>`;
      } else {
        filtered.forEach(entry => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${entry.date}</td>
            <td>${entry.studentID}</td>
            <td>${entry.studentName}</td>
            <td>${entry.subject}</td>
            <td>${entry.teacher}</td>
            <td>${entry.taught}</td>
            <td>${entry.homework}</td>
          `;
          tableBody.appendChild(row);
        });
      }
    });

    // PDF download logic
    document.getElementById('downloadBtn').addEventListener('click', () => {
      const jsPDF = window.jspdf.jsPDF;
      const doc = new jsPDF();

      if (filtered.length === 0) {
        alert("Please filter data first.");
        return;
      }

      doc.setFontSize(14);
      doc.text("Student Log Report", 10, 10);
      let y = 20;

      filtered.forEach((entry, index) => {
        doc.setFontSize(10);
        doc.text(`Date: ${entry.date}`, 10, y);
        doc.text(`ID: ${entry.studentID}`, 60, y);
        doc.text(`Name: ${entry.studentName}`, 120, y);
        y += 6;
        doc.text(`Subject: ${entry.subject}`, 10, y);
        doc.text(`Teacher: ${entry.teacher}`, 60, y);
        y += 6;
        doc.text(`Taught: ${entry.taught}`, 10, y);
        y += 6;
        doc.text(`Homework: ${entry.homework}`, 10, y);
        y += 10;

        if (y > 270 && index !== filtered.length - 1) {
          doc.addPage();
          y = 10;
        }
      });

      doc.save("Student_Log_Report.pdf");
    });

    // Initialize
    fetchData();
  </script>

</body>
</html>
