<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teacher Salary Sheet</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- html2pdf.js CDN for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        /* Global styles and body background animation */
        body {
            font-family: 'Inter', sans-serif; /* Using Inter font */
            margin: 0;
            padding: 0;
            /* Adjusted gradient colors for a slightly softer, yet clear look */
            background: linear-gradient(45deg, #b3e0e6, #e6f7ff, #c9e6e0, #f7fbe6);
            background-size: 400% 400%; /* Larger background for smooth animation */
            animation: gradient 15s ease infinite; /* Gradient animation */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh; /* Full viewport height */
            color: #333; /* Default text color */
        }

        /* Keyframe animation for the background gradient */
        @keyframes gradient {
            0% {
                background-position: 0% 50%;
            }
            50% {
                background-position: 100% 50%;
            }
            100% {
                background-position: 0% 50%;
            }
        }

        /* Main container for the salary sheet */
        #printArea {
            background-color: rgba(255, 255, 255, 0.95); /* Slightly transparent white background */
            border-radius: 16px; /* More rounded corners */
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15); /* Enhanced shadow */
            padding: 40px;
            width: 95%; /* Responsive width */
            max-width: 1400px; /* Max width for larger screens */
            text-align: center;
            box-sizing: border-box; /* Include padding in width */
            overflow-x: auto; /* Allow horizontal scrolling for table if needed */
        }

        /* Button styling */
        .dashboard-btn, .action-btn {
            background: linear-gradient(to right, #1a73e8, #4285f4); /* Google Blue gradient */
            color: white;
            padding: 14px 28px;
            margin: 10px 10px;
            border: none;
            border-radius: 10px; /* Rounded buttons */
            cursor: pointer;
            font-size: 17px;
            font-weight: 600;
            transition: all 0.3s ease; /* Smooth transition for hover effects */
            box-shadow: 0 5px 15px rgba(26, 115, 232, 0.2); /* Soft shadow */
            display: inline-flex; /* Align icon and text */
            align-items: center;
            gap: 8px; /* Space between icon and text */
        }

        .dashboard-btn:hover, .action-btn:hover {
            background: linear-gradient(to right, #176ac1, #3c78d8); /* Darker gradient on hover */
            transform: translateY(-2px); /* Slight lift effect */
            box-shadow: 0 8px 20px rgba(26, 115, 232, 0.3); /* Enhanced shadow on hover */
        }

        /* Heading style */
        h2 {
            color: #2c3e50; /* Darker, more professional color */
            margin-bottom: 30px;
            font-size: 3em; /* Larger heading */
            font-weight: 700;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.05); /* Subtle text shadow */
        }

        /* Label for month picker */
        label {
            font-size: 1.2em;
            color: #555;
            margin-right: 15px;
            font-weight: 600;
        }

        /* Month input styling */
        input[type="month"] {
            padding: 12px;
            font-size: 16px;
            margin: 10px 5px;
            border: 1px solid #c0d9e7; /* Softer border color */
            border-radius: 8px;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05); /* Inner shadow */
        }

        input[type="month"]:focus {
            border-color: #1a73e8; /* Match button color on focus */
            box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.25); /* Focus ring */
            outline: none;
        }

        /* Table styling */
        table {
            margin-top: 40px;
            width: 100%;
            border-collapse: separate; /* Use separate for rounded corners on cells */
            border-spacing: 0; /* Remove default spacing */
            font-size: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1); /* Deeper shadow */
            border-radius: 12px; /* Rounded table corners */
            overflow: hidden; /* Ensures rounded corners are visible */
            background-color: white;
        }

        th, td {
            border: 1px solid #e0e0e0; /* Lighter border for cells */
            padding: 12px 10px;
            text-align: center;
            vertical-align: middle; /* Ensures content is vertically centered */
        }

        th {
            background-color: #e6f0ff; /* Light blue header background, slightly adjusted */
            color: #333;
            font-weight: 700;
            text-transform: uppercase;
            position: sticky; /* Make headers sticky for scrolling */
            top: 0;
            z-index: 10;
        }

        /* Striped rows */
        tr:nth-child(even) {
            background-color: #f0f8ff; /* Very light blue for even rows */
        }

        /* Hover effect on table rows */
        tr:hover {
            background-color: #d9edf7; /* Light blue on hover */
            transition: background-color 0.2s ease;
        }

        /* Container for the salary table */
        #salarySheetContainer {
            margin-top: 30px;
            overflow-x: auto; /* Enable horizontal scrolling if table is too wide */
        }

        /* Loading indicator styles */
        .loading-indicator {
            display: none; /* Hidden by default */
            margin-top: 30px;
            font-size: 1.5em;
            color: #1a73e8; /* Match button color */
            font-weight: 600;
        }

        /* Modal Styles */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.6); /* Black w/ opacity */
            backdrop-filter: blur(5px); /* Blurred background */
            -webkit-backdrop-filter: blur(5px); /* Safari support */
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            width: 80%;
            max-width: 700px; /* Adjusted max-width for more content */
            position: relative;
            animation: fadeIn 0.3s ease-out;
            max-height: 80vh; /* Max height for scrollable content */
            overflow-y: auto; /* Enable scrolling for modal content */
            text-align: left;
        }

        .modal-content h3 {
            color: #1a73e8;
            margin-top: 0;
            margin-bottom: 20px;
            font-size: 1.8em;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 10px;
        }

        .modal-content label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .modal-content input[type="number"] {
            width: calc(100% - 24px); /* Full width minus padding */
            padding: 12px;
            margin-bottom: 20px;
            border: 1px solid #c0d9e7;
            border-radius: 8px;
            font-size: 16px;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05);
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        .modal-content input[type="number"]:focus {
            border-color: #1a73e8;
            box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.25);
            outline: none;
        }

        .modal-content .action-btn {
            width: 100%;
            margin-top: 10px;
        }

        .close-button {
            color: #aaa;
            position: absolute;
            top: 15px;
            right: 25px;
            font-size: 35px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .close-button:hover,
        .close-button:focus {
            color: #333;
            text-decoration: none;
            cursor: pointer;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Styles for PDF generation to ensure full content is captured */
        .pdf-export-mode #printArea {
            width: auto !important; /* Allow printArea to expand */
            max-width: none !important; /* Remove max-width constraint */
            overflow-x: visible !important; /* Ensure content is not clipped */
            padding: 20px !important; /* Reduce padding for PDF */
        }

        .pdf-export-mode #salarySheetContainer {
            overflow-x: visible !important; /* Ensure content is not clipped */
            width: auto !important; /* Allow container to expand */
        }

        .pdf-export-mode table {
            width: max-content !important; /* Make table expand to its full content width */
            min-width: 100% !important; /* Ensure it's at least 100% wide */
        }

        /* Modal specific styles for class list */
        .class-list-container {
            margin-top: 15px;
            border-top: 1px solid #eee;
            padding-top: 15px;
        }

        .class-entry {
            background-color: #f9f9f9;
            border-left: 4px solid #1a73e8;
            padding: 10px 15px;
            margin-bottom: 8px;
            border-radius: 5px;
            font-size: 0.95em;
        }

        .class-entry strong {
            color: #2c3e50;
        }

        /* Styles for individual student sections in modal */
        .student-salary-section {
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            background-color: #fcfcfc;
        }

        .student-salary-section h4 {
            color: #333;
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 1.3em;
        }

        .total-summary {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #1a73e8;
            font-size: 1.5em;
            font-weight: bold;
            color: #2c3e50;
            text-align: right;
        }
        .total-summary.grand-total {
            margin-top: 40px;
            padding-top: 25px;
            border-top: 3px double #1a73e8;
            font-size: 1.8em;
            font-weight: bold;
            color: #0056b3;
            text-align: right;
        }
    </style>
</head>
<body>

    <div id="printArea">
        <button class="dashboard-btn" onclick="goToDashboard()">⬅ Dashboard</button>
        <h2 id="reportTitle">Teacher Salary Sheet</h2>

        <div class="controls">
            <label>Select Month:
                <input type="month" id="monthPicker" />
            </label>
            <button class="action-btn" onclick="loadSalaryData()">Load Data</button>
            <button class="action-btn" onclick="downloadPDF()">📄 Download PDF</button>
        </div>

        <div id="loadingIndicator" class="loading-indicator">Loading salary data...</div>

        <div id="salarySheetContainer">
            <!-- Salary sheet table will be generated here by JavaScript -->
        </div>
        <div id="overallTotalHours" class="total-summary grand-total" style="display: none;">
            Overall Total Hours for Month: <span id="overallHoursValue">0.00</span>
        </div>
    </div>

    <!-- Salary Entry Modal -->
    <div id="salaryEntryModal" class="modal">
        <div class="modal-content" id="modalPrintArea">
            <span class="close-button" onclick="closeSalaryModal()">&times;</span>
            <h3>Salary Details for <span id="modalTeacherName"></span> (ID: <span id="modalTeacherId"></span>)</h3>
            <p>Overall Total Hours for Teacher: <strong id="modalTeacherOverallHours"></strong></p>

            <div id="modalStudentSections">
                <!-- Individual student salary sections will be populated here -->
            </div>

            <div class="total-summary">
                Teacher's Grand Total Amount: <strong id="modalTeacherGrandTotal">₹0.00</strong>
            </div>
            <!-- Removed "Save All Hourly Rates" button -->
            <button class="action-btn" onclick="copyModalContentToClipboard()">📋 Copy to Clipboard</button>
        </div>
    </div>

    <script>
        // Google Apps Script Web App URL - REPLACE THIS WITH YOUR ACTUAL DEPLOYED URL
        // This URL should point to the Apps Script that fetches data from your combined Google Sheet.
        const GOOGLE_SHEET_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwdKvar_uKqoAg1wX60NTThwVHBul14wroJj0QqBQZ3WtQ5zx2hAWXe8hqXqifFI3diSA/exec';

        // Sample Log Book Data (used if fetching fails or URL is not set)
        const sampleLogBookData = [
            { Date: '2025-06-01', 'Teacher Name': 'Alice Smith', 'Staff ID': 'T001', 'Program': 'Math', 'Class Room Name': 'Room 101', 'Student Name': 'John Doe', 'Student ID': 'S001', 'Subject': 'Algebra', 'Class In': '10:00 AM', 'Class Duration': 60, 'What Taught Today': 'Equations', 'Student Engagement': 'High', 'Any Work': 'Homework 1', 'Anything you\'d like to share?': '' },
            { Date: '2025-06-01', 'Teacher Name': 'Bob Johnson', 'Staff ID': 'T002', 'Program': 'Science', 'Class Room Name': 'Room 102', 'Student Name': 'Jane Smith', 'Student ID': 'S002', 'Subject': 'Biology', 'Class In': '11:00 AM', 'Class Duration': 45, 'What Taught Today': 'Cells', 'Student Engagement': 'Medium', 'Any Work': '', 'Anything you\'d like to share?': '' },
            { Date: '2025-06-01', 'Teacher Name': 'Alice Smith', 'Staff ID': 'T001', 'Program': 'Math', 'Class Room Name': 'Room 101', 'Student Name': 'John Doe', 'Student ID': 'S001', 'Subject': 'Geometry', 'Class In': '01:00 PM', 'Class Duration': 30, 'What Taught Today': 'Shapes', 'Student Engagement': 'High', 'Any Work': '', 'Anything you\'d like to share?': '' },
            { Date: '2025-06-02', 'Teacher Name': 'Alice Smith', 'Staff ID': 'T001', 'Program': 'Math', 'Class Room Name': 'Room 101', 'Student Name': 'John Doe', 'Student ID': 'S001', 'Subject': 'Calculus', 'Class In': '09:00 AM', 'Class Duration': 90, 'What Taught Today': 'Derivatives', 'Student Engagement': 'High', 'Any Work': 'Quiz', 'Anything you\'d like to share?': '' },
            { Date: '2025-06-02', 'Teacher Name': 'Charlie Brown', 'Staff ID': 'T003', 'Program': 'History', 'Class Room Name': 'Room 103', 'Student Name': 'Mike Johnson', 'Student ID': 'S003', 'Subject': 'World War II', 'Class In': '10:30 AM', 'Class Duration': 60, 'What Taught Today': 'Causes of WWII', 'Student Engagement': 'Medium', 'Any Work': 'Reading', 'Anything you\'d like to share?': '' },
            { Date: '2025-07-01', 'Teacher Name': 'Alice Smith', 'Staff ID': 'T001', 'Program': 'Math', 'Class Room Name': 'Room 101', 'Student Name': 'John Doe', 'Student ID': 'S001', 'Subject': 'Algebra', 'Class In': '10:00 AM', 'Class Duration': 120, 'What Taught Today': 'Advanced Equations', 'Student Engagement': 'High', 'Any Work': 'Project', 'Anything you\'d like to share?': '' },
            { Date: '2025-07-01', 'Teacher Name': 'Bob Johnson', 'Staff ID': 'T002', 'Program': 'Science', 'Class Room Name': 'Room 102', 'Student Name': 'Jane Smith', 'Student ID': 'S002', 'Subject': 'Chemistry', 'Class In': '11:00 AM', 'Class Duration': 60, 'What Taught Today': 'Periodic Table', 'Student Engagement': 'High', 'Any Work': 'Lab Report', 'Anything you\'d like to share?': '' },
            { Date: '2025-07-02', 'Teacher Name': 'Alice Smith', 'Staff ID': 'T001', 'Program': 'Math', 'Class Room Name': 'Room 101', 'Student Name': 'John Doe', 'Student ID': 'S001', 'Subject': 'Geometry', 'Class In': '09:00 AM', 'Class Duration': 90, 'What Taught Today': 'Theorems', 'Student Engagement': 'Medium', 'Any Work': 'Practice Problems', 'Anything you\'d like to share?': '' },
            { Date: '2025-07-03', 'Teacher Name': 'Charlie Brown', 'Staff ID': 'T003', 'Program': 'History', 'Class Room Name': 'Room 103', 'Student Name': 'Mike Johnson', 'Student ID': 'S003', 'Subject': 'Ancient Civilizations', 'Class In': '10:30 AM', 'Class Duration': 70, 'What Taught Today': 'Egypt', 'Student Engagement': 'High', 'Any Work': 'Research', 'Anything you\'d like to share?': '' },
            { Date: '2025-07-03', 'Teacher Name': 'Alice Smith', 'Staff ID': 'T001', 'Program': 'Math', 'Class Room Name': 'Room 101', 'Student Name': 'John Doe', 'Student ID': 'S001', 'Subject': 'Calculus', 'Class In': '01:00 PM', 'Class Duration': 40, 'What Taught Today': 'Integrals', 'Student Engagement': 'Low', 'Any Work': '', 'Anything you\'d like to share?': 'Student seemed distracted today.' },
            { Date: '2025-07-04', 'Teacher Name': 'Bob Johnson', 'Staff ID': 'T002', 'Program': 'Science', 'Class Room Name': 'Room 102', 'Student Name': 'Jane Smith', 'Student ID': 'S002', 'Subject': 'Physics', 'Class In': '11:00 AM', 'Class Duration': 80, 'What Taught Today': 'Motion', 'Student Engagement': 'High', 'Any Work': 'Problem Set', 'Anything you\'d like to share?': '' },
            { Date: '2025-07-05', 'Teacher Name': 'Charlie Brown', 'Staff ID': 'T003', 'Program': 'History', 'Class Room Name': 'Room 103', 'Student Name': 'Mike Johnson', 'Student ID': 'S003', 'Subject': 'Modern History', 'Class In': '10:30 AM', 'Class Duration': 50, 'What Taught Today': 'Cold War', 'Student Engagement': 'Medium', 'Any Work': 'Essay Outline', 'Anything you\'d like to share?': '' },
            { Date: '2025-07-10', 'Teacher Name': 'Alice Smith', 'Staff ID': 'T001', 'Program': 'Math', 'Class Room Name': 'Room 101', 'Student Name': 'John Doe', 'Student ID': 'S001', 'Subject': 'Algebra', 'Class In': '10:00 AM', 'Class Duration': 60, 'What Taught Today': 'Review', 'Student Engagement': 'High', 'Any Work': 'Test Prep', 'Anything you\'d like to share?': '' },
            { Date: '2025-07-15', 'Teacher Name': 'Bob Johnson', 'Staff ID': 'T002', 'Program': 'Science', 'Class Room Name': 'Room 102', 'Student Name': 'Jane Smith', 'Student ID': 'S002', 'Subject': 'Biology', 'Class In': '11:00 AM', 'Class Duration': 90, 'What Taught Today': 'Ecosystems', 'Student Engagement': 'High', 'Any Work': 'Field Trip Prep', 'Anything you\'d like to share?': '' },
            { Date: '2025-07-20', 'Teacher Name': 'Charlie Brown', 'Staff ID': 'T003', 'Program': 'History', 'Class Room Name': 'Room 103', 'Student Name': 'Mike Johnson', 'Student ID': 'S003', 'Subject': 'Civics', 'Class In': '10:30 AM', 'Class Duration': 100, 'What Taught Today': 'Government Structures', 'Student Engagement': 'High', 'Any Work': 'Debate Prep', 'Anything you\'d like to share?': '' },
        ];

        // This Map used to store salary per hour for each teacher-student pair.
        // As per the latest request, hourly rates are NOT saved persistently.
        // This map is now effectively removed.
        // const teacherStudentHourlyRates = new Map(); 
        // No initialization needed as rates are not saved.

        let currentTeachersSalaryData = []; // This will hold the processed data for the current month, flattened for table rendering
        let teachersOverallAggregatedData = {}; // Stores aggregated data per teacher for modal details

        // Function to navigate to dashboard (placeholder)
        function goToDashboard() {
            console.log("Navigating to Dashboard...");
            // In a real application, you would redirect to your dashboard page.
            // window.location.href = '/dashboard.html';
        }

        /**
         * Displays a custom alert message.
         * @param {string} message The message to display.
         * @param {string} type The type of alert ('success', 'warning', 'error').
         */
        function showAlert(message, type = 'warning') {
            const alertDiv = document.createElement('div');
            alertDiv.style.cssText = `
                position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
                background-color: ${type === 'error' ? '#dc3545' : type === 'success' ? '#28a745' : '#ffc107'};
                color: ${type === 'error' ? 'white' : type === 'success' ? 'white' : '#333'};
                padding: 15px 25px; border-radius: 8px;
                box-shadow: 0 4px 10px rgba(0,0,0,0.2); z-index: 1000;
                font-weight: bold; opacity: 0; transition: opacity 0.5s ease-in-out;
            `;
            alertDiv.textContent = message;
            document.body.appendChild(alertDiv);

            // Fade in
            setTimeout(() => {
                alertDiv.style.opacity = '1';
            }, 10);

            // Fade out and remove
            setTimeout(() => {
                alertDiv.style.opacity = '0';
                alertDiv.addEventListener('transitionend', () => alertDiv.remove());
            }, 3000); // Display for 3 seconds
        }

        /**
         * Loads teacher logbook data from the Google Sheet API or uses sample data,
         * aggregates total hours per teacher-student pair and overall per teacher,
         * and displays it in a dynamic HTML table as a salary sheet.
         */
        async function loadSalaryData() {
            const monthPicker = document.getElementById('monthPicker');
            const selectedMonth = monthPicker.value;
            const loadingIndicator = document.getElementById('loadingIndicator');
            const salarySheetContainer = document.getElementById('salarySheetContainer');
            const reportTitle = document.getElementById('reportTitle');
            const overallTotalHoursDiv = document.getElementById('overallTotalHours');
            const overallHoursValueSpan = document.getElementById('overallHoursValue');


            if (!selectedMonth) {
                showAlert("Please select a month first!");
                return;
            }

            loadingIndicator.style.display = 'block'; // Show loading indicator
            salarySheetContainer.innerHTML = ''; // Clear previous content
            overallTotalHoursDiv.style.display = 'none'; // Hide overall total until data is loaded

            const [year, monthIndex] = selectedMonth.split('-').map(Number); // Parse year and month (month is 1-indexed from input)
            const selectedMonthName = new Date(year, monthIndex - 1, 1).toLocaleString('default', { month: 'long' });

            reportTitle.textContent = `Teacher Salary Sheet - ${selectedMonthName} ${year}`;

            let fetchedData = [];
            try {
                // Fetch data from the Google Apps Script API
                const res = await fetch(GOOGLE_SHEET_WEB_APP_URL);
                if (!res.ok) {
                    throw new Error(`HTTP error! status: ${res.status}`);
                }
                fetchedData = await res.json();
            } catch (error) {
                console.error('Error fetching data from Google Sheet API:', error);
                // Fallback to sample data if fetching fails
                fetchedData = sampleLogBookData;
                showAlert('Failed to load data from Google Sheet. Using sample data.', 'error');
            } finally {
                loadingIndicator.style.display = 'none'; // Hide loading indicator
            }

            // Filter data for the selected month and year
            const filteredData = fetchedData.filter(row => {
                if (typeof row.Date !== 'string' || !row.Date || !row['Staff ID'] || !row['Class Duration'] || !row['Student ID']) {
                    return false; // Skip invalid entries
                }
                const d = new Date(row.Date + 'T00:00:00Z'); // Use 'Z' for UTC to avoid timezone issues
                if (isNaN(d.getTime())) {
                    console.warn("Invalid date string encountered:", row.Date);
                    return false;
                }
                const isMatchingMonth = d.getUTCMonth() === monthIndex - 1;
                const isMatchingYear = d.getUTCFullYear() === year;
                return isMatchingMonth && isMatchingYear;
            });

            // Aggregate total hours and class details per teacher-student pair
            // Also aggregate overall hours per teacher
            teachersOverallAggregatedData = {}; // Reset for current month
            let overallTotalHoursForAllTeachers = 0;

            filteredData.forEach(entry => {
                // Trim whitespace and carriage returns from IDs
                const teacherId = (entry['Staff ID'] || '').trim();
                const teacherName = (entry['Teacher Name'] || '').trim();
                const studentId = (entry['Student ID'] || '').trim();
                const studentName = (entry['Student Name'] || '').trim();
                const classDurationMinutes = parseFloat(entry['Class Duration']) || 0;
                const pairKey = `${teacherId}_${studentId}`;

                // Aggregate for overall teacher data (for modal)
                if (!teachersOverallAggregatedData[teacherId]) {
                    teachersOverallAggregatedData[teacherId] = {
                        teacherName: teacherName,
                        overallTotalMinutes: 0,
                        students: {} // Nested for student-specific data
                    };
                }
                teachersOverallAggregatedData[teacherId].overallTotalMinutes += classDurationMinutes;

                // Aggregate for teacher-student pair data (for main table and modal student sections)
                if (!teachersOverallAggregatedData[teacherId].students[studentId]) {
                    teachersOverallAggregatedData[teacherId].students[studentId] = {
                        studentName: studentName,
                        totalMinutesForStudent: 0,
                        classes: []
                    };
                }
                teachersOverallAggregatedData[teacherId].students[studentId].totalMinutesForStudent += classDurationMinutes;
                teachersOverallAggregatedData[teacherId].students[studentId].classes.push({
                    date: entry.Date,
                    program: entry.Program,
                    classroom: entry['Class Room Name'],
                    subject: entry.Subject,
                    duration: classDurationMinutes
                });
            });

            // Prepare data for the main salary sheet table (flattened with rowspan flags)
            currentTeachersSalaryData = [];
            Object.keys(teachersOverallAggregatedData).sort((a, b) => 
                teachersOverallAggregatedData[a].teacherName.localeCompare(teachersOverallAggregatedData[b].teacherName)
            ).forEach(teacherId => {
                const teacherData = teachersOverallAggregatedData[teacherId];
                const studentKeys = Object.keys(teacherData.students).sort((a, b) => 
                    teacherData.students[a].studentName.localeCompare(teacherData.students[b].studentName)
                );
                const rowspanCount = studentKeys.length;

                studentKeys.forEach((studentId, index) => {
                    const studentData = teacherData.students[studentId];
                    const pairKey = `${teacherId}_${studentId}`;
                    const totalHoursForStudent = (studentData.totalMinutesForStudent / 60);
                    // Hourly rate and total salary are not needed for main table display
                    // const hourlyRate = teacherStudentHourlyRates.has(pairKey) ? teacherStudentHourlyRates.get(pairKey) : 0;
                    // const totalSalary = (totalHoursForStudent * hourlyRate);

                    currentTeachersSalaryData.push({
                        pairKey: pairKey,
                        teacherId: teacherId,
                        teacherName: teacherData.teacherName,
                        studentId: studentId,
                        studentName: studentData.studentName,
                        totalHours: totalHoursForStudent, // Total hours for this specific student
                        // hourlyRate: hourlyRate, // Not needed for main table
                        // totalSalary: totalSalary, // Not needed for main table
                        classes: studentData.classes,
                        isFirstStudentForTeacher: (index === 0), // Flag for rowspan
                        rowspanCount: rowspanCount // How many rows this teacher's name/ID spans
                    });
                    overallTotalHoursForAllTeachers += totalHoursForStudent; // Sum up for grand total
                });
            });

            // Generate table HTML
            let tableHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>Teacher Name</th>
                            <th>Teacher ID</th>
                            <th>Student Name</th>
                            <th>Student ID</th>
                            <th>Total Hours</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            if (currentTeachersSalaryData.length === 0) {
                tableHTML += `<tr><td colspan="5">No salary data found for ${selectedMonthName} ${year}.</td></tr>`;
            } else {
                currentTeachersSalaryData.forEach(entry => {
                    tableHTML += `
                        <tr data-teacher-id="${entry.teacherId}" onclick="openSalaryEntryModal('${entry.teacherId}')" style="cursor: pointer;">
                    `;
                    // Apply rowspan for teacher name and ID
                    if (entry.isFirstStudentForTeacher) {
                        tableHTML += `<td rowspan="${entry.rowspanCount}">${entry.teacherName}</td>`;
                        tableHTML += `<td rowspan="${entry.rowspanCount}">${entry.teacherId}</td>`;
                    }
                    tableHTML += `
                            <td>${entry.studentName}</td>
                            <td>${entry.studentId}</td>
                            <td>${entry.totalHours.toFixed(2)}</td>
                        </tr>
                    `;
                });
            }

            tableHTML += `
                    </tbody>
                </table>
            `;
            salarySheetContainer.innerHTML = tableHTML;

            // Display overall total hours at the bottom of the main page
            overallHoursValueSpan.textContent = overallTotalHoursForAllTeachers.toFixed(2);
            overallTotalHoursDiv.style.display = 'block';
        }

        // Function to open the salary entry modal for a specific teacher
        function openSalaryEntryModal(teacherId) {
            const teacherData = teachersOverallAggregatedData[teacherId];

            if (teacherData) {
                document.getElementById('modalTeacherName').textContent = teacherData.teacherName;
                document.getElementById('modalTeacherId').textContent = teacherId;
                document.getElementById('modalTeacherOverallHours').textContent = (teacherData.overallTotalMinutes / 60).toFixed(2);

                const modalStudentSections = document.getElementById('modalStudentSections');
                modalStudentSections.innerHTML = ''; // Clear previous content

                // Sort students by name for consistent display in modal
                const sortedStudentIds = Object.keys(teacherData.students).sort((a, b) =>
                    teacherData.students[a].studentName.localeCompare(teacherData.students[b].studentName)
                );

                sortedStudentIds.forEach(studentId => {
                    const studentData = teacherData.students[studentId];
                    const pairKey = `${teacherId}_${studentId}`;
                    const totalHoursForStudent = (studentData.totalMinutesForStudent / 60);
                    // Hourly rate is not persistently saved, so default to 0 for manual entry
                    const currentHourlyRate = 0; 
                    const totalAmountForStudent = (totalHoursForStudent * currentHourlyRate);

                    const studentSectionDiv = document.createElement('div');
                    studentSectionDiv.classList.add('student-salary-section');
                    studentSectionDiv.innerHTML = `
                        <h4>Student: ${studentData.studentName} (ID: ${studentId})</h4>
                        <p>Total Hours for this Student: <strong>${totalHoursForStudent.toFixed(2)}</strong></p>
                        <div class="class-list-container">
                            <h5>Classes Taught:</h5>
                            <div id="modalClassList_${pairKey}">
                                <!-- Class details will be populated here -->
                            </div>
                        </div>
                        <label for="hourlyRate_${pairKey}">Hourly Rate (₹):</label>
                        <input type="number" id="hourlyRate_${pairKey}" 
                               placeholder="Enter hourly rate" min="0" step="0.01" 
                               value="${currentHourlyRate.toFixed(2)}" 
                               data-pair-key="${pairKey}" 
                               oninput="updateModalStudentTotal('${pairKey}')">
                        <p>Total Amount for this Student: <strong id="studentTotalAmount_${pairKey}">₹${totalAmountForStudent.toFixed(2)}</strong></p>
                    `;
                    
                    // Append the student section to the modal content first
                    modalStudentSections.appendChild(studentSectionDiv);

                    // Now that the student section is in the DOM, get the class list div
                    const studentClassListDiv = document.getElementById(`modalClassList_${pairKey}`);
                    if (studentClassListDiv && studentData.classes && studentData.classes.length > 0) {
                        studentData.classes.forEach(cls => {
                            const classDiv = document.createElement('div');
                            classDiv.classList.add('class-entry');
                            classDiv.innerHTML = `
                                <strong>Date:</strong> ${cls.date}<br>
                                <strong>Program:</strong> ${cls.program}<br>
                                <strong>Classroom:</strong> ${cls.classroom}<br>
                                <strong>Subject:</strong> ${cls.subject}<br>
                                <strong>Duration:</strong> ${cls.duration} minutes
                            `;
                            studentClassListDiv.appendChild(classDiv);
                        });
                    } else if (studentClassListDiv) {
                        studentClassListDiv.innerHTML = '<p>No class details available for this period.</p>';
                    }
                });

                // Initial calculation of teacher's grand total
                updateTeacherGrandTotalInModal(teacherId);

                document.getElementById('salaryEntryModal').style.display = 'flex'; // Use flex to center

            } else {
                showAlert("Error: Teacher data not found.", 'error');
            }
        }

        // Function to update individual student total and overall teacher total in modal dynamically
        function updateModalStudentTotal(pairKey) {
            const hourlyRateInput = document.getElementById(`hourlyRate_${pairKey}`);
            const newHourlyRate = parseFloat(hourlyRateInput.value);

            // Find the corresponding entry in currentTeachersSalaryData to get totalHours for this student
            const entry = currentTeachersSalaryData.find(e => e.pairKey === pairKey);
            const totalHoursForStudent = entry ? entry.totalHours : 0;

            if (!isNaN(newHourlyRate) && !isNaN(totalHoursForStudent) && newHourlyRate >= 0) {
                const calculatedTotal = (totalHoursForStudent * newHourlyRate).toFixed(2);
                document.getElementById(`studentTotalAmount_${pairKey}`).textContent = `₹${calculatedTotal}`;
            } else {
                document.getElementById(`studentTotalAmount_${pairKey}`).textContent = `₹0.00`;
            }

            // Recalculate teacher's grand total in the modal
            const teacherId = pairKey.split('_')[0];
            updateTeacherGrandTotalInModal(teacherId);
        }

        // Helper function to update the teacher's grand total in the modal
        function updateTeacherGrandTotalInModal(teacherId) {
            let teacherGrandTotal = 0;
            const teacherData = teachersOverallAggregatedData[teacherId];
            if (teacherData) {
                Object.keys(teacherData.students).forEach(studentId => {
                    const studentPairKey = `${teacherId}_${studentId}`;
                    const inputElement = document.getElementById(`hourlyRate_${studentPairKey}`);
                    let studentHourlyRate = parseFloat(inputElement ? inputElement.value : 0);
                    if (isNaN(studentHourlyRate) || studentHourlyRate < 0) studentHourlyRate = 0;

                    const studentEntry = currentTeachersSalaryData.find(e => e.pairKey === studentPairKey);
                    const studentHours = studentEntry ? studentEntry.totalHours : 0;
                    teacherGrandTotal += (studentHours * studentHourlyRate);
                });
            }
            document.getElementById('modalTeacherGrandTotal').textContent = `₹${teacherGrandTotal.toFixed(2)}`;
        }

        // Removed saveAllStudentSalaries function as per request
        /*
        function saveAllStudentSalaries() {
            // ... (previous implementation)
        }
        */

        // Function to close the salary entry modal
        function closeSalaryModal() {
            document.getElementById('salaryEntryModal').style.display = 'none';
            // Remove all oninput listeners from dynamically created inputs
            const modalStudentSections = document.getElementById('modalStudentSections');
            const hourlyRateInputs = modalStudentSections.querySelectorAll('input[type="number"]');
            hourlyRateInputs.forEach(input => {
                input.oninput = null;
            });
        }

        // Function to download the main sheet as PDF
        function downloadPDF() {
            const element = document.getElementById('printArea');
            const salarySheetContainer = document.getElementById('salarySheetContainer');
            const table = salarySheetContainer.querySelector('table');
            const body = document.body;

            if (!table || table.querySelector('tbody').children.length === 0 || table.querySelector('tbody').children[0].textContent.includes('No salary data found')) {
                showAlert('Please load data first before downloading PDF!');
                return;
            }

            // Add a class to adjust styles specifically for PDF export
            body.classList.add('pdf-export-mode');

            // A small delay to ensure styles are applied before rendering
            setTimeout(() => {
                html2pdf().set({
                    margin: 10,
                    filename: 'teacher_salary_sheet.pdf',
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { scale: 2, logging: true, dpi: 192, letterRendering: true },
                    jsPDF: { unit: 'mm', format: 'a4', orientation: 'landscape' }, // Landscape for wider tables
                    pagebreak: { mode: ['avoid-all', 'css', 'legacy'] } // Avoid breaking tables
                }).from(element).save().then(() => {
                    // Remove the class after PDF generation
                    body.classList.remove('pdf-export-mode');
                    showAlert("PDF downloaded successfully!", 'success');
                });
            }, 300); // Increased delay to 300ms
        }

        // Function to copy the modal content to clipboard in email format
        function copyModalContentToClipboard() {
            const teacherName = document.getElementById('modalTeacherName').textContent;
            const teacherId = document.getElementById('modalTeacherId').textContent;
            const overallTeacherHours = document.getElementById('modalTeacherOverallHours').textContent;
            const teacherGrandTotal = document.getElementById('modalTeacherGrandTotal').textContent;

            let emailContent = `Teacher Salary Details - ${teacherName} (ID: ${teacherId})\n`;
            emailContent += `Overall Total Hours for Teacher: ${overallTeacherHours}\n\n`;

            const modalStudentSections = document.getElementById('modalStudentSections');
            const studentSections = modalStudentSections.querySelectorAll('.student-salary-section');

            studentSections.forEach(section => {
                const studentName = section.querySelector('h4').textContent.split(': ')[1].split(' (ID:')[0];
                const studentId = section.querySelector('h4').textContent.split('(ID: ')[1].replace(')', '');
                const totalHoursForStudent = section.querySelector('p strong').textContent;
                const hourlyRateInput = section.querySelector('input[type="number"]');
                const hourlyRate = parseFloat(hourlyRateInput.value).toFixed(2);
                const totalAmountForStudent = section.querySelector(`strong[id^="studentTotalAmount_"]`).textContent;

                emailContent += `--- Student: ${studentName} (ID: ${studentId}) ---\n`;
                emailContent += `Total Hours for this Student: ${totalHoursForStudent}\n`;
                emailContent += `Hourly Rate: ₹${hourlyRate}\n`;
                emailContent += `Total Amount for this Student: ${totalAmountForStudent}\n`;

                const classListDiv = section.querySelector('.class-list-container div');
                const classEntries = classListDiv.querySelectorAll('.class-entry');
                if (classEntries.length > 0) {
                    emailContent += `Classes Taught:\n`;
                    classEntries.forEach(classEntry => {
                        const lines = classEntry.innerHTML.split('<br>').map(line => line.replace(/<\/?strong>/g, '').trim());
                        emailContent += `  - ${lines.join(', ')}\n`;
                    });
                } else {
                    emailContent += `No class details available for this period.\n`;
                }
                emailContent += `\n`;
            });

            emailContent += `--------------------------------------\n`;
            emailContent += `Teacher's Grand Total Amount: ${teacherGrandTotal}\n`;
            emailContent += `--------------------------------------\n`;

            // Create a temporary textarea to hold the content for copying
            const tempTextArea = document.createElement('textarea');
            tempTextArea.value = emailContent;
            document.body.appendChild(tempTextArea);
            tempTextArea.select();
            document.execCommand('copy');
            document.body.removeChild(tempTextArea);

            showAlert('Content copied to clipboard!', 'success');
        }

        // Set current month as default and load data
        document.addEventListener('DOMContentLoaded', () => {
            const today = new Date();
            const year = today.getFullYear();
            const month = (today.getMonth() + 1).toString().padStart(2, '0');
            document.getElementById('monthPicker').value = `${year}-${month}`;
            loadSalaryData(); // Load data on page load for the current month
        });
    </script>
</body>
</html>
