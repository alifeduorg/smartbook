<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teacher Salary Sheet</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- html2pdf.js CDN for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        /* Global styles and body background animation */
        body {
            font-family: 'Inter', sans-serif; /* Using Inter font */
            margin: 0;
            padding: 0;
            /* Adjusted gradient colors for a slightly softer, yet clear look */
            background: linear-gradient(45deg, #b3e0e6, #e6f7ff, #c9e6e0, #f7fbe6);
            background-size: 400% 400%; /* Larger background for smooth animation */
            animation: gradient 15s ease infinite; /* Gradient animation */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh; /* Full viewport height */
            color: #333; /* Default text color */
        }

        /* Keyframe animation for the background gradient */
        @keyframes gradient {
            0% {
                background-position: 0% 50%;
            }
            50% {
                background-position: 100% 50%;
            }
            100% {
                background-position: 0% 50%;
            }
        }

        /* Main container for the salary sheet */
        #printArea {
            background-color: rgba(255, 255, 255, 0.95); /* Slightly transparent white background */
            border-radius: 16px; /* More rounded corners */
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15); /* Enhanced shadow */
            padding: 40px;
            width: 95%; /* Responsive width */
            max-width: 1400px; /* Max width for larger screens */
            text-align: center;
            box-sizing: border-box; /* Include padding in width */
            overflow-x: auto; /* Allow horizontal scrolling for table if needed */
        }

        /* Button styling */
        .dashboard-btn, .action-btn {
            background: linear-gradient(to right, #1a73e8, #4285f4); /* Google Blue gradient */
            color: white;
            padding: 14px 28px;
            margin: 10px 10px;
            border: none;
            border-radius: 10px; /* Rounded buttons */
            cursor: pointer;
            font-size: 17px;
            font-weight: 600;
            transition: all 0.3s ease; /* Smooth transition for hover effects */
            box-shadow: 0 5px 15px rgba(26, 115, 232, 0.2); /* Soft shadow */
            display: inline-flex; /* Align icon and text */
            align-items: center;
            gap: 8px; /* Space between icon and text */
        }

        .dashboard-btn:hover, .action-btn:hover {
            background: linear-gradient(to right, #176ac1, #3c78d8); /* Darker gradient on hover */
            transform: translateY(-2px); /* Slight lift effect */
            box-shadow: 0 8px 20px rgba(26, 115, 232, 0.3); /* Enhanced shadow on hover */
        }

        /* Heading style */
        h2 {
            color: #2c3e50; /* Darker, more professional color */
            margin-bottom: 30px;
            font-size: 3em; /* Larger heading */
            font-weight: 700;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.05); /* Subtle text shadow */
        }

        /* Label for month picker */
        label {
            font-size: 1.2em;
            color: #555;
            margin-right: 15px;
            font-weight: 600;
        }

        /* Month input styling */
        input[type="month"] {
            padding: 12px;
            font-size: 16px;
            margin: 10px 5px;
            border: 1px solid #c0d9e7; /* Softer border color */
            border-radius: 8px;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05); /* Inner shadow */
        }

        input[type="month"]:focus {
            border-color: #1a73e8; /* Match button color on focus */
            box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.25); /* Focus ring */
            outline: none;
        }

        /* Table styling */
        table {
            margin-top: 40px;
            width: 100%;
            border-collapse: separate; /* Use separate for rounded corners on cells */
            border-spacing: 0; /* Remove default spacing */
            font-size: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1); /* Deeper shadow */
            border-radius: 12px; /* Rounded table corners */
            overflow: hidden; /* Ensures rounded corners are visible */
            background-color: white;
        }

        th, td {
            border: 1px solid #e0e0e0; /* Lighter border for cells */
            padding: 12px 10px;
            text-align: center;
            vertical-align: middle; /* Ensures content is vertically centered */
        }

        th {
            background-color: #e6f0ff; /* Light blue header background, slightly adjusted */
            color: #333;
            font-weight: 700;
            text-transform: uppercase;
            position: sticky; /* Make headers sticky for scrolling */
            top: 0;
            z-index: 10;
        }

        /* Striped rows */
        tr:nth-child(even) {
            background-color: #f0f8ff; /* Very light blue for even rows */
        }

        /* Hover effect on table rows */
        tr:hover {
            background-color: #d9edf7; /* Light blue on hover */
            transition: background-color 0.2s ease;
        }

        /* Container for the salary table */
        #salarySheetContainer {
            margin-top: 30px;
            overflow-x: auto; /* Enable horizontal scrolling if table is too wide */
        }

        /* Loading indicator styles */
        .loading-indicator {
            display: none; /* Hidden by default */
            margin-top: 30px;
            font-size: 1.5em;
            color: #1a73e8; /* Match button color */
            font-weight: 600;
        }

        /* Modal Styles */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.6); /* Black w/ opacity */
            backdrop-filter: blur(5px); /* Blurred background */
            -webkit-backdrop-filter: blur(5px); /* Safari support */
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            width: 80%;
            max-width: 900px; /* Adjusted max-width for more content in MD/Principal modal */
            position: relative;
            animation: fadeIn 0.3s ease-out;
            max-height: 80vh; /* Max height for scrollable content */
            overflow-y: auto; /* Enable scrolling for modal content */
            text-align: left;
        }

        .modal-content h3 {
            color: #1a73e8;
            margin-top: 0;
            margin-bottom: 20px;
            font-size: 1.8em;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 10px;
        }

        .modal-content label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .modal-content input[type="number"] {
            width: calc(100% - 24px); /* Full width minus padding */
            padding: 12px;
            margin-bottom: 20px;
            border: 1px solid #c0d9e7;
            border-radius: 8px;
            font-size: 16px;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05);
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        input[type="number"]:focus {
            border-color: #1a73e8;
            box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.25);
            outline: none;
        }

        .modal-content .action-btn {
            width: 100%;
            margin-top: 10px;
        }

        .close-button {
            color: #aaa;
            position: absolute;
            top: 15px;
            right: 25px;
            font-size: 35px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .close-button:hover,
        .close-button:focus {
            color: #333;
            text-decoration: none;
            cursor: pointer;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Styles for PDF generation to ensure full content is captured */
        .pdf-export-mode #printArea {
            width: auto !important; /* Allow printArea to expand */
            max-width: none !important; /* Remove max-width constraint */
            overflow-x: visible !important; /* Ensure content is not clipped */
            padding: 20px !important; /* Reduce padding for PDF */
        }

        .pdf-export-mode #salarySheetContainer {
            overflow-x: visible !important; /* Ensure content is not clipped */
            width: auto !important; /* Allow container to expand */
        }

        .pdf-export-mode table {
            width: max-content !important; /* Make table expand to its full content width */
            min-width: 100% !important; /* Ensure it's at least 100% wide */
        }

        /* Modal specific styles for class list */
        .class-list-container {
            margin-top: 15px;
            border-top: 1px solid #eee;
            padding-top: 15px;
        }

        .class-entry {
            background-color: #f9f9f9;
            border-left: 4px solid #1a73e8;
            padding: 10px 15px;
            margin-bottom: 8px;
            border-radius: 5px;
            font-size: 0.95em;
        }

        .class-entry strong {
            color: #2c3e50;
        }

        /* Styles for individual student sections in modal */
        .student-salary-section {
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            background-color: #fcfcfc;
        }

        .student-salary-section h4 {
            color: #333;
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 1.3em;
        }

        .total-summary {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #1a73e8;
            font-size: 1.5em;
            font-weight: bold;
            color: #2c3e50;
            text-align: right;
        }
        .total-summary.grand-total {
            margin-top: 40px;
            padding-top: 25px;
            border-top: 3px double #1a73e8;
            font-size: 1.8em;
            font-weight: bold;
            color: #0056b3;
            text-align: right;
        }

        /* Removed .teacher-separator styles */

        /* New style for MD/Principal rows in the main table */
        .special-teacher-row {
            background-color: #e0f2f7; /* Light blue background */
            font-weight: bold;
            border-left: 5px solid #007bff; /* Blue left border */
        }
        .special-teacher-row:hover {
            background-color: #cce9f0 !important; /* Darker blue on hover */
        }

        /* Styles for the new teacher list table in MD/Principal modal */
        #otherTeachersSummaryTableContainer {
            margin-top: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            overflow: hidden; /* For rounded corners */
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }
        #otherTeachersSummaryTable {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9em;
        }
        #otherTeachersSummaryTable th,
        #otherTeachersSummaryTable td {
            border: 1px solid #eee;
            padding: 8px;
            text-align: center;
        }
        #otherTeachersSummaryTable th {
            background-color: #f5faff;
            color: #333;
            font-weight: 600;
        }
        #otherTeachersSummaryTable tbody tr:nth-child(even) {
            background-color: #fafcff;
        }
        #otherTeachersSummaryTable tbody tr:hover {
            background-color: #e6f7ff;
        }
        #otherTeachersSummaryTable input[type="number"] {
            width: 80px; /* Smaller input for rate */
            padding: 5px;
            font-size: 0.9em;
            border-radius: 5px;
            border: 1px solid #ccc;
            text-align: center;
        }
    </style>
</head>
<body>

    <div id="printArea">
        <button class="dashboard-btn" onclick="goToDashboard()">⬅ Dashboard</button>
        <h2 id="reportTitle">Teacher Salary Sheet</h2>

        <div class="controls">
            <label>Select Month:
                <input type="month" id="monthPicker" />
            </label>
            <button class="action-btn" onclick="loadSalaryData()">Load Data</button>
            <button class="action-btn" onclick="downloadPDF()">📄 Download PDF</button>
        </div>

        <div id="loadingIndicator" class="loading-indicator">Loading salary data...</div>

        <div id="salarySheetContainer">
            <!-- Salary sheet table will be generated here by JavaScript -->
        </div>
        <div id="overallTotalHours" class="total-summary grand-total" style="display: none;">
            Overall Total Hours for Month: <span id="overallHoursValue">0.00</span>
        </div>
    </div>

    <!-- Salary Entry Modal -->
    <div id="salaryEntryModal" class="modal">
        <div class="modal-content" id="modalPrintArea">
            <span class="close-button" onclick="closeSalaryModal()">&times;</span>
            <h3>Salary Details for <span id="modalTeacherName"></span> (ID: <span id="modalTeacherId"></span>)</h3>
            <!-- This will display overall hours for MD/Principal, individual for others -->
            <p id="modalOverallHoursLabel">Overall Total Hours for Teacher: <strong id="modalTeacherOverallHours"></strong></p>

            <div id="modalContentArea">
                <!-- Content will be dynamically loaded here based on teacher type -->
            </div>

            <div class="total-summary">
                Teacher's Grand Total Amount: <strong id="modalTeacherGrandTotal">₹0.00</strong>
            </div>
            <button class="action-btn" onclick="copyModalContentToClipboard()">📋 Copy to Clipboard</button>
        </div>
    </div>

    <script>
        // Google Apps Script Web App URL - REPLACE THIS WITH YOUR ACTUAL DEPLOYED URL
        // This URL should point to the Apps Script that fetches data from your combined Google Sheet.
        const GOOGLE_SHEET_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwdKvar_uKqoAg1wX60NTThwVHBul14wroJj0QqBQZ3WtQ5zx2hAWXe8hqXqifFI3diSA/exec';

        // Define teacher types for rate calculation and special handling (ensure MD/Principal are defined globally)
        const teacherTypes = {
            'T001': 'Local',
            'T002': 'International',
            'T003': 'Local',
            'AL1002': 'MD', // New type for MD
            'ALI001': 'Principal' // UPDATED ID for Principal
        };

        let currentTeachersSalaryData = []; // This will hold the processed data for the current month, flattened for table rendering
        let teachersOverallAggregatedData = {}; // Stores aggregated data per teacher for modal details
        let overallTotalHoursForAllTeachers = 0; // Global variable for overall total hours

        // Global variables for modal elements, initialized on DOMContentLoaded
        let modalOverallHoursLabel;
        let modalTeacherOverallHoursSpan;
        let modalTeacherNameSpan;
        let modalTeacherIdSpan;
        let modalContentArea;
        let modalTeacherGrandTotalSpan;
        let salaryEntryModalElement; // Reference to the modal itself


        // Function to navigate to dashboard (placeholder)
        function goToDashboard() {
            console.log("Navigating to Dashboard...");
            // In a real application, you would redirect to your dashboard page.
            // window.location.href = '/dashboard.html';
        }

        /**
         * Displays a custom alert message.
         * @param {string} message The message to display.
         * @param {string} type The type of alert ('success', 'warning', 'error').
         */
        function showAlert(message, type = 'warning') {
            const alertDiv = document.createElement('div');
            alertDiv.style.cssText = `
                position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
                background-color: ${type === 'error' ? '#dc3545' : type === 'success' ? '#28a745' : '#ffc107'};
                color: ${type === 'error' ? 'white' : type === 'success' ? 'white' : '#333'};
                padding: 15px 25px; border-radius: 8px;
                box-shadow: 0 4px 10px rgba(0,0,0,0.2); z-index: 1000;
                font-weight: bold; opacity: 0; transition: opacity 0.5s ease-in-out;
            `;
            alertDiv.textContent = message;
            document.body.appendChild(alertDiv);

            // Fade in
            setTimeout(() => {
                alertDiv.style.opacity = '1';
            }, 10);

            // Fade out and remove
            setTimeout(() => {
                alertDiv.style.opacity = '0';
                alertDiv.addEventListener('transitionend', () => alertDiv.remove());
            }, 3000); // Display for 3 seconds
        }

        /**
         * Loads teacher logbook data from the Google Sheet API or uses sample data,
         * aggregates total hours per teacher and displays it in a dynamic HTML table as a salary sheet.
         */
        async function loadSalaryData() {
            const monthPicker = document.getElementById('monthPicker');
            const selectedMonth = monthPicker.value;
            const loadingIndicator = document.getElementById('loadingIndicator');
            const salarySheetContainer = document.getElementById('salarySheetContainer');
            const reportTitle = document.getElementById('reportTitle');
            const overallTotalHoursDiv = document.getElementById('overallTotalHours');
            const overallHoursValueSpan = document.getElementById('overallHoursValue');


            if (!selectedMonth) {
                showAlert("Please select a month first!");
                return;
            }

            loadingIndicator.style.display = 'block'; // Show loading indicator
            salarySheetContainer.innerHTML = ''; // Clear previous content
            overallTotalHoursDiv.style.display = 'none'; // Hide overall total until data is loaded

            const [year, monthIndex] = selectedMonth.split('-').map(Number); // Parse year and month (month is 1-indexed from input)
            const selectedMonthName = new Date(year, monthIndex - 1, 1).toLocaleString('default', { month: 'long' });

            reportTitle.textContent = `Teacher Salary Sheet - ${selectedMonthName} ${year}`;

            let fetchedData = [];
            try {
                // Fetch data from the Google Apps Script API
                const res = await fetch(GOOGLE_SHEET_WEB_APP_URL);
                if (!res.ok) {
                    throw new Error(`HTTP error! status: ${res.status}`);
                }
                fetchedData = await res.json();
            } catch (error) {
                console.error('Error fetching data from Google Sheet API:', error);
                showAlert('Failed to load data from Google Sheet. Please ensure the Google Sheet URL is correct and accessible.', 'error');
            } finally {
                loadingIndicator.style.display = 'none'; // Hide loading indicator
            }

            // Define MD and Principal data to ensure they are always present
            const mdPrincipalData = [
                { Date: `${year}-${monthIndex.toString().padStart(2, '0')}-01`, 'Teacher Name': 'ABHINAV AK', 'Staff ID': 'AL1002', 'Program': 'Management', 'Class Room Name': 'Office', 'Student Name': 'N/A', 'Student ID': 'N/A', 'Subject': 'Admin', 'Class In': '09:00 AM', 'Class Duration': 0, 'What Taught Today': '', 'Student Engagement': '', 'Any Work': '', 'Anything you\'d like to share?': '' },
                { Date: `${year}-${monthIndex.toString().padStart(2, '0')}-01`, 'Teacher Name': 'AFLAH ZAMAN K.', 'Staff ID': 'ALI001', 'Program': 'Management', 'Class Room Name': 'Office', 'Student Name': 'N/A', 'Student ID': 'N/A', 'Subject': 'Admin', 'Class In': '09:00 AM', 'Class Duration': 0, 'What Taught Today': '', 'Student Engagement': '', 'Any Work': '', 'Anything you\'d like to share?': '' },
            ];

            // Combine only MD/Principal data with fetched data.
            // Filter fetchedData to avoid duplicates if Staff ID exists in mdPrincipalData.
            const combinedData = [
                ...mdPrincipalData, // Ensure MD and Principal are always at the top
                ...fetchedData.filter(f => !mdPrincipalData.some(md => md['Staff ID'] === f['Staff ID']))
            ];

            // Filter data for the selected month and year
            const filteredData = combinedData.filter(row => {
                if (typeof row.Date !== 'string' || !row.Date || !row['Staff ID'] || row['Class Duration'] === undefined || row['Student ID'] === undefined) {
                    return false; // Skip invalid entries
                }
                const d = new Date(row.Date + 'T00:00:00Z'); // Use 'Z' for UTC to avoid timezone issues
                if (isNaN(d.getTime())) {
                    console.warn("Invalid date string encountered:", row.Date);
                    return false;
                }
                const isMatchingMonth = d.getUTCMonth() === monthIndex - 1;
                const isMatchingYear = d.getUTCFullYear() === year;
                return isMatchingMonth && isMatchingYear;
            });

            // Aggregate total hours and class details per teacher
            teachersOverallAggregatedData = {}; // Reset for current month

            filteredData.forEach(entry => {
                const teacherId = (entry['Staff ID'] || '').trim();
                const teacherName = (entry['Teacher Name'] || '').trim(); // Trim teacher name
                const studentId = (entry['Student ID'] || '').trim();
                const studentName = (entry['Student Name'] || '').trim(); // Trim student name
                let classDurationMinutes = parseFloat(entry['Class Duration']) || 0;
                const program = (entry['Program'] || '').trim();

                // Special handling for ABHINAV AK (AL1002): exclude 'International School' hours
                if (teacherId === 'AL1002' && program === 'International School') {
                    classDurationMinutes = 0; // Exclude these hours from calculation
                }
                // For Principal (ALI001), all hours are included, no exclusion based on program.

                if (!teachersOverallAggregatedData[teacherId]) {
                    teachersOverallAggregatedData[teacherId] = {
                        teacherName: teacherName,
                        teacherType: teacherTypes[teacherId] || 'Unknown',
                        overallTotalMinutes: 0,
                        students: {} // Keep students for detailed modal view if needed
                    };
                }
                teachersOverallAggregatedData[teacherId].overallTotalMinutes += classDurationMinutes;

                // Store class details under the specific student for the modal breakdown
                if (!teachersOverallAggregatedData[teacherId].students[studentId]) {
                    teachersOverallAggregatedData[teacherId].students[studentId] = {
                        studentName: studentName,
                        totalMinutesForStudent: 0,
                        classes: []
                    };
                }
                teachersOverallAggregatedData[teacherId].students[studentId].totalMinutesForStudent += classDurationMinutes;
                teachersOverallAggregatedData[teacherId].students[studentId].classes.push({
                    date: entry.Date,
                    program: entry.Program,
                    classroom: entry['Class Room Name'],
                    subject: entry.Subject,
                    duration: parseFloat(entry['Class Duration']) || 0
                });
            });

            // Calculate overallTotalHoursForAllTeachers (sum of all *actual* teaching hours, excluding MD/Principal's own recorded hours if they are just placeholders)
            overallTotalHoursForAllTeachers = 0;
            Object.keys(teachersOverallAggregatedData).forEach(teacherId => {
                // Only sum up hours from teachers who are NOT MD or Principal, as their entries in the main table will show the grand total.
                // The MD and Principal's own recorded hours are still used for their *individual* modal calculation if needed,
                // but they don't contribute to this specific 'overallTotalHoursForAllTeachers' sum to avoid confusion.
                if (teacherId !== 'AL1002' && teacherId !== 'ALI001') {
                    overallTotalHoursForAllTeachers += (teachersOverallAggregatedData[teacherId].overallTotalMinutes / 60);
                }
            });

            // Prepare data for the main salary sheet table (one row per teacher)
            currentTeachersSalaryData = [];
            
            // Custom sorting order: AL1002, ALI001, then others alphabetically
            const sortedTeacherIds = Object.keys(teachersOverallAggregatedData).sort((a, b) => {
                if (a === 'AL1002') return -1;
                if (b === 'AL1002') return 1;
                if (a === 'ALI001') return -1;
                if (b === 'ALI001') return 1;
                return teachersOverallAggregatedData[a].teacherName.localeCompare(teachersOverallAggregatedData[b].teacherName);
            });

            sortedTeacherIds.forEach(teacherId => {
                const teacherData = teachersOverallAggregatedData[teacherId];
                let totalHoursForDisplay;
                // Student Name and Student ID columns are no longer needed in the main table
                // let studentNameForDisplay = '';
                // let studentIdForDisplay = '';

                if (teacherId === 'AL1002' || teacherId === 'ALI001') {
                    totalHoursForDisplay = overallTotalHoursForAllTeachers; // MD/Principal show overall total for all other teachers
                } else {
                    totalHoursForDisplay = (teacherData.overallTotalMinutes / 60); // Regular teachers show their own aggregated total
                }

                currentTeachersSalaryData.push({
                    teacherId: teacherId,
                    teacherName: teacherData.teacherName,
                    // studentName: studentNameForDisplay, // Removed
                    // studentId: studentIdForDisplay,     // Removed
                    totalHours: totalHoursForDisplay,
                });
            });

            // Generate table HTML
            // Updated table headers to remove Student Name and Student ID
            let tableHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>Teacher Name</th>
                            <th>Teacher ID</th>
                            <th>Total Hours</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            if (currentTeachersSalaryData.length === 0) {
                // Adjusted colspan for the "No data found" message
                tableHTML += `<tr><td colspan="3">No salary data found for ${selectedMonthName} ${year}.</td></tr>`;
            } else {
                currentTeachersSalaryData.forEach(entry => {
                    const rowClass = (entry.teacherId === 'AL1002' || entry.teacherId === 'ALI001') ? 'special-teacher-row' : '';

                    // Updated table rows to remove Student Name and Student ID columns
                    tableHTML += `
                        <tr data-teacher-id="${entry.teacherId}" class="${rowClass}" style="cursor: pointer;">
                            <td>${entry.teacherName}</td>
                            <td>${entry.teacherId}</td>
                            <td>${entry.totalHours.toFixed(2)}</td>
                        </tr>
                    `;
                });
            }

            tableHTML += `
                    </tbody>
                </table>
            `;
            salarySheetContainer.innerHTML = tableHTML;

            // Display overall total hours at the bottom of the main page
            overallHoursValueSpan.textContent = overallTotalHoursForAllTeachers.toFixed(2);
            overallTotalHoursDiv.style.display = 'block';
        }

        /**
         * Opens the salary entry modal for a specific teacher, showing detailed hours and allowing rate input.
         * @param {string} teacherId The ID of the teacher to display details for.
         */
        function openSalaryEntryModal(teacherId) {
            const teacherData = teachersOverallAggregatedData[teacherId];

            // Defensive check: Ensure all necessary modal elements are initialized
            if (!modalTeacherNameSpan || !modalTeacherIdSpan || !modalOverallHoursLabel || !modalTeacherOverallHoursSpan || !modalContentArea || !modalTeacherGrandTotalSpan || !salaryEntryModalElement) {
                console.error("Error: One or more modal elements are null. Cannot open modal. This indicates a DOM loading issue.");
                showAlert("An internal error occurred. Please try reloading the page.", 'error');
                return; // Exit the function if elements are not ready
            }

            if (teacherData) {
                modalTeacherNameSpan.textContent = teacherData.teacherName;
                modalTeacherIdSpan.textContent = teacherId;

                // Clear previous content
                modalContentArea.innerHTML = '';

                if (teacherId === 'AL1002' || teacherId === 'ALI001') {
                    // For MD and Principal: show overall total hours for all other teachers
                    modalOverallHoursLabel.textContent = `Overall Total Hours for Month (All Teachers): `;
                    modalTeacherOverallHoursSpan.textContent = overallTotalHoursForAllTeachers.toFixed(2);

                    // Create the table for other teachers
                    let otherTeachersTableHTML = `
                        <div id="otherTeachersSummaryTableContainer">
                            <h4>Detailed Breakdown of Other Teachers:</h4>
                            <table id="otherTeachersSummaryTable">
                                <thead>
                                    <tr>
                                        <th>Teacher Name</th>
                                        <th>Teacher ID</th>
                                        <th>Total Hours</th>
                                        <th>Hourly Rate (₹)</th>
                                        <th>Total Amount (₹)</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;

                    // Filter and sort other teachers (excluding MD and Principal)
                    const otherTeacherIds = Object.keys(teachersOverallAggregatedData).filter(id => id !== 'AL1002' && id !== 'ALI001').sort((a, b) =>
                        teachersOverallAggregatedData[a].teacherName.localeCompare(teachersOverallAggregatedData[b].teacherName)
                    );

                    if (otherTeacherIds.length === 0) {
                        otherTeachersTableHTML += `<tr><td colspan="5">No other teacher data available for this month.</td></tr>`;
                    } else {
                        otherTeacherIds.forEach(otherTeacherId => {
                            const otherTeacherData = teachersOverallAggregatedData[otherTeacherId];
                            const otherTotalHours = (otherTeacherData.overallTotalMinutes / 60);
                            const defaultHourlyRate = (teacherTypes[otherTeacherId] === 'International') ? 30 : 20;
                            const initialAmount = (otherTotalHours * defaultHourlyRate);

                            otherTeachersTableHTML += `
                                <tr>
                                    <td>${otherTeacherData.teacherName}</td>
                                    <td>${otherTeacherId}</td>
                                    <td>${otherTotalHours.toFixed(2)}</td>
                                    <td>
                                        <input type="number" id="hourlyRate_${otherTeacherId}"
                                               value="${defaultHourlyRate.toFixed(2)}"
                                               min="0" step="0.01"
                                               data-teacher-id="${otherTeacherId}"
                                               oninput="updateModalSubTableTotal('${otherTeacherId}')">
                                    </td>
                                    <td><span id="subTableTotalAmount_${otherTeacherId}">₹${initialAmount.toFixed(2)}</span></td>
                                </tr>
                            `;
                        });
                    }

                    otherTeachersTableHTML += `
                                </tbody>
                            </table>
                        </div>
                    `;
                    modalContentArea.innerHTML = otherTeachersTableHTML;

                } else {
                    // For regular teachers: show their individual overall hours and breakdown per student
                    modalOverallHoursLabel.textContent = `Overall Total Hours for Teacher: `;
                    modalTeacherOverallHoursSpan.textContent = (teacherData.overallTotalMinutes / 60).toFixed(2);

                    // Iterate through each student for this teacher
                    Object.keys(teacherData.students).forEach(studentId => {
                        const studentData = teacherData.students[studentId];
                        const pairKey = `${teacherId}_${studentId}`; // Unique ID for student-specific elements

                        const studentSectionDiv = document.createElement('div');
                        studentSectionDiv.classList.add('student-salary-section');
                        studentSectionDiv.innerHTML = `
                            <h4>Student: ${studentData.studentName} (ID: ${studentId})</h4>
                            <p>Total Hours for this Student: <strong>${(studentData.totalMinutesForStudent / 60).toFixed(2)}</strong></p>
                            <div class="class-list-container">
                                <h5>Classes Taught to this Student:</h5>
                                <div id="modalClassList_${pairKey}">
                                    <!-- Class details for this specific student will be populated here -->
                                </div>
                            </div>
                            <label for="hourlyRate_${pairKey}">Hourly Rate (₹) for this Student:</label>
                            <input type="number" id="hourlyRate_${pairKey}"
                                   placeholder="Enter hourly rate" min="0" step="0.01"
                                   value="${(teacherTypes[teacherId] === 'International' ? 30 : 20).toFixed(2)}"
                                   data-pair-key="${pairKey}"
                                   oninput="updateModalStudentTotal('${pairKey}')">
                            <p>Total Amount for this Student: <strong id="studentTotalAmount_${pairKey}">₹${((studentData.totalMinutesForStudent / 60) * (teacherTypes[teacherId] === 'International' ? 30 : 20)).toFixed(2)}</strong></p>
                        `;
                        modalContentArea.appendChild(studentSectionDiv);

                        const studentClassListDiv = document.getElementById(`modalClassList_${pairKey}`);
                        if (studentClassListDiv && studentData.classes.length > 0) {
                            studentData.classes.forEach(cls => {
                                const classDiv = document.createElement('div');
                                classDiv.classList.add('class-entry');
                                classDiv.innerHTML = `
                                    <strong>Date:</strong> ${cls.date}<br>
                                    <strong>Program:</strong> ${cls.program}<br>
                                    <strong>Classroom:</strong> ${cls.classroom}<br>
                                    <strong>Subject:</strong> ${cls.subject}<br>
                                    <strong>Duration:</strong> ${cls.duration} minutes
                                `;
                                studentClassListDiv.appendChild(classDiv);
                            });
                        } else if (studentClassListDiv) {
                            studentClassListDiv.innerHTML = '<p>No class details available for this student for this period.</p>';
                        }
                    });
                }

                // Initial calculation of teacher's grand total in the modal
                updateTeacherGrandTotalInModal(teacherId);

                salaryEntryModalElement.style.display = 'flex'; // Use flex to center

            } else {
                showAlert("Error: Teacher data not found.", 'error');
            }
        }

        /**
         * Updates the total amount for an individual student within a regular teacher's modal.
         * This also triggers a recalculation of the teacher's overall grand total in the modal.
         * @param {string} pairKey The combined teacherId_studentId key for the specific student.
         */
        function updateModalStudentTotal(pairKey) {
            const hourlyRateInput = document.getElementById(`hourlyRate_${pairKey}`);
            const newHourlyRate = parseFloat(hourlyRateInput.value);

            const [teacherId, studentId] = pairKey.split('_');
            const studentData = teachersOverallAggregatedData[teacherId].students[studentId];
            const totalHoursForStudent = (studentData.totalMinutesForStudent / 60);

            if (!isNaN(newHourlyRate) && !isNaN(totalHoursForStudent) && newHourlyRate >= 0) {
                const calculatedTotal = (totalHoursForStudent * newHourlyRate).toFixed(2);
                document.getElementById(`studentTotalAmount_${pairKey}`).textContent = `₹${calculatedTotal}`;
            } else {
                document.getElementById(`studentTotalAmount_${pairKey}`).textContent = `₹0.00`;
            }

            // Recalculate the teacher's grand total in the modal
            updateTeacherGrandTotalInModal(teacherId);
        }

        /**
         * Updates individual teacher's total within the MD/Principal modal's sub-table.
         * @param {string} otherTeacherId The ID of the teacher in the sub-table whose total needs to be updated.
         */
        function updateModalSubTableTotal(otherTeacherId) {
            const hourlyRateInput = document.getElementById(`hourlyRate_${otherTeacherId}`);
            const newHourlyRate = parseFloat(hourlyRateInput.value);

            const otherTeacherData = teachersOverallAggregatedData[otherTeacherId];
            const otherTotalHours = (otherTeacherData.overallTotalMinutes / 60);

            if (!isNaN(newHourlyRate) && !isNaN(otherTotalHours) && newHourlyRate >= 0) {
                const calculatedTotal = (otherTotalHours * newHourlyRate).toFixed(2);
                document.getElementById(`subTableTotalAmount_${otherTeacherId}`).textContent = `₹${calculatedTotal}`;
            } else {
                document.getElementById(`subTableTotalAmount_${otherTeacherId}`).textContent = `₹0.00`;
            }

            // Recalculate the MD/Principal's grand total based on all sub-table entries
            const currentModalTeacherId = modalTeacherIdSpan.textContent; // Use global variable
            updateTeacherGrandTotalInModal(currentModalTeacherId);
        }


        /**
         * Helper function to update the teacher's grand total in the modal.
         * This function is called after any rate input changes within the modal.
         * @param {string} teacherId The ID of the teacher currently displayed in the modal.
         */
        function updateTeacherGrandTotalInModal(teacherId) {
            let teacherGrandTotal = 0;
            const teacherType = teacherTypes[teacherId];

            if (teacherType === 'MD' || teacherType === 'Principal') {
                // For MD/Principal, sum totals from the dynamically generated sub-table
                const subTableAmounts = document.querySelectorAll('#otherTeachersSummaryTable [id^="subTableTotalAmount_"]');
                subTableAmounts.forEach(span => {
                    const amountText = span.textContent.replace('₹', '');
                    teacherGrandTotal += parseFloat(amountText) || 0;
                });
            } else {
                // For regular teachers, sum from each student's total amount in their section
                const studentAmountSpans = modalContentArea.querySelectorAll('[id^="studentTotalAmount_"]');
                studentAmountSpans.forEach(span => {
                    const amountText = span.textContent.replace('₹', '');
                    teacherGrandTotal += parseFloat(amountText) || 0;
                });
            }
            modalTeacherGrandTotalSpan.textContent = `₹${teacherGrandTotal.toFixed(2)}`; // Use global variable
        }

        // Function to close the salary entry modal
        function closeSalaryModal() {
            if (salaryEntryModalElement) {
                salaryEntryModalElement.style.display = 'none';
            }
            // Remove all oninput listeners from dynamically created inputs
            if (modalContentArea) {
                const hourlyRateInputs = modalContentArea.querySelectorAll('input[type="number"]'); // Use global variable
                hourlyRateInputs.forEach(input => {
                    input.oninput = null;
                });
            }
        }

        // Function to download the main sheet as PDF
        function downloadPDF() {
            const element = document.getElementById('printArea');
            const salarySheetContainer = document.getElementById('salarySheetContainer');
            const table = salarySheetContainer.querySelector('table');
            const body = document.body;

            if (!table || table.querySelector('tbody').children.length === 0 || table.querySelector('tbody').children[0].textContent.includes('No salary data found')) {
                showAlert('Please load data first before downloading PDF!');
                return;
            }

            // Add a class to adjust styles specifically for PDF export
            body.classList.add('pdf-export-mode');

            // A small delay to ensure styles are applied before rendering
            setTimeout(() => {
                html2pdf().set({
                    margin: 10,
                    filename: 'teacher_salary_sheet.pdf',
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { scale: 2, logging: true, dpi: 192, letterRendering: true },
                    jsPDF: { unit: 'mm', format: 'a4', orientation: 'landscape' }, // Landscape for wider tables
                    pagebreak: { mode: ['avoid-all', 'css', 'legacy'] } // Avoid breaking tables
                }).from(element).save().then(() => {
                    // Remove the class after PDF generation
                    body.classList.remove('pdf-export-mode');
                    showAlert("PDF downloaded successfully!", 'success');
                });
            }, 300); // Increased delay to 300ms
        }

        // Function to copy the modal content to clipboard in email format
        function copyModalContentToClipboard() {
            // Ensure elements are not null before using them
            if (!modalTeacherNameSpan || !modalTeacherIdSpan || !modalOverallHoursLabel || !modalTeacherOverallHoursSpan || !modalTeacherGrandTotalSpan) {
                console.error("Error: One or more modal elements are null. Cannot copy content.");
                showAlert("An internal error occurred. Cannot copy content.", 'error');
                return;
            }

            const teacherName = modalTeacherNameSpan.textContent; // Use global variable
            const teacherId = modalTeacherIdSpan.textContent; // Use global variable
            const overallTeacherHoursDisplay = modalTeacherOverallHoursSpan.textContent; // Use global variable
            const teacherGrandTotal = modalTeacherGrandTotalSpan.textContent; // Use global variable

            let emailContent = `Teacher Salary Details - ${teacherName} (ID: ${teacherId})\n`;
            emailContent += `Overall Total Hours for Teacher: ${overallTeacherHoursDisplay}\n\n`; // Changed label to reflect teacher's overall hours

            const isSpecialTeacher = (teacherId === 'AL1002' || teacherId === 'ALI001');

            if (isSpecialTeacher) {
                emailContent += `Detailed Breakdown of Other Teachers:\n`;
                const otherTeachersTable = document.getElementById('otherTeachersSummaryTable');
                if (otherTeachersTable) {
                    const rows = otherTeachersTable.querySelectorAll('tbody tr');
                    rows.forEach(row => {
                        const cols = row.querySelectorAll('td');
                        if (cols.length === 5) { // Ensure it's a data row for the updated table structure
                            const otherTeacherName = cols[0].textContent;
                            const otherTeacherId = cols[1].textContent;
                            const totalHours = cols[2].textContent;
                            const hourlyRate = cols[3].querySelector('input').value;
                            const totalAmount = cols[4].textContent;
                            emailContent += `--- Teacher: ${otherTeacherName} (ID: ${otherTeacherId}) ---\n`;
                            emailContent += `  Total Hours: ${totalHours}\n`;
                            emailContent += `  Hourly Rate: ₹${hourlyRate}\n`;
                            emailContent += `  Total Amount: ${totalAmount}\n\n`;
                        } else if (cols.length === 1 && cols[0].textContent.includes('No other teacher data')) {
                            emailContent += `  No other teacher data available for this month.\n\n`;
                        }
                    });
                }
            } else {
                // Logic for regular teachers: breakdown per student
                if (modalContentArea) {
                    const studentSections = modalContentArea.querySelectorAll('.student-salary-section');

                    studentSections.forEach(section => {
                        const studentName = section.querySelector('h4').textContent.split(': ')[1].split(' (ID:')[0];
                        const studentId = section.querySelector('h4').textContent.split('(ID: ')[1].replace(')', '');

                        const totalHoursForStudent = section.querySelector('p strong').textContent;
                        const hourlyRateInput = section.querySelector('input[type="number"]');
                        const hourlyRate = parseFloat(hourlyRateInput.value).toFixed(2);
                        const totalAmountForStudent = section.querySelector(`strong[id^="studentTotalAmount_"]`).textContent;

                        emailContent += `--- Student: ${studentName} (ID: ${studentId}) ---\n`;
                        emailContent += `  Total Hours for this Student: ${totalHoursForStudent}\n`;
                        emailContent += `  Hourly Rate for this Student: ₹${hourlyRate}\n`;
                        emailContent += `  Total Amount for this Student: ${totalAmountForStudent}\n`;

                        const classListDiv = section.querySelector('.class-list-container div');
                        const classEntries = classListDiv.querySelectorAll('.class-entry');
                        if (classEntries.length > 0) {
                            emailContent += `  Classes Taught to this Student:\n`;
                            classEntries.forEach(classEntry => {
                                const lines = classEntry.innerHTML.split('<br>').map(line => line.replace(/<\/?strong>/g, '').trim());
                                emailContent += `    - ${lines.join(', ')}\n`;
                            });
                        } else {
                            emailContent += `  No class details available for this student for this period.\n`;
                        }
                        emailContent += `\n`;
                    });
                }
            }

            emailContent += `--------------------------------------\n`;
            emailContent += `Teacher's Grand Total Amount: ${teacherGrandTotal}\n`;
            emailContent += `--------------------------------------\n`;

            // Create a temporary textarea to hold the content for copying
            const tempTextArea = document.createElement('textarea');
            tempTextArea.value = emailContent;
            document.body.appendChild(tempTextArea);
            tempTextArea.select();
            document.execCommand('copy');
            document.body.removeChild(tempTextArea);

            showAlert('Content copied to clipboard!', 'success');
        }

        // Set current month as default and load data
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize global modal elements here
            modalOverallHoursLabel = document.getElementById('modalOverallHoursLabel');
            modalTeacherOverallHoursSpan = document.getElementById('modalTeacherOverallHours');
            modalTeacherNameSpan = document.getElementById('modalTeacherName');
            modalTeacherIdSpan = document.getElementById('modalTeacherId');
            modalContentArea = document.getElementById('modalContentArea');
            modalTeacherGrandTotalSpan = document.getElementById('modalTeacherGrandTotal');
            salaryEntryModalElement = document.getElementById('salaryEntryModal'); // Initialize the modal element itself

            const today = new Date();
            const year = today.getFullYear();
            const month = (today.getMonth() + 1).toString().padStart(2, '0');
            document.getElementById('monthPicker').value = `${year}-${month}`;
            loadSalaryData(); // Load data on page load for the current month

            // Event delegation for table row clicks
            const salarySheetContainer = document.getElementById('salarySheetContainer');
            if (salarySheetContainer) {
                salarySheetContainer.addEventListener('click', (event) => {
                    const clickedRow = event.target.closest('tr[data-teacher-id]');
                    if (clickedRow) {
                        const teacherId = clickedRow.dataset.teacherId;
                        openSalaryEntryModal(teacherId);
                    }
                });
            }
        });
    </script>
</body>
</html>
